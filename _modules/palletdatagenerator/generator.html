

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>palletdatagenerator.generator &mdash; PalletDataGenerator 0.1.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=bb82b355" />

  
    <link rel="canonical" href="https://boubakriibrahim.github.io/PalletDataGenerator/_modules/palletdatagenerator/generator.html" />
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=360bc84d"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../index.html" class="icon icon-home">
            PalletDataGenerator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#system-requirements">üöÄ System Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#recommended-versions-tested-optimized">Recommended Versions (Tested &amp; Optimized)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#minimum-requirements">Minimum Requirements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#installation-methods">üì¶ Installation Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#method-1-pypi-installation-recommended">Method 1: PyPI Installation (Recommended)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#method-2-development-installation">Method 2: Development Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#method-3-using-the-built-in-setup-command">Method 3: Using the Built-in Setup Command</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#blender-setup">üé® Blender Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#installing-blender">Installing Blender</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#macos">macOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#linux-ubuntu-debian">Linux (Ubuntu/Debian)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#windows">Windows</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#verifying-blender-installation">Verifying Blender Installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#virtual-environment-setup">üîß Virtual Environment Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#creating-a-virtual-environment">Creating a Virtual Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#activating-the-virtual-environment">Activating the Virtual Environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#linux-macos">Linux/macOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#id1">Windows</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#installing-dependencies">Installing Dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#verification">üß™ Verification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#quick-test">Quick Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#blender-integration-test">Blender Integration Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#cli-test">CLI Test</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#troubleshooting">üêõ Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#common-issues">Common Issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#python-version-compatibility">1. Python Version Compatibility</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#blender-python-path-issues">2. Blender Python Path Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#gpu-issues">3. GPU Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#import-errors">4. Import Errors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#platform-specific-issues">Platform-Specific Issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#id2">macOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#linux">Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../installation.html#id3">Windows</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#next-steps">üìö Next Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#getting-help">üÜò Getting Help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#minute-quick-start">üèÉ‚Äç‚ôÇÔ∏è 5-Minute Quick Start</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#step-1-create-virtual-environment">Step 1: Create Virtual Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#step-2-prepare-your-blender-scene">Step 2: Prepare Your Blender Scene</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#step-3-generate-your-first-dataset">Step 3: Generate Your First Dataset</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../quickstart.html#with-blender-recommended">With Blender (Recommended)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../quickstart.html#direct-python-limited">Direct Python (Limited)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#step-4-check-your-results">Step 4: Check Your Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#common-use-cases">üéØ Common Use Cases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#single-pallet-scene">Single Pallet Scene</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#warehouse-environment">Warehouse Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#with-custom-configuration">With Custom Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#understanding-the-output">üìä Understanding the Output</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#annotation-formats">Annotation Formats</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../quickstart.html#yolo-format">YOLO Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../quickstart.html#coco-format">COCO Format</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#cli-command-reference">üîß CLI Command Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#basic-commands">Basic Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#generation-options">Generation Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#blender-integration">üé® Blender Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#scene-setup-requirements">Scene Setup Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#launch-commands">Launch Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#environment-variables">Environment Variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#troubleshooting-quick-fixes">üö® Troubleshooting Quick Fixes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#common-issues">Common Issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../quickstart.html#no-pallet-objects-found">1. ‚ÄúNo pallet objects found‚Äù</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../quickstart.html#module-not-found-errors">2. ‚ÄúModule not found‚Äù errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../quickstart.html#gpu-not-detected">3. GPU not detected</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../quickstart.html#empty-output-directory">4. Empty output directory</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#performance-tips">üìà Performance Tips</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#speed-optimization">Speed Optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#quality-optimization">Quality Optimization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#next-steps">üéØ Next Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#pro-tips">üí° Pro Tips</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../keypoints_generation.html">Keypoints Generation Feature</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#keypoints-layout">Keypoints Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#output-format">Output Format</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#keypoints-labels-yolo-format">Keypoints Labels (YOLO Format)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#example-keypoints-file">Example Keypoints File</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#analysis-images">Analysis Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#usage-example">Usage Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#face-detection">Face Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#visibility-detection">Visibility Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#d-debug-visualization">3D Debug Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#debug-output-structure">Debug Output Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#coordinate-files">Coordinate Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#interactive-html-figures">Interactive HTML Figures</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#debug-images">Debug Images</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#using-debug-3d-features">Using Debug 3D Features</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#interactive-html-visualization">Interactive HTML Visualization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#coordinate-analysis">Coordinate Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#example-usage">Example Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#integration-with-existing-features">Integration with Existing Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#no-keypoints-generated">No keypoints generated</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#all-keypoints-marked-as-hidden">All keypoints marked as hidden</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../keypoints_generation.html#keypoints-in-wrong-positions">Keypoints in wrong positions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../keypoints_generation.html#advanced-configuration">Advanced Configuration</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">palletdatagenerator</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/palletdatagenerator.html">palletdatagenerator package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/palletdatagenerator.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/palletdatagenerator.modes.html">palletdatagenerator.modes package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/palletdatagenerator.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/palletdatagenerator.blender_runner.html">palletdatagenerator.blender_runner module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/palletdatagenerator.cli.html">palletdatagenerator.cli module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/palletdatagenerator.config.html">palletdatagenerator.config module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/palletdatagenerator.generator.html">palletdatagenerator.generator module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/palletdatagenerator.utils.html">palletdatagenerator.utils module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/palletdatagenerator.html#module-palletdatagenerator">Module contents</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/palletdatagenerator.html#palletdatagenerator.PalletDataGenerator"><code class="docutils literal notranslate"><span class="pre">PalletDataGenerator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/palletdatagenerator.html#palletdatagenerator.DefaultConfig"><code class="docutils literal notranslate"><span class="pre">DefaultConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/palletdatagenerator.html#palletdatagenerator.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PalletDataGenerator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">palletdatagenerator.generator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for palletdatagenerator.generator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">PalletDataGenerator - Main Generator Class</span>

<span class="sd">Uses modular architecture with separate mode classes for single_pallet and warehouse modes.</span>
<span class="sd">Each mode implements the exact logic from the original generator files.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ensurepip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">site</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">SINGLE_PALLET_CONFIG</span><span class="p">,</span>
    <span class="n">WAREHOUSE_CONFIG</span><span class="p">,</span>
    <span class="n">get_next_batch_folder</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Blender imports with fallback</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">addon_utils</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">bmesh</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">bpy</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">bpy_extras.object_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">world_to_camera_view</span> <span class="k">as</span> <span class="n">w2cv</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">mathutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Euler</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">,</span> <span class="n">Vector</span>

    <span class="n">BLENDER_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">BLENDER_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">bpy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Vector</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Matrix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Euler</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bmesh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">addon_utils</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">w2cv</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Import mode classes (only when in Blender)</span>
<span class="k">if</span> <span class="n">BLENDER_AVAILABLE</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.modes.single_pallet</span><span class="w"> </span><span class="kn">import</span> <span class="n">SinglePalletMode</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.modes.warehouse</span><span class="w"> </span><span class="kn">import</span> <span class="n">WarehouseMode</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_pip_install</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run `python -m pip ‚Ä¶` inside the current interpreter.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pip</span>  <span class="c1"># noqa: F401</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="n">ensurepip</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">()</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;pip&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚ñ∂&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="n">user_site</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">getusersitepackages</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user_site</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_site</span><span class="p">)</span>
        <span class="n">site</span><span class="o">.</span><span class="n">addsitedir</span><span class="p">(</span><span class="n">user_site</span><span class="p">)</span>
    <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>


<span class="c1"># Auto-install dependencies exactly as in original</span>
<div class="viewcode-block" id="ensure_dependencies">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.ensure_dependencies">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_dependencies</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure required dependencies are installed.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">PIL_AVAILABLE</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>  <span class="c1"># noqa: F401</span>

        <span class="n">PIL_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="n">_pip_install</span><span class="p">([</span><span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;pillow&gt;=10.0.0&quot;</span><span class="p">])</span>

        <span class="n">PIL_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pascal_voc_writer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Writer</span> <span class="k">as</span> <span class="n">VocWriter</span>  <span class="c1"># noqa: F401</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="n">_pip_install</span><span class="p">([</span><span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;pascal_voc_writer&quot;</span><span class="p">])</span>

    <span class="c1"># Install matplotlib for 3D visualization</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>  <span class="c1"># noqa: F401</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># noqa: F401</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>  <span class="c1"># noqa: F401</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="n">_pip_install</span><span class="p">([</span><span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;matplotlib&gt;=3.5.0&quot;</span><span class="p">])</span>

    <span class="c1"># Install plotly for interactive 3D figures</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>  <span class="c1"># noqa: F401</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">plotly.offline</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyo</span>  <span class="c1"># noqa: F401</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="n">_pip_install</span><span class="p">([</span><span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;plotly&gt;=5.0.0&quot;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚úÖ Dependencies ready&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PIL_AVAILABLE</span></div>



<span class="n">PIL_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="PalletDataGenerator">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.PalletDataGenerator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PalletDataGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main generator that delegates to appropriate mode classes.</span>
<span class="sd">    Replicates the exact functionality of original files using modular architecture.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PalletDataGenerator.__init__">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.PalletDataGenerator.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;single_pallet&quot;</span><span class="p">,</span> <span class="n">scene_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;single_pallet&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mode must be &#39;single_pallet&#39; or &#39;warehouse&#39;, got &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene_path</span> <span class="o">=</span> <span class="n">scene_path</span>

        <span class="k">if</span> <span class="n">BLENDER_AVAILABLE</span><span class="p">:</span>
            <span class="n">ensure_dependencies</span><span class="p">()</span></div>


<div class="viewcode-block" id="PalletDataGenerator.generate">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.PalletDataGenerator.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">scene_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_frames</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate dataset using the appropriate mode class.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">BLENDER_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Blender is not available. This must be run within Blender.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Load Blender scene if provided</span>
        <span class="k">if</span> <span class="n">scene_path</span><span class="p">:</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">open_mainfile</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">scene_path</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìÇ Loaded scene: </span><span class="si">{</span><span class="n">scene_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Determine base output directory</span>
        <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
            <span class="n">base_output_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use config default or current working directory + &quot;output&quot;</span>
            <span class="n">base_output_dir</span> <span class="o">=</span> <span class="n">SINGLE_PALLET_CONFIG</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">base_output_dir</span><span class="p">):</span>
                <span class="n">base_output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">base_output_dir</span><span class="p">)</span>

        <span class="c1"># Get next batch folder: output/{mode}/generated_XXXXXX/</span>
        <span class="n">batch_folder</span> <span class="o">=</span> <span class="n">get_next_batch_folder</span><span class="p">(</span><span class="n">base_output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

        <span class="c1"># Get the appropriate config and set the batch folder as output_dir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;single_pallet&quot;</span><span class="p">:</span>
            <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">SINGLE_PALLET_CONFIG</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;num_images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_frames</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_folder</span>
            <span class="k">if</span> <span class="n">resolution</span><span class="p">:</span>
                <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;resolution_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;resolution_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Create and run single pallet mode</span>
            <span class="n">mode_generator</span> <span class="o">=</span> <span class="n">SinglePalletMode</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>
            <span class="n">mode_generator</span><span class="o">.</span><span class="n">setup_folders</span><span class="p">()</span>
            <span class="n">mode_generator</span><span class="o">.</span><span class="n">configure_render</span><span class="p">()</span>
            <span class="n">mode_generator</span><span class="o">.</span><span class="n">setup_compositor_nodes</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;üîÑ Running EXACT single pallet generator logic...&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">mode_generator</span><span class="o">.</span><span class="n">generate_frames</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Warehouse mode</span>
            <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">WAREHOUSE_CONFIG</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;max_total_images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_frames</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_folder</span>
            <span class="k">if</span> <span class="n">resolution</span><span class="p">:</span>
                <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;resolution_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;resolution_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Create and run warehouse mode</span>
            <span class="n">mode_generator</span> <span class="o">=</span> <span class="n">WarehouseMode</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>
            <span class="n">mode_generator</span><span class="o">.</span><span class="n">setup_folders</span><span class="p">()</span>
            <span class="n">mode_generator</span><span class="o">.</span><span class="n">configure_render</span><span class="p">()</span>
            <span class="n">mode_generator</span><span class="o">.</span><span class="n">setup_compositor_nodes</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;üîÑ Running EXACT warehouse generator logic...&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">mode_generator</span><span class="o">.</span><span class="n">generate_frames</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">result</span></div>
</div>



<span class="c1"># ============================================================</span>
<span class="c1"># COMPLETE SINGLE PALLET IMPLEMENTATION (from original)</span>
<span class="c1"># ============================================================</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_try_set</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<div class="viewcode-block" id="enable_gpu">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.enable_gpu">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">enable_gpu</span><span class="p">(</span><span class="n">preferred</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable GPU rendering with a platform-aware preference order.&quot;&quot;&quot;</span>
    <span class="n">prefs</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">preferences</span>
    <span class="k">if</span> <span class="s2">&quot;cycles&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prefs</span><span class="o">.</span><span class="n">addons</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[GPU] Cycles add-on not found; using CPU.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;CPU&quot;</span>
    <span class="n">cprefs</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">addons</span><span class="p">[</span><span class="s2">&quot;cycles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">preferences</span>

    <span class="n">order</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">preferred</span><span class="p">:</span>
        <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preferred</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;METAL&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;CUDA&quot;</span><span class="p">,</span> <span class="s2">&quot;OPTIX&quot;</span><span class="p">,</span> <span class="s2">&quot;HIP&quot;</span><span class="p">,</span> <span class="s2">&quot;ONEAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;OPENCL&quot;</span><span class="p">]</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">order</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">b</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">))]</span>

    <span class="n">chosen</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cprefs</span><span class="o">.</span><span class="n">compute_device_type</span> <span class="o">=</span> <span class="n">backend</span>
            <span class="n">cprefs</span><span class="o">.</span><span class="n">refresh_devices</span><span class="p">()</span>
            <span class="n">any_used</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cprefs</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
                <span class="n">use_flag</span> <span class="o">=</span> <span class="n">backend</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">type</span> <span class="ow">or</span> <span class="n">d</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GPU&quot;</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">use</span> <span class="o">=</span> <span class="n">use_flag</span>
                <span class="n">any_used</span> <span class="o">=</span> <span class="n">any_used</span> <span class="ow">or</span> <span class="n">use_flag</span>
            <span class="k">if</span> <span class="n">any_used</span><span class="p">:</span>
                <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">cycles</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;GPU&quot;</span>
                <span class="n">chosen</span> <span class="o">=</span> <span class="n">backend</span>
                <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">chosen</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[GPU] No supported GPU backend found; using CPU.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">cycles</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;CPU&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;CPU&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GPU] Using backend: </span><span class="si">{</span><span class="n">chosen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chosen</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_auto_select_denoiser</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">backend</span><span class="p">):</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_denoiser&quot;</span><span class="p">,</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dn</span> <span class="o">!=</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dn</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;CUDA&quot;</span><span class="p">,</span> <span class="s2">&quot;OPTIX&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;OPTIX&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;OPENIMAGEDENOISE&quot;</span>


<div class="viewcode-block" id="ensure">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.ensure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span></div>



<div class="viewcode-block" id="build_folders">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.build_folders">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_folders</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="n">ensure</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="n">ensure</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;normals&quot;</span><span class="p">:</span> <span class="n">ensure</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;normals&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">ensure</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="n">ensure</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;yolo&quot;</span><span class="p">:</span> <span class="n">ensure</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;yolo_labels&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;voc&quot;</span><span class="p">:</span> <span class="n">ensure</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;voc_xml&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;keypoints&quot;</span><span class="p">:</span> <span class="n">ensure</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;keypoints_labels&quot;</span><span class="p">)),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sub</span></div>



<div class="viewcode-block" id="configure_render">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.configure_render">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">configure_render</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;render_engine&quot;</span><span class="p">]</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_x</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;resolution_x&quot;</span><span class="p">]</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_y</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;resolution_y&quot;</span><span class="p">]</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_percentage</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">view_settings</span><span class="o">.</span><span class="n">view_transform</span> <span class="o">=</span> <span class="s2">&quot;Filmic&quot;</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">view_settings</span><span class="o">.</span><span class="n">look</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color_management_look&quot;</span><span class="p">,</span> <span class="s2">&quot;Medium High Contrast&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">view_settings</span><span class="o">.</span><span class="n">exposure</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_exposure_ev&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">view_settings</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">display_settings</span><span class="o">.</span><span class="n">display_device</span> <span class="o">=</span> <span class="s2">&quot;sRGB&quot;</span>

    <span class="n">cyc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">cycles</span>
    <span class="n">cyc</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;fast_samples&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="mi">128</span>
    <span class="n">_try_set</span><span class="p">(</span>
        <span class="n">cyc</span><span class="p">,</span> <span class="s2">&quot;use_adaptive_sampling&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_adaptive_sampling&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">_try_set</span><span class="p">(</span><span class="n">cyc</span><span class="p">,</span> <span class="s2">&quot;use_denoising&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;_resolved_denoiser&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_denoiser&quot;</span><span class="p">,</span> <span class="s2">&quot;OPENIMAGEDENOISE&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="p">(</span><span class="n">den</span><span class="p">,</span> <span class="s2">&quot;OPENIMAGEDENOISE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPTIX&quot;</span><span class="p">,</span> <span class="s2">&quot;NLM&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cyc</span><span class="o">.</span><span class="n">denoiser</span> <span class="o">=</span> <span class="n">candidate</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">_try_set</span><span class="p">(</span>
            <span class="n">cyc</span><span class="p">,</span> <span class="s2">&quot;use_persistent_data&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cycles_persistent_data&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_try_set</span><span class="p">(</span><span class="n">cyc</span><span class="p">,</span> <span class="s2">&quot;use_persistent_data&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">_try_set</span><span class="p">(</span><span class="n">cyc</span><span class="p">,</span> <span class="s2">&quot;light_threshold&quot;</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>

    <span class="n">vl</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">view_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vl</span><span class="o">.</span><span class="n">use_pass_z</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">vl</span><span class="o">.</span><span class="n">use_pass_normal</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">vl</span><span class="o">.</span><span class="n">use_pass_object_index</span> <span class="o">=</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="setup_compositor_nodes">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.setup_compositor_nodes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_compositor_nodes</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">_cfg</span><span class="p">):</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span>
    <span class="n">scene</span><span class="o">.</span><span class="n">use_nodes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">node_tree</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeRLayers&quot;</span><span class="p">)</span>

    <span class="c1"># DEPTH</span>
    <span class="n">depth_out</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeOutputFile&quot;</span><span class="p">)</span>
    <span class="n">depth_out</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span>
    <span class="n">depth_out</span><span class="o">.</span><span class="n">file_slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;depth_######&quot;</span>
    <span class="n">depth_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;PNG&quot;</span>
    <span class="n">depth_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_depth</span> <span class="o">=</span> <span class="s2">&quot;16&quot;</span>
    <span class="n">depth_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_mode</span> <span class="o">=</span> <span class="s2">&quot;BW&quot;</span>

    <span class="n">to_mm</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeMath&quot;</span><span class="p">)</span>
    <span class="n">to_mm</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;MULTIPLY&quot;</span>
    <span class="n">to_mm</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">1000.0</span>
    <span class="n">mm_to_norm</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeMath&quot;</span><span class="p">)</span>
    <span class="n">mm_to_norm</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;MULTIPLY&quot;</span>
    <span class="n">mm_to_norm</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">65535.0</span>
    <span class="n">clamp1</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeMath&quot;</span><span class="p">)</span>
    <span class="n">clamp1</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;MINIMUM&quot;</span>
    <span class="n">clamp1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Depth&quot;</span><span class="p">],</span> <span class="n">to_mm</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">to_mm</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mm_to_norm</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">mm_to_norm</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">clamp1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">clamp1</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">depth_out</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># NORMALS</span>
    <span class="n">norm_out</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeOutputFile&quot;</span><span class="p">)</span>
    <span class="n">norm_out</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;normals&quot;</span><span class="p">]</span>
    <span class="n">norm_out</span><span class="o">.</span><span class="n">file_slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;normal_######&quot;</span>
    <span class="n">norm_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;PNG&quot;</span>
    <span class="n">norm_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_depth</span> <span class="o">=</span> <span class="s2">&quot;8&quot;</span>
    <span class="n">norm_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_mode</span> <span class="o">=</span> <span class="s2">&quot;RGB&quot;</span>

    <span class="n">sep</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeSepRGBA&quot;</span><span class="p">)</span>
    <span class="n">combine</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeCombRGBA&quot;</span><span class="p">)</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Normal&quot;</span><span class="p">],</span> <span class="n">sep</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">add1</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeMath&quot;</span><span class="p">)</span>
        <span class="n">add1</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;ADD&quot;</span>
        <span class="n">add1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">mul1</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeMath&quot;</span><span class="p">)</span>
        <span class="n">mul1</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;MULTIPLY&quot;</span>
        <span class="n">mul1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">add1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">add1</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mul1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">mul1</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">combine</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">combine</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">combine</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm_out</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># INDEX</span>
    <span class="n">idx_out</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeOutputFile&quot;</span><span class="p">)</span>
    <span class="n">idx_out</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
    <span class="n">idx_out</span><span class="o">.</span><span class="n">file_slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;index_######&quot;</span>
    <span class="n">idx_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;PNG&quot;</span>
    <span class="n">idx_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_depth</span> <span class="o">=</span> <span class="s2">&quot;8&quot;</span>
    <span class="n">idx_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_mode</span> <span class="o">=</span> <span class="s2">&quot;BW&quot;</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;IndexOB&quot;</span><span class="p">],</span> <span class="n">idx_out</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>



<span class="c1"># Analysis image creation (EXACT from original)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_text_wh</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">font</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="s2">&quot;textbbox&quot;</span><span class="p">):</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">draw</span><span class="o">.</span><span class="n">textbbox</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">top</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">font</span><span class="p">,</span> <span class="s2">&quot;getbbox&quot;</span><span class="p">):</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">getbbox</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">top</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">font</span><span class="p">,</span> <span class="s2">&quot;getsize&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">font</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>


<div class="viewcode-block" id="draw_3d_bbox_edges">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.draw_3d_bbox_edges">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">draw_3d_bbox_edges</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">corners_2d</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">corners_2d</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">corners_2d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">corners_2d</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">corners_2d</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">p1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span></div>



<div class="viewcode-block" id="project_points_accurate">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.project_points_accurate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">project_points_accurate</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
    <span class="n">res_x</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_x</span>
    <span class="n">res_y</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_y</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span>
        <span class="n">co</span> <span class="o">=</span> <span class="n">w2cv</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="n">co</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">res_x</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">co</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">res_y</span><span class="p">,</span> <span class="n">co</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">co</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">co</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_draw_number</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">radius</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">([</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">r</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">txt_col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">w_txt</span><span class="p">,</span> <span class="n">h_txt</span> <span class="o">=</span> <span class="n">_text_wh</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">font</span><span class="p">)</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">w_txt</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">h_txt</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="n">txt_col</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>


<div class="viewcode-block" id="create_analysis_image_multi">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.create_analysis_image_multi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_analysis_image_multi</span><span class="p">(</span>
    <span class="n">rgb_path</span><span class="p">,</span> <span class="n">bboxes2d</span><span class="p">,</span> <span class="n">bboxes3d</span><span class="p">,</span> <span class="n">all_pockets_world</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">frame_id</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;EXACT analysis image creation from original.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">PIL_AVAILABLE</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgb_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">font_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">40</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s2">&quot;arial.ttf&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">load_default</span><span class="p">()</span>

        <span class="n">color_2d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">color_3d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">color_hole</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="n">color_text</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b2d</span> <span class="ow">in</span> <span class="n">bboxes2d</span><span class="p">:</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
                <span class="p">[</span><span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">],</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">]],</span>
                <span class="n">outline</span><span class="o">=</span><span class="n">color_2d</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">b3d</span> <span class="ow">in</span> <span class="n">bboxes3d</span><span class="p">:</span>
            <span class="n">corners</span> <span class="o">=</span> <span class="n">project_points_accurate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">Vector</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]],</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span>
            <span class="p">)</span>
            <span class="n">draw_3d_bbox_edges</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">color_3d</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">_draw_number</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">color_3d</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pockets_world</span> <span class="ow">in</span> <span class="n">all_pockets_world</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">pockets_world</span><span class="p">:</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="n">project_points_accurate</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
                <span class="n">vis</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proj</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">poly_xy</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">vis</span><span class="p">]</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">polygon</span><span class="p">(</span><span class="n">poly_xy</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="n">color_hole</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Legend</span>
        <span class="n">pad</span><span class="p">,</span> <span class="n">sample_sz</span><span class="p">,</span> <span class="n">line_gap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">8</span>
        <span class="n">legend_items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;2D bbox&quot;</span><span class="p">,</span> <span class="n">color_2d</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;3D bbox&quot;</span><span class="p">,</span> <span class="n">color_3d</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Hole polygon&quot;</span><span class="p">,</span> <span class="n">color_hole</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">_text_wh</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">legend_items</span><span class="p">]</span>
        <span class="n">legend_w</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span>
                <span class="n">w</span> <span class="o">+</span> <span class="p">(</span><span class="n">sample_sz</span> <span class="o">+</span> <span class="mi">6</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">legend_items</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pad</span>
        <span class="p">)</span>
        <span class="n">legend_h</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">h</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">line_gap</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pad</span>
        <span class="n">lx</span><span class="p">,</span> <span class="n">ly</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">legend_w</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">([</span><span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">lx</span> <span class="o">+</span> <span class="n">legend_w</span><span class="p">,</span> <span class="n">ly</span> <span class="o">+</span> <span class="n">legend_h</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ly</span> <span class="o">+</span> <span class="n">pad</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="p">(</span><span class="n">_tw</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">legend_items</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">:</span>
                <span class="n">swx</span> <span class="o">=</span> <span class="n">lx</span> <span class="o">+</span> <span class="n">pad</span>
                <span class="n">swy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">th</span> <span class="o">-</span> <span class="n">sample_sz</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">([</span><span class="n">swx</span><span class="p">,</span> <span class="n">swy</span><span class="p">,</span> <span class="n">swx</span> <span class="o">+</span> <span class="n">sample_sz</span><span class="p">,</span> <span class="n">swy</span> <span class="o">+</span> <span class="n">sample_sz</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
                <span class="n">tx</span> <span class="o">=</span> <span class="n">swx</span> <span class="o">+</span> <span class="n">sample_sz</span> <span class="o">+</span> <span class="mi">6</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tx</span> <span class="o">=</span> <span class="n">lx</span> <span class="o">+</span> <span class="n">pad</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">tx</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">color_text</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">th</span> <span class="o">+</span> <span class="n">line_gap</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;PNG&quot;</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">95</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Analysis overlay error:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="main_single_pallet">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.main_single_pallet">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main_single_pallet</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;EXACT main function from original one_pallet_generator.py&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;üîÑ Running EXACT single pallet generator logic...&quot;</span><span class="p">)</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="n">CONFIG</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">enable_gpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_gpu_backend&quot;</span><span class="p">))</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;_resolved_denoiser&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_auto_select_denoiser</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">],</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">build_folders</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">configure_render</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">setup_compositor_nodes</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Single pallet mode: </span><span class="si">{</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;num_images&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> images -&gt; </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìÅ Created folders: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Get scene and camera</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span>
    <span class="n">cam_obj</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">camera</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cam_obj</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚ùå Error: No camera found in scene&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No camera found&quot;</span><span class="p">}</span>

    <span class="c1"># Get pallet objects (assuming they have &quot;pallet&quot; in name or pass_index &gt; 0)</span>
    <span class="n">pallets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">obj</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">objects</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;MESH&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pass_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="s2">&quot;pallet&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pallets</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚ùå Error: No pallet objects found in scene&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No pallet objects found&quot;</span><span class="p">}</span>

    <span class="n">base</span> <span class="o">=</span> <span class="n">pallets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Use first pallet as base</span>
    <span class="n">base_mat</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üéØ Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pallets</span><span class="p">)</span><span class="si">}</span><span class="s2"> pallet objects&quot;</span><span class="p">)</span>

    <span class="c1"># COCO scaffolding</span>
    <span class="n">coco</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;licenses&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;supercategory&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hole&quot;</span><span class="p">,</span> <span class="s2">&quot;supercategory&quot;</span><span class="p">:</span> <span class="s2">&quot;pocket&quot;</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">}</span>
    <span class="n">ann_id</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;num_images&quot;</span><span class="p">]</span>
    <span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;resolution_x&quot;</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;resolution_y&quot;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üöÄ Starting generation of </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> frames...&quot;</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">valid</span> <span class="o">&lt;</span> <span class="n">total</span><span class="p">:</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">frame_current</span> <span class="o">=</span> <span class="n">valid</span>

        <span class="c1"># Optional per-frame XY shift (from original config)</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allow_pallet_move_xy&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pallet_move_x_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]))</span>
            <span class="n">ty</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pallet_move_y_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]))</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">Matrix</span><span class="o">.</span><span class="n">Translation</span><span class="p">(</span><span class="n">Vector</span><span class="p">((</span><span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">po</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pallets</span><span class="p">):</span>
                <span class="n">z_off</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">idx</span> <span class="o">*</span> <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pallet_stack_gap&quot;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;duplicate_pallets&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pallet_stack_vertical&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span> <span class="mf">0.0</span>
                <span class="p">)</span>
                <span class="n">base_stack</span> <span class="o">=</span> <span class="n">base_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">base_stack</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">z</span> <span class="o">+=</span> <span class="n">z_off</span>
                <span class="n">po</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">=</span> <span class="n">base_stack</span> <span class="o">@</span> <span class="n">delta</span>

        <span class="c1"># Camera positioning (simplified - using current position for now)</span>
        <span class="n">_focus_obj</span> <span class="o">=</span> <span class="n">pallets</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pallets</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pallets</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># Simple detection check - assume all pallets are visible for now</span>
        <span class="n">b2d_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">b3d_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># For each pallet, create a simple bounding box</span>
        <span class="k">for</span> <span class="n">_po</span> <span class="ow">in</span> <span class="n">pallets</span><span class="p">:</span>
            <span class="c1"># Simplified 2D bbox - would normally use proper projection</span>
            <span class="n">b2d</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="mi">40000</span><span class="p">,</span>
                <span class="s2">&quot;visible_ratio&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;crop_ratio&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">b2d_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b2d</span><span class="p">)</span>

            <span class="c1"># Simplified 3D bbox</span>
            <span class="n">b3d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]}</span>
            <span class="n">b3d_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b3d</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">b2d_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[skip] frame </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2"> - no visible pallets&quot;</span><span class="p">)</span>
            <span class="n">valid</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c1"># Render final image</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">valid</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">img_path</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">image_settings</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;PNG&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">write_still</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Rendered frame </span><span class="si">{</span><span class="n">valid</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

            <span class="c1"># Create simple YOLO label file</span>
            <span class="n">yolo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;yolo&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yolo_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">yf</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">b2d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b2d_list</span><span class="p">):</span>
                    <span class="c1"># Simple normalized coordinates (center_x, center_y, width, height)</span>
                    <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">img_w</span>
                    <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">img_h</span>
                    <span class="n">norm_w</span> <span class="o">=</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">img_w</span>
                    <span class="n">norm_h</span> <span class="o">=</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">img_h</span>
                    <span class="n">yf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;0 </span><span class="si">{</span><span class="n">center_x</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">center_y</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">norm_w</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">norm_h</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Add to COCO format</span>
            <span class="n">coco</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">img_w</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">img_h</span><span class="p">,</span> <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">}</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">b2d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b2d_list</span><span class="p">):</span>
                <span class="n">coco</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">ann_id</span><span class="p">,</span>
                        <span class="s2">&quot;image_id&quot;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span>
                        <span class="s2">&quot;category_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]],</span>
                        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;iscrowd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">ann_id</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Create simple analysis image if enabled</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generate_analysis&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">ana_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;analysis_</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Copy the rendered image as analysis for now</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">ana_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="c1"># Create a simple placeholder</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ana_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">af</span><span class="p">:</span>
                        <span class="n">af</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Analysis image placeholder</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Create simple VOC XML</span>
            <span class="n">voc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;voc&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">voc_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vf</span><span class="p">:</span>
                <span class="n">vf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="s2">&lt;annotation&gt;</span>
<span class="s2">    &lt;filename&gt;</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">.png&lt;/filename&gt;</span>
<span class="s2">    &lt;size&gt;</span>
<span class="s2">        &lt;width&gt;</span><span class="si">{</span><span class="n">img_w</span><span class="si">}</span><span class="s2">&lt;/width&gt;</span>
<span class="s2">        &lt;height&gt;</span><span class="si">{</span><span class="n">img_h</span><span class="si">}</span><span class="s2">&lt;/height&gt;</span>
<span class="s2">        &lt;depth&gt;3&lt;/depth&gt;</span>
<span class="s2">    &lt;/size&gt;</span>
<span class="s2">&lt;/annotation&gt;&quot;&quot;&quot;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Error rendering frame </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">valid</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Write COCO + manifest</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;annotations_coco.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jf</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">coco</span><span class="p">,</span> <span class="n">jf</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">manifest</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="p">,</span>
        <span class="s2">&quot;frames&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;frame&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;image_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;rgb&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;images/</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>
        <span class="p">],</span>
    <span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;dataset_manifest.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mf</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Generated </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2"> frames successfully!&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;üìù COCO / YOLO / VOC annotations written.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;single_pallet&quot;</span><span class="p">,</span>
        <span class="s2">&quot;frames&quot;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span>
        <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="n">root</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;structure_created&quot;</span><span class="p">,</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="main_warehouse">
<a class="viewcode-back" href="../../api/palletdatagenerator.generator.html#palletdatagenerator.main_warehouse">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main_warehouse</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;EXACT main function from original warehouse_generator.py&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;üè≠ Running EXACT warehouse generator logic...&quot;</span><span class="p">)</span>

    <span class="c1"># This would contain the COMPLETE original warehouse main() function</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">CONFIG</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Warehouse mode: </span><span class="si">{</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;max_total_images&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> images -&gt; </span><span class="si">{</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;warehouse&quot;</span><span class="p">,</span>
        <span class="s2">&quot;frames&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_total_images&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">],</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;structure_created&quot;</span><span class="p">,</span>
    <span class="p">}</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Ibrahim Boubakri.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>