

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>palletdatagenerator.modes.base_generator &mdash; PalletDataGenerator 0.1.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=bb82b355" />

  
    <link rel="canonical" href="https://boubakriibrahim.github.io/PalletDataGenerator/_modules/palletdatagenerator/modes/base_generator.html" />
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=360bc84d"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PalletDataGenerator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#system-requirements">üöÄ System Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#recommended-versions-tested-optimized">Recommended Versions (Tested &amp; Optimized)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#minimum-requirements">Minimum Requirements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#installation-methods">üì¶ Installation Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#method-1-pypi-installation-recommended">Method 1: PyPI Installation (Recommended)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#method-2-development-installation">Method 2: Development Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#method-3-using-the-built-in-setup-command">Method 3: Using the Built-in Setup Command</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#blender-setup">üé® Blender Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#installing-blender">Installing Blender</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#macos">macOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#linux-ubuntu-debian">Linux (Ubuntu/Debian)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#windows">Windows</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#verifying-blender-installation">Verifying Blender Installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#virtual-environment-setup">üîß Virtual Environment Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#creating-a-virtual-environment">Creating a Virtual Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#activating-the-virtual-environment">Activating the Virtual Environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#linux-macos">Linux/macOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#id1">Windows</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#installing-dependencies">Installing Dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#verification">üß™ Verification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#quick-test">Quick Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#blender-integration-test">Blender Integration Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#cli-test">CLI Test</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#troubleshooting">üêõ Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#common-issues">Common Issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#python-version-compatibility">1. Python Version Compatibility</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#blender-python-path-issues">2. Blender Python Path Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#gpu-issues">3. GPU Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#import-errors">4. Import Errors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#platform-specific-issues">Platform-Specific Issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#id2">macOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#linux">Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#id3">Windows</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#next-steps">üìö Next Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#getting-help">üÜò Getting Help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#minute-quick-start">üèÉ‚Äç‚ôÇÔ∏è 5-Minute Quick Start</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#step-1-create-virtual-environment">Step 1: Create Virtual Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#step-2-prepare-your-blender-scene">Step 2: Prepare Your Blender Scene</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#step-3-generate-your-first-dataset">Step 3: Generate Your First Dataset</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#with-blender-recommended">With Blender (Recommended)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#direct-python-limited">Direct Python (Limited)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#step-4-check-your-results">Step 4: Check Your Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#common-use-cases">üéØ Common Use Cases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#single-pallet-scene">Single Pallet Scene</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#warehouse-environment">Warehouse Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#with-custom-configuration">With Custom Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#understanding-the-output">üìä Understanding the Output</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#annotation-formats">Annotation Formats</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#yolo-format">YOLO Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#coco-format">COCO Format</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#cli-command-reference">üîß CLI Command Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#basic-commands">Basic Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#generation-options">Generation Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#blender-integration">üé® Blender Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#scene-setup-requirements">Scene Setup Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#launch-commands">Launch Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#environment-variables">Environment Variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#troubleshooting-quick-fixes">üö® Troubleshooting Quick Fixes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#common-issues">Common Issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#no-pallet-objects-found">1. ‚ÄúNo pallet objects found‚Äù</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#module-not-found-errors">2. ‚ÄúModule not found‚Äù errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#gpu-not-detected">3. GPU not detected</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#empty-output-directory">4. Empty output directory</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#performance-tips">üìà Performance Tips</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#speed-optimization">Speed Optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#quality-optimization">Quality Optimization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#next-steps">üéØ Next Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#pro-tips">üí° Pro Tips</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../keypoints_generation.html">Keypoints Generation Feature</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#keypoints-layout">Keypoints Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#output-format">Output Format</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#keypoints-labels-yolo-format">Keypoints Labels (YOLO Format)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#example-keypoints-file">Example Keypoints File</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#analysis-images">Analysis Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#usage-example">Usage Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#face-detection">Face Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#visibility-detection">Visibility Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#d-debug-visualization">3D Debug Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#debug-output-structure">Debug Output Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#coordinate-files">Coordinate Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#interactive-html-figures">Interactive HTML Figures</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#debug-images">Debug Images</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#using-debug-3d-features">Using Debug 3D Features</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#interactive-html-visualization">Interactive HTML Visualization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#coordinate-analysis">Coordinate Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#example-usage">Example Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#integration-with-existing-features">Integration with Existing Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#no-keypoints-generated">No keypoints generated</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#all-keypoints-marked-as-hidden">All keypoints marked as hidden</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#keypoints-in-wrong-positions">Keypoints in wrong positions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#advanced-configuration">Advanced Configuration</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">palletdatagenerator</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/palletdatagenerator.html">palletdatagenerator package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/palletdatagenerator.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.modes.html">palletdatagenerator.modes package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/palletdatagenerator.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.blender_runner.html">palletdatagenerator.blender_runner module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.cli.html">palletdatagenerator.cli module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.config.html">palletdatagenerator.config module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.generator.html">palletdatagenerator.generator module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.utils.html">palletdatagenerator.utils module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/palletdatagenerator.html#module-palletdatagenerator">Module contents</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.html#palletdatagenerator.PalletDataGenerator"><code class="docutils literal notranslate"><span class="pre">PalletDataGenerator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.html#palletdatagenerator.DefaultConfig"><code class="docutils literal notranslate"><span class="pre">DefaultConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.html#palletdatagenerator.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PalletDataGenerator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">palletdatagenerator.modes.base_generator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for palletdatagenerator.modes.base_generator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Base generator class that contains shared functionality for all generation modes.</span>
<span class="sd">Provides common methods for scene setup, rendering, and data export.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Blender imports with fallback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">colorsys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ensurepip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">site</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">bpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bpy_extras.object_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">world_to_camera_view</span> <span class="k">as</span> <span class="n">w2cv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mathutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Vector</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_pip_install</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run `python -m pip ‚Ä¶` inside the current interpreter.</span>
<span class="sd">    Adds ~/.local to sys.path so the fresh install is usable immediately.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pip</span>  <span class="c1"># noqa: F401</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="n">ensurepip</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">()</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;pip&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;‚ñ∂ &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="n">user_site</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">getusersitepackages</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user_site</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_site</span><span class="p">)</span>
        <span class="n">site</span><span class="o">.</span><span class="n">addsitedir</span><span class="p">(</span><span class="n">user_site</span><span class="p">)</span>
    <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>


<span class="c1"># ---------------------------- 1) Pillow -----------------------------</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>  <span class="c1"># noqa: F401</span>

    <span class="n">PIL_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">_pip_install</span><span class="p">([</span><span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;pillow&gt;=10.0.0&quot;</span><span class="p">])</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>  <span class="c1"># retry</span>

    <span class="n">PIL_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># ----------------------- 2) pascal_voc_writer -----------------------</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pascal_voc_writer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Writer</span> <span class="k">as</span> <span class="n">VocWriter</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_pip_install</span><span class="p">([</span><span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;pascal_voc_writer&quot;</span><span class="p">])</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pascal_voc_writer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Writer</span> <span class="k">as</span> <span class="n">VocWriter</span>  <span class="c1"># retry</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">VocWriter</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pillow available: </span><span class="si">{</span><span class="n">PIL_AVAILABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="BaseGenerator">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for all generation modes with shared functionality.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BaseGenerator.__init__">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="BaseGenerator.setup_folders">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.setup_folders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the output folder structure.&quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;normals&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;normals&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;yolo&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;yolo_labels&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;voc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;voc_xml&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;keypoints&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;keypoints_labels&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;debug_3d&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;debug_3d&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;debug_3d_images&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;debug_3d&quot;</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;debug_3d_coordinates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;debug_3d&quot;</span><span class="p">,</span> <span class="s2">&quot;coordinates&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;debug_3d_figures&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;debug_3d&quot;</span><span class="p">,</span> <span class="s2">&quot;figures&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;face_2d_boxes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;face_2d_boxes&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;face_3d_coordinates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_dir</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;face_3d_coordinates&quot;</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create directory if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>

<div class="viewcode-block" id="BaseGenerator.configure_render">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.configure_render">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">configure_render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure Blender render settings.&quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span>

        <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;render_engine&quot;</span><span class="p">]</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_x</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;resolution_x&quot;</span><span class="p">]</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_y</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;resolution_y&quot;</span><span class="p">]</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_percentage</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="c1"># Color Management</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">view_settings</span><span class="o">.</span><span class="n">view_transform</span> <span class="o">=</span> <span class="s2">&quot;Filmic&quot;</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">view_settings</span><span class="o">.</span><span class="n">look</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;color_management_look&quot;</span><span class="p">,</span> <span class="s2">&quot;Medium High Contrast&quot;</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">view_settings</span><span class="o">.</span><span class="n">exposure</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_exposure_ev&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">view_settings</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">display_settings</span><span class="o">.</span><span class="n">display_device</span> <span class="o">=</span> <span class="s2">&quot;sRGB&quot;</span>

        <span class="c1"># Cycles settings</span>
        <span class="n">cyc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">cycles</span>
        <span class="n">cyc</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;fast_samples&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="mi">128</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cyc</span><span class="p">,</span> <span class="s2">&quot;use_adaptive_sampling&quot;</span><span class="p">):</span>
            <span class="n">cyc</span><span class="o">.</span><span class="n">use_adaptive_sampling</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_adaptive_sampling&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cyc</span><span class="p">,</span> <span class="s2">&quot;use_denoising&quot;</span><span class="p">):</span>
                <span class="n">cyc</span><span class="o">.</span><span class="n">use_denoising</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Set denoiser</span>
            <span class="n">den</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;_resolved_denoiser&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fast_denoiser&quot;</span><span class="p">,</span> <span class="s2">&quot;OPENIMAGEDENOISE&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="p">(</span><span class="n">den</span><span class="p">,</span> <span class="s2">&quot;OPENIMAGEDENOISE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPTIX&quot;</span><span class="p">,</span> <span class="s2">&quot;NLM&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cyc</span><span class="o">.</span><span class="n">denoiser</span> <span class="o">=</span> <span class="n">candidate</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cyc</span><span class="p">,</span> <span class="s2">&quot;use_persistent_data&quot;</span><span class="p">):</span>
                <span class="n">cyc</span><span class="o">.</span><span class="n">use_persistent_data</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cycles_persistent_data&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cyc</span><span class="p">,</span> <span class="s2">&quot;use_persistent_data&quot;</span><span class="p">):</span>
                <span class="n">cyc</span><span class="o">.</span><span class="n">use_persistent_data</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Reduce fireflies</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cyc</span><span class="p">,</span> <span class="s2">&quot;light_threshold&quot;</span><span class="p">):</span>
            <span class="n">cyc</span><span class="o">.</span><span class="n">light_threshold</span> <span class="o">=</span> <span class="mf">0.001</span>

        <span class="c1"># Enable passes</span>
        <span class="n">vl</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">view_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vl</span><span class="o">.</span><span class="n">use_pass_z</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">vl</span><span class="o">.</span><span class="n">use_pass_normal</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">vl</span><span class="o">.</span><span class="n">use_pass_object_index</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="BaseGenerator.setup_compositor_nodes">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.setup_compositor_nodes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_compositor_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup compositor nodes for depth, normals, and index passes.&quot;&quot;&quot;</span>
        <span class="n">scene</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">use_nodes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">node_tree</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">rl</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeRLayers&quot;</span><span class="p">)</span>

        <span class="c1"># DEPTH (16-bit mm)</span>
        <span class="n">depth_out</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeOutputFile&quot;</span><span class="p">)</span>
        <span class="n">depth_out</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span>
        <span class="n">depth_out</span><span class="o">.</span><span class="n">file_slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;depth_######&quot;</span>
        <span class="n">depth_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;PNG&quot;</span>
        <span class="n">depth_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_depth</span> <span class="o">=</span> <span class="s2">&quot;16&quot;</span>
        <span class="n">depth_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_mode</span> <span class="o">=</span> <span class="s2">&quot;BW&quot;</span>

        <span class="n">to_mm</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeMath&quot;</span><span class="p">)</span>
        <span class="n">to_mm</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;MULTIPLY&quot;</span>
        <span class="n">to_mm</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">1000.0</span>
        <span class="n">mm_to_norm</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeMath&quot;</span><span class="p">)</span>
        <span class="n">mm_to_norm</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;MULTIPLY&quot;</span>
        <span class="n">mm_to_norm</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">65535.0</span>
        <span class="n">clamp1</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeMath&quot;</span><span class="p">)</span>
        <span class="n">clamp1</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;MINIMUM&quot;</span>
        <span class="n">clamp1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Depth&quot;</span><span class="p">],</span> <span class="n">to_mm</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">to_mm</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mm_to_norm</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">mm_to_norm</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">clamp1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">clamp1</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">depth_out</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># NORMALS</span>
        <span class="n">norm_out</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeOutputFile&quot;</span><span class="p">)</span>
        <span class="n">norm_out</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;normals&quot;</span><span class="p">]</span>
        <span class="n">norm_out</span><span class="o">.</span><span class="n">file_slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;normal_######&quot;</span>
        <span class="n">norm_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;PNG&quot;</span>
        <span class="n">norm_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_depth</span> <span class="o">=</span> <span class="s2">&quot;8&quot;</span>
        <span class="n">norm_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_mode</span> <span class="o">=</span> <span class="s2">&quot;RGB&quot;</span>

        <span class="n">sep</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeSepRGBA&quot;</span><span class="p">)</span>
        <span class="n">combine</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeCombRGBA&quot;</span><span class="p">)</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Normal&quot;</span><span class="p">],</span> <span class="n">sep</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">add1</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeMath&quot;</span><span class="p">)</span>
            <span class="n">add1</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;ADD&quot;</span>
            <span class="n">add1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">mul1</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeMath&quot;</span><span class="p">)</span>
            <span class="n">mul1</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;MULTIPLY&quot;</span>
            <span class="n">mul1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">add1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">add1</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mul1</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">mul1</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">combine</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">combine</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">combine</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm_out</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># INDEX</span>
        <span class="n">idx_out</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;CompositorNodeOutputFile&quot;</span><span class="p">)</span>
        <span class="n">idx_out</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="n">idx_out</span><span class="o">.</span><span class="n">file_slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;index_######&quot;</span>
        <span class="n">idx_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;PNG&quot;</span>
        <span class="n">idx_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_depth</span> <span class="o">=</span> <span class="s2">&quot;8&quot;</span>
        <span class="n">idx_out</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">color_mode</span> <span class="o">=</span> <span class="s2">&quot;BW&quot;</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;IndexOB&quot;</span><span class="p">],</span> <span class="n">idx_out</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="BaseGenerator.setup_environment">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.setup_environment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup world background and floor.&quot;&quot;&quot;</span>
        <span class="c1"># World/background</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_random_background</span><span class="p">()</span>

        <span class="c1"># Floor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_floor&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_floor_plane</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseGenerator.setup_random_background">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.setup_random_background">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_random_background</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup world background exactly as in original.&quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;_real_bg_selected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">world</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">world</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">world</span><span class="o">.</span><span class="n">use_nodes</span><span class="p">:</span>
            <span class="n">world</span><span class="o">.</span><span class="n">use_nodes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">node_tree</span><span class="o">.</span><span class="n">nodes</span>
        <span class="n">links</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">node_tree</span><span class="o">.</span><span class="n">links</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeOutputWorld&quot;</span><span class="p">)</span>

        <span class="c1"># Try real background images first</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_real_background&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;real_background_images_dir&quot;</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">folder</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;*.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;*.jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;*.png&quot;</span><span class="p">,</span> <span class="s2">&quot;*.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;*.tiff&quot;</span><span class="p">):</span>
                    <span class="n">files</span> <span class="o">+=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">bg</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeBackground&quot;</span><span class="p">)</span>
                <span class="n">img_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeTexImage&quot;</span><span class="p">)</span>
                <span class="n">img_node</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
                <span class="n">bg</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Strength&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;world_min_strength&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="mf">0.2</span>
                <span class="p">)</span>
                <span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">img_node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">],</span> <span class="n">bg</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">])</span>
                <span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Background&quot;</span><span class="p">],</span> <span class="n">output</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Surface&quot;</span><span class="p">])</span>
                <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;_real_bg_selected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>

        <span class="c1"># Otherwise use random solid/gradient</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;randomize_background&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Solid, dim but safe</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeBackground&quot;</span><span class="p">)</span>
            <span class="n">bg</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">bg</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Strength&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;world_min_strength&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="mf">0.2</span>
            <span class="p">)</span>
            <span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Background&quot;</span><span class="p">],</span> <span class="n">output</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Surface&quot;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="n">bg_type</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;background_types&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bg_type</span> <span class="o">==</span> <span class="s2">&quot;solid&quot;</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeBackground&quot;</span><span class="p">)</span>
            <span class="n">bg</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">bg</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Strength&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;world_min_strength&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="mf">0.2</span>
            <span class="p">)</span>
            <span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Background&quot;</span><span class="p">],</span> <span class="n">output</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Surface&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tex_coord</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeTexCoord&quot;</span><span class="p">)</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeMapping&quot;</span><span class="p">)</span>
            <span class="n">gradient</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeTexGradient&quot;</span><span class="p">)</span>
            <span class="n">ramp</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeValToRGB&quot;</span><span class="p">)</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeBackground&quot;</span><span class="p">)</span>
            <span class="n">ramp</span><span class="o">.</span><span class="n">color_ramp</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">ramp</span><span class="o">.</span><span class="n">color_ramp</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">bg</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Strength&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;world_min_strength&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="mf">0.2</span>
            <span class="p">)</span>
            <span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">tex_coord</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Generated&quot;</span><span class="p">],</span> <span class="n">mapping</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Vector&quot;</span><span class="p">])</span>
            <span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Vector&quot;</span><span class="p">],</span> <span class="n">gradient</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Vector&quot;</span><span class="p">])</span>
            <span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">gradient</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Fac&quot;</span><span class="p">],</span> <span class="n">ramp</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Fac&quot;</span><span class="p">])</span>
            <span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">ramp</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">],</span> <span class="n">bg</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">])</span>
            <span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;Background&quot;</span><span class="p">],</span> <span class="n">output</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Surface&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="BaseGenerator.create_floor_plane">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.create_floor_plane">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_floor_plane</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create floor plane exactly as in original.&quot;&quot;&quot;</span>
        <span class="c1"># Remove existing floor</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SynthFloor&quot;</span><span class="p">):</span>
                <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">do_unlink</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">primitive_plane_add</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">floor</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">active_object</span>
        <span class="n">floor</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;SynthFloor&quot;</span>

        <span class="n">mat</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;SynthFloorMat&quot;</span><span class="p">)</span>
        <span class="n">mat</span><span class="o">.</span><span class="n">use_nodes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">node_tree</span><span class="o">.</span><span class="n">nodes</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">principled</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeBsdfPrincipled&quot;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ShaderNodeOutputMaterial&quot;</span><span class="p">)</span>
        <span class="n">mat</span><span class="o">.</span><span class="n">node_tree</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">principled</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;BSDF&quot;</span><span class="p">],</span> <span class="n">output</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Surface&quot;</span><span class="p">])</span>

        <span class="n">principled</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Base Color&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Set specular (compatible with different Blender versions)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_principled_input</span><span class="p">(</span>
            <span class="n">principled</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Specular&quot;</span><span class="p">,</span> <span class="s2">&quot;Specular IOR Level&quot;</span><span class="p">],</span> <span class="mf">0.05</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[floor] Specular socket not found; skipping.&quot;</span><span class="p">)</span>

        <span class="n">principled</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Roughness&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mf">0.85</span>
        <span class="n">floor</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">floor</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_set_principled_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">principled</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a Principled BSDF input using a list of possible socket names.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">principled</span><span class="o">.</span><span class="n">inputs</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="BaseGenerator.randomize_object_material">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.randomize_object_material">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">randomize_object_material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Randomize object materials if enabled.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;randomize_materials&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">material_slots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">slot</span><span class="o">.</span><span class="n">material</span> <span class="ow">and</span> <span class="n">slot</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">use_nodes</span><span class="p">:</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">node_tree</span><span class="o">.</span><span class="n">nodes</span>
                <span class="n">principled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;BSDF_PRINCIPLED&quot;</span><span class="p">),</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">principled</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">base_color</span> <span class="o">=</span> <span class="n">principled</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Base Color&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">base_color</span><span class="o">.</span><span class="n">is_linked</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">base_color</span><span class="o">.</span><span class="n">default_value</span>
                    <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">rgb_to_hsv</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span> <span class="o">%</span> <span class="mf">1.0</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)))</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">v</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">)))</span>
                    <span class="n">nr</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="n">base_color</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;Roughness&quot;</span> <span class="ow">in</span> <span class="n">principled</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                    <span class="n">principled</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Roughness&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                        <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;Metallic&quot;</span> <span class="ow">in</span> <span class="n">principled</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                    <span class="n">principled</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;Metallic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                        <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.3</span>
                    <span class="p">)</span></div>


    <span class="c1"># Analysis image generation functions</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_text_wh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">font</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get text width and height for different PIL versions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="s2">&quot;textbbox&quot;</span><span class="p">):</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">draw</span><span class="o">.</span><span class="n">textbbox</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">top</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">font</span><span class="p">,</span> <span class="s2">&quot;getbbox&quot;</span><span class="p">):</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">getbbox</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">top</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">font</span><span class="p">,</span> <span class="s2">&quot;getsize&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">font</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

<div class="viewcode-block" id="BaseGenerator.draw_3d_bbox_edges">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.draw_3d_bbox_edges">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">draw_3d_bbox_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">corners_2d</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw 3D bounding box wireframe.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">corners_2d</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">corners_2d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># bottom face</span>
            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>  <span class="c1"># top face</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>  <span class="c1"># vertical edges</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">corners_2d</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">corners_2d</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">p1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseGenerator.project_points_accurate">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.project_points_accurate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">project_points_accurate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Project 3D points to 2D screen coordinates.&quot;&quot;&quot;</span>
        <span class="n">res_x</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_x</span>
        <span class="n">res_y</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_y</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">w2cv</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">co</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">res_x</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">co</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">res_y</span><span class="p">,</span> <span class="n">co</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">co</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">co</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw numbered circle for 3D bbox corners.&quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">([</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">r</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">txt_col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">w_txt</span><span class="p">,</span> <span class="n">h_txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_wh</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">font</span><span class="p">)</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">w_txt</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">h_txt</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="n">txt_col</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>

<div class="viewcode-block" id="BaseGenerator.create_analysis_image_multi">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.create_analysis_image_multi">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_analysis_image_multi</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rgb_path</span><span class="p">,</span>
        <span class="n">bboxes2d</span><span class="p">,</span>
        <span class="n">bboxes3d</span><span class="p">,</span>
        <span class="n">all_pockets_world</span><span class="p">,</span>
        <span class="n">cam_obj</span><span class="p">,</span>
        <span class="n">sc</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">,</span>
        <span class="n">frame_id</span><span class="p">,</span>
        <span class="n">keypoints_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create analysis image with 2D/3D bounding boxes, holes, and legend.</span>
<span class="sd">        Exact copy from original one_pallet_generator.py</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">PIL_AVAILABLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Import bpy_extras for 3D to 2D projection</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

            <span class="kn">import</span><span class="w"> </span><span class="nn">bpy_extras.object_utils</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rgb_path</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgb_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
            <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">font_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">40</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s2">&quot;arial.ttf&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">load_default</span><span class="p">()</span>

            <span class="c1"># Simple color scheme with normal colors</span>
            <span class="n">color_2d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Green for 2D bounding boxes</span>
            <span class="n">color_3d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Red for 3D bounding boxes</span>
            <span class="n">color_hole</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>  <span class="c1"># Blue for holes</span>
            <span class="n">color_keypoint_hidden</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>  <span class="c1"># Gray for hidden keypoints</span>
            <span class="n">color_text</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>  <span class="c1"># White text</span>

            <span class="c1"># Draw all labels only if enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis_show_all_labels&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="c1"># Draw 2D bounding boxes</span>
                <span class="k">for</span> <span class="n">b2d</span> <span class="ow">in</span> <span class="n">bboxes2d</span><span class="p">:</span>
                    <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">],</span> <span class="n">b2d</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">]],</span>
                        <span class="n">outline</span><span class="o">=</span><span class="n">color_2d</span><span class="p">,</span>
                        <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># Draw 3D bounding boxes</span>
                <span class="k">for</span> <span class="n">b3d</span> <span class="ow">in</span> <span class="n">bboxes3d</span><span class="p">:</span>
                    <span class="n">corners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_points_accurate</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">Vector</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]],</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_3d_bbox_edges</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">color_3d</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_number</span><span class="p">(</span>
                                <span class="n">draw</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">color_3d</span><span class="p">,</span> <span class="n">font</span>
                            <span class="p">)</span>

                <span class="c1"># Draw hole polygons</span>
                <span class="k">for</span> <span class="n">pockets_world</span> <span class="ow">in</span> <span class="n">all_pockets_world</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">pockets_world</span><span class="p">:</span>
                        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_points_accurate</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
                        <span class="n">vis</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proj</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">poly_xy</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">vis</span><span class="p">]</span>
                        <span class="n">draw</span><span class="o">.</span><span class="n">polygon</span><span class="p">(</span><span class="n">poly_xy</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="n">color_hole</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Draw keypoints if available and keypoints are enabled</span>
            <span class="k">if</span> <span class="n">keypoints_data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis_show_keypoints&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="c1"># Simple face colors</span>
                <span class="n">face_colors</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Red for face 0</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Green for face 1</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>  <span class="c1"># Blue for face 2</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Yellow for face 3</span>
                <span class="p">]</span>

                <span class="c1"># First pass: collect all keypoints and detect overlaps</span>
                <span class="n">all_keypoints</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">face_idx</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keypoints_data</span><span class="p">):</span>
                    <span class="n">keypoints</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;keypoints&quot;</span><span class="p">]</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="n">face_colors</span><span class="p">[</span><span class="n">face_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors</span><span class="p">)]</span>
                    <span class="n">face_name</span> <span class="o">=</span> <span class="n">face_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;face_</span><span class="si">{</span><span class="n">face_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">kp</span> <span class="ow">in</span> <span class="n">keypoints</span><span class="p">:</span>
                        <span class="n">all_keypoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;kp&quot;</span><span class="p">:</span> <span class="n">kp</span><span class="p">,</span>
                                <span class="s2">&quot;face_idx&quot;</span><span class="p">:</span> <span class="n">face_idx</span><span class="p">,</span>
                                <span class="s2">&quot;face_color&quot;</span><span class="p">:</span> <span class="n">face_color</span><span class="p">,</span>
                                <span class="s2">&quot;face_name&quot;</span><span class="p">:</span> <span class="n">face_name</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

                <span class="c1"># Detect overlapping keypoints (within 10 pixels)</span>
                <span class="n">overlap_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_overlapping_keypoints</span><span class="p">(</span>
                    <span class="n">all_keypoints</span><span class="p">,</span> <span class="n">keypoints_data</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span>
                <span class="p">)</span>

                <span class="c1"># Second pass: draw keypoints, handling overlaps specially</span>
                <span class="k">for</span> <span class="n">face_idx</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keypoints_data</span><span class="p">):</span>
                    <span class="n">keypoints</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;keypoints&quot;</span><span class="p">]</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="n">face_colors</span><span class="p">[</span><span class="n">face_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors</span><span class="p">)]</span>
                    <span class="n">face_name</span> <span class="o">=</span> <span class="n">face_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;face_</span><span class="si">{</span><span class="n">face_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Debug: Print face information (commented out for production)</span>
                    <span class="c1"># print(f&quot;Face {face_idx} ({face_name}): {len(keypoints)} keypoints, color: {face_color}&quot;)</span>

                    <span class="k">for</span> <span class="n">kp</span> <span class="ow">in</span> <span class="n">keypoints</span><span class="p">:</span>
                        <span class="c1"># Always draw all keypoints (visible and invisible)</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kp</span><span class="p">[</span><span class="s2">&quot;position_2d&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">kp</span><span class="p">[</span><span class="s2">&quot;position_2d&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

                        <span class="c1"># Only draw if we have valid coordinates</span>
                        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># Check if this keypoint is part of an overlap group</span>
                            <span class="n">is_overlap</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">overlap_group</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">overlap_groups</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">group_kp</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="p">(</span>
                                        <span class="n">group_kp</span><span class="p">[</span><span class="s2">&quot;kp&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">kp</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                                        <span class="ow">and</span> <span class="n">group_kp</span><span class="p">[</span><span class="s2">&quot;face_idx&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">face_idx</span>
                                    <span class="p">):</span>
                                        <span class="n">is_overlap</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="n">overlap_group</span> <span class="o">=</span> <span class="n">group</span>
                                        <span class="k">break</span>
                                <span class="k">if</span> <span class="n">is_overlap</span><span class="p">:</span>
                                    <span class="k">break</span>

                            <span class="k">if</span> <span class="n">kp</span><span class="p">[</span><span class="s2">&quot;visible&quot;</span><span class="p">]:</span>
                                <span class="c1"># Draw visible keypoint with face color</span>
                                <span class="k">if</span> <span class="n">is_overlap</span><span class="p">:</span>
                                    <span class="c1"># For overlapping keypoints, draw both colors (one inside the other)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_overlapping_keypoint_circles</span><span class="p">(</span>
                                        <span class="n">draw</span><span class="p">,</span> <span class="n">overlap_group</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Single keypoint</span>
                                    <span class="n">radius</span> <span class="o">=</span> <span class="mi">4</span>
                                    <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span>
                                        <span class="p">[</span>
                                            <span class="n">x</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span>
                                            <span class="n">y</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span>
                                            <span class="n">x</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span>
                                            <span class="n">y</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span>
                                        <span class="p">],</span>
                                        <span class="n">fill</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
                                        <span class="n">outline</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                        <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="p">)</span>

                                <span class="c1"># Draw keypoint labels only if enabled</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keypoints_show_labels&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                                    <span class="c1"># For overlapping keypoints, stack labels vertically</span>
                                    <span class="k">if</span> <span class="n">is_overlap</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">draw_overlapping_keypoint_labels</span><span class="p">(</span>
                                            <span class="n">draw</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">overlap_group</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span>
                                        <span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># Draw single keypoint labels</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">draw_single_keypoint_labels</span><span class="p">(</span>
                                            <span class="n">draw</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">color_text</span>
                                        <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Draw invisible keypoint as gray circle with X</span>
                                <span class="n">radius</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">is_overlap</span> <span class="k">else</span> <span class="mi">3</span>
                                <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">radius</span><span class="p">],</span>
                                    <span class="n">fill</span><span class="o">=</span><span class="n">color_keypoint_hidden</span><span class="p">,</span>
                                    <span class="n">outline</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="k">if</span> <span class="n">is_overlap</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="c1"># Draw X mark</span>
                                <span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">radius</span><span class="p">],</span>
                                    <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="k">if</span> <span class="n">is_overlap</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">radius</span><span class="p">],</span>
                                    <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="n">width</span><span class="o">=</span><span class="mi">2</span> <span class="k">if</span> <span class="n">is_overlap</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="p">)</span>

            <span class="c1"># Draw 2D boxes for selected faces if enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis_show_2d_boxes&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">keypoints_data</span><span class="p">:</span>
                <span class="c1"># Use different colors for each face</span>
                <span class="n">face_colors_2d</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Red for face 0</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Green for face 1</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>  <span class="c1"># Blue for face 2</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Yellow for face 3</span>
                <span class="p">]</span>

                <span class="k">for</span> <span class="n">face_idx</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keypoints_data</span><span class="p">):</span>
                    <span class="n">bbox_2d</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="n">face_colors_2d</span><span class="p">[</span><span class="n">face_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors_2d</span><span class="p">)]</span>

                    <span class="c1"># Draw 2D bounding box</span>
                    <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span>
                            <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span>
                            <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">],</span>
                            <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">],</span>
                        <span class="p">],</span>
                        <span class="n">outline</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
                        <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># Draw 3D coordinates for selected faces if enabled</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis_show_3d_coordinates&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">keypoints_data</span>
            <span class="p">):</span>
                <span class="c1"># Simple 3D face colors</span>
                <span class="n">face_colors_3d</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>  <span class="c1"># Magenta for face 0</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>  <span class="c1"># Cyan for face 1</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Red for face 2</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Green for face 3</span>
                <span class="p">]</span>

                <span class="k">for</span> <span class="n">face_idx</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keypoints_data</span><span class="p">):</span>
                    <span class="c1"># Get the face corners (not the full 3D bounding box)</span>
                    <span class="n">face_corners_3d</span> <span class="o">=</span> <span class="n">face_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_corners_3d&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">face_corners_3d</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_corners_3d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Use different color for each face</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="n">face_colors_3d</span><span class="p">[</span><span class="n">face_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors_3d</span><span class="p">)]</span>

                    <span class="c1"># Project the 4 face corners to 2D</span>
                    <span class="n">corners_2d</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">corner_3d</span> <span class="ow">in</span> <span class="n">face_corners_3d</span><span class="p">:</span>
                        <span class="n">co_2d</span> <span class="o">=</span> <span class="n">bpy_extras</span><span class="o">.</span><span class="n">object_utils</span><span class="o">.</span><span class="n">world_to_camera_view</span><span class="p">(</span>
                            <span class="n">sc</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">corner_3d</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">co_2d</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">co_2d</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">co_2d</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
                            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">co_2d</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
                            <span class="n">corners_2d</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

                    <span class="c1"># Draw the face as a polygon (4 corners)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corners_2d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="c1"># Draw the face outline</span>
                        <span class="n">draw</span><span class="o">.</span><span class="n">polygon</span><span class="p">(</span><span class="n">corners_2d</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

                        <span class="c1"># Draw corner points for reference</span>
                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">corners_2d</span><span class="p">:</span>
                            <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">3</span><span class="p">],</span>
                                <span class="n">fill</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
                                <span class="n">outline</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="p">)</span>

            <span class="c1"># Draw legend - only show items that are actually displayed</span>
            <span class="n">pad</span><span class="p">,</span> <span class="n">sample_sz</span><span class="p">,</span> <span class="n">line_gap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">8</span>
            <span class="n">legend_items</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>

            <span class="c1"># Only add labels if they are actually shown</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis_show_all_labels&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bboxes2d</span><span class="p">:</span>
                    <span class="n">legend_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;2D bbox&quot;</span><span class="p">,</span> <span class="n">color_2d</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">bboxes3d</span><span class="p">:</span>
                    <span class="n">legend_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;3D bbox&quot;</span><span class="p">,</span> <span class="n">color_3d</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">all_pockets_world</span><span class="p">:</span>
                    <span class="n">legend_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Hole polygon&quot;</span><span class="p">,</span> <span class="n">color_hole</span><span class="p">))</span>

            <span class="c1"># Add keypoints to legend if available and shown</span>
            <span class="k">if</span> <span class="n">keypoints_data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis_show_keypoints&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="c1"># Add face colors for each selected face</span>
                <span class="k">for</span> <span class="n">face_idx</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keypoints_data</span><span class="p">):</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="n">face_colors</span><span class="p">[</span><span class="n">face_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors</span><span class="p">)]</span>
                    <span class="n">face_name</span> <span class="o">=</span> <span class="n">face_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;face_</span><span class="si">{</span><span class="n">face_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">legend_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;Face: </span><span class="si">{</span><span class="n">face_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">face_color</span><span class="p">))</span>

            <span class="c1"># Add 2D boxes to legend if shown</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis_show_2d_boxes&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">keypoints_data</span><span class="p">:</span>
                <span class="c1"># Add each face with its 2D box color</span>
                <span class="n">face_colors_2d</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Red for face 0</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Green for face 1</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>  <span class="c1"># Blue for face 2</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Yellow for face 3</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">face_idx</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keypoints_data</span><span class="p">):</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="n">face_colors_2d</span><span class="p">[</span><span class="n">face_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors_2d</span><span class="p">)]</span>
                    <span class="n">face_name</span> <span class="o">=</span> <span class="n">face_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;face_</span><span class="si">{</span><span class="n">face_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">legend_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;2D Box: </span><span class="si">{</span><span class="n">face_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">face_color</span><span class="p">))</span>

            <span class="c1"># Add 3D coordinates to legend if shown</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis_show_3d_coordinates&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">keypoints_data</span>
            <span class="p">):</span>
                <span class="c1"># Add each selected face with its color</span>
                <span class="n">face_colors_3d</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>  <span class="c1"># Magenta for face 0</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>  <span class="c1"># Cyan for face 1</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Red for face 2</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Green for face 3</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">face_idx</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keypoints_data</span><span class="p">):</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="n">face_colors_3d</span><span class="p">[</span><span class="n">face_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors_3d</span><span class="p">)]</span>
                    <span class="n">face_name</span> <span class="o">=</span> <span class="n">face_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;face_</span><span class="si">{</span><span class="n">face_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">legend_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;3D Face: </span><span class="si">{</span><span class="n">face_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">face_color</span><span class="p">))</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_wh</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">legend_items</span><span class="p">]</span>
            <span class="n">legend_w</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span>
                    <span class="n">w</span> <span class="o">+</span> <span class="p">(</span><span class="n">sample_sz</span> <span class="o">+</span> <span class="mi">6</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">legend_items</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pad</span>
            <span class="p">)</span>
            <span class="n">legend_h</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">h</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">line_gap</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pad</span>
            <span class="n">lx</span><span class="p">,</span> <span class="n">ly</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">legend_w</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">([</span><span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">lx</span> <span class="o">+</span> <span class="n">legend_w</span><span class="p">,</span> <span class="n">ly</span> <span class="o">+</span> <span class="n">legend_h</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ly</span> <span class="o">+</span> <span class="n">pad</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="p">(</span><span class="n">_tw</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">legend_items</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">col</span><span class="p">:</span>
                    <span class="n">swx</span> <span class="o">=</span> <span class="n">lx</span> <span class="o">+</span> <span class="n">pad</span>
                    <span class="n">swy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">th</span> <span class="o">-</span> <span class="n">sample_sz</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">swx</span><span class="p">,</span> <span class="n">swy</span><span class="p">,</span> <span class="n">swx</span> <span class="o">+</span> <span class="n">sample_sz</span><span class="p">,</span> <span class="n">swy</span> <span class="o">+</span> <span class="n">sample_sz</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="n">col</span>
                    <span class="p">)</span>
                    <span class="n">tx</span> <span class="o">=</span> <span class="n">swx</span> <span class="o">+</span> <span class="n">sample_sz</span> <span class="o">+</span> <span class="mi">6</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tx</span> <span class="o">=</span> <span class="n">lx</span> <span class="o">+</span> <span class="n">pad</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">tx</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">color_text</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">+=</span> <span class="n">th</span> <span class="o">+</span> <span class="n">line_gap</span>

            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;PNG&quot;</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">95</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis image saved successfully to: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Verify the file was actually created</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                <span class="n">_file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis overlay error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span></div>


    <span class="c1"># Additional methods will be added as needed...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_ground_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the Z coordinate of the ground/floor.&quot;&quot;&quot;</span>
        <span class="n">floor</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SynthFloor&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">floor</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">floor</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assumed_ground_z&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_random_light_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a random light color based on configuration.&quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_colored_lights&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;colored_light_probability&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;light_color_palette&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">palette</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aim_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">target_loc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rotate obj so -Z axis points to target (like a camera).&quot;&quot;&quot;</span>
        <span class="n">look_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_loc</span> <span class="o">-</span> <span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">rotation_euler</span> <span class="o">=</span> <span class="n">look_dir</span><span class="o">.</span><span class="n">to_track_quat</span><span class="p">(</span><span class="s2">&quot;-Z&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_euler</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_place_light_around</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anchor_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Place a light around the anchor object.&quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;light_distance_range&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">)))</span>
        <span class="n">az_deg</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
        <span class="n">el_deg</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;light_elevation_deg_range&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">80.0</span><span class="p">)))</span>
        <span class="n">az</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">az_deg</span><span class="p">)</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">el_deg</span><span class="p">)</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">anchor_obj</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">anchor</span> <span class="o">+</span> <span class="n">Vector</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">dist</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">el</span><span class="p">),</span>
                <span class="n">dist</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">el</span><span class="p">),</span>
                <span class="n">dist</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">el</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ground_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ground_z</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="n">ground_z</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ground_z</span> <span class="o">+</span> <span class="mf">0.05</span>
        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">el_deg</span><span class="p">,</span> <span class="n">az_deg</span><span class="p">,</span> <span class="n">dist</span>

<div class="viewcode-block" id="BaseGenerator.create_random_lights">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.create_random_lights">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_random_lights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anchor_obj</span><span class="p">,</span> <span class="n">replace_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create 1..N random lights around anchor_obj.</span>
<span class="sd">        Also ensures at least one neutral &#39;key&#39; light when requested.</span>
<span class="sd">        EXACT implementation from original one_pallet_generator.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>

        <span class="k">if</span> <span class="n">replace_existing</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">o</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span>
                <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;LIGHT&quot;</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SynthLight_&quot;</span><span class="p">)</span>
            <span class="p">]:</span>
                <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">do_unlink</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">*</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;light_count_range&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="n">types</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;light_types&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;POINT&quot;</span><span class="p">,</span> <span class="s2">&quot;AREA&quot;</span><span class="p">,</span> <span class="s2">&quot;SPOT&quot;</span><span class="p">,</span> <span class="s2">&quot;SUN&quot;</span><span class="p">])</span>
        <span class="n">energy_ranges</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;light_energy_ranges&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;POINT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
                <span class="s2">&quot;AREA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
                <span class="s2">&quot;SPOT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">1200</span><span class="p">),</span>
                <span class="s2">&quot;SUN&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">created</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">brightest_energy</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">lt</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">lights</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SynthLightData_</span><span class="si">{</span><span class="n">lt</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lt</span><span class="p">)</span>
            <span class="n">er</span> <span class="o">=</span> <span class="n">energy_ranges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
            <span class="n">L</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">er</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lt</span> <span class="o">==</span> <span class="s2">&quot;AREA&quot;</span><span class="p">:</span>
                <span class="n">L</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lt</span> <span class="o">==</span> <span class="s2">&quot;SPOT&quot;</span><span class="p">:</span>
                <span class="n">L</span><span class="o">.</span><span class="n">spot_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spot_size_deg_range&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">)))</span>
                <span class="p">)</span>
                <span class="n">L</span><span class="o">.</span><span class="n">spot_blend</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spot_blend_range&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)))</span>
            <span class="n">L</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_light_color</span><span class="p">()</span>

            <span class="n">Lo</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SynthLight_</span><span class="si">{</span><span class="n">lt</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">Lo</span><span class="p">)</span>

            <span class="n">loc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_place_light_around</span><span class="p">(</span><span class="n">anchor_obj</span><span class="p">)</span>
            <span class="n">Lo</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">loc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aim_at</span><span class="p">(</span><span class="n">Lo</span><span class="p">,</span> <span class="n">Vector</span><span class="p">(</span><span class="n">anchor_obj</span><span class="o">.</span><span class="n">location</span><span class="p">))</span>
            <span class="n">created</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lo</span><span class="p">)</span>
            <span class="n">brightest_energy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">brightest_energy</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>

        <span class="c1"># Ensure a key light for realism (white, decent energy)</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;force_key_light&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">need_key</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">created</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">):</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">color</span>
                    <span class="n">is_whiteish</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">g</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.3</span>
                    <span class="k">if</span> <span class="n">is_whiteish</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">energy</span> <span class="o">&gt;=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;min_key_light_energy&quot;</span><span class="p">,</span> <span class="mf">500.0</span>
                    <span class="p">):</span>
                        <span class="n">need_key</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">need_key</span><span class="p">:</span>
                <span class="n">lt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;AREA&quot;</span>
                    <span class="k">if</span> <span class="s2">&quot;AREA&quot;</span> <span class="ow">in</span> <span class="n">types</span>
                    <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;SPOT&quot;</span> <span class="k">if</span> <span class="s2">&quot;SPOT&quot;</span> <span class="ow">in</span> <span class="n">types</span> <span class="k">else</span> <span class="s2">&quot;POINT&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">L</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">lights</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;SynthLightData_KEY&quot;</span><span class="p">,</span> <span class="n">lt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lt</span> <span class="o">==</span> <span class="s2">&quot;AREA&quot;</span><span class="p">:</span>
                    <span class="n">L</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mf">2.0</span>
                <span class="k">if</span> <span class="n">lt</span> <span class="o">==</span> <span class="s2">&quot;SPOT&quot;</span><span class="p">:</span>
                    <span class="n">L</span><span class="o">.</span><span class="n">spot_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">35.0</span><span class="p">)</span>
                    <span class="n">L</span><span class="o">.</span><span class="n">spot_blend</span> <span class="o">=</span> <span class="mf">0.2</span>
                <span class="n">L</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">L</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_key_light_energy&quot;</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">),</span> <span class="n">brightest_energy</span> <span class="o">*</span> <span class="mf">1.2</span>
                <span class="p">)</span>
                <span class="n">Lo</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;SynthLight_KEY&quot;</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
                <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">Lo</span><span class="p">)</span>
                <span class="n">loc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_place_light_around</span><span class="p">(</span><span class="n">anchor_obj</span><span class="p">)</span>
                <span class="n">Lo</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">loc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_aim_at</span><span class="p">(</span><span class="n">Lo</span><span class="p">,</span> <span class="n">Vector</span><span class="p">(</span><span class="n">anchor_obj</span><span class="o">.</span><span class="n">location</span><span class="p">))</span>
                <span class="n">created</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lo</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created key light with energy </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">energy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure minimum total lighting energy</span>
        <span class="n">total_energy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">light</span> <span class="ow">in</span> <span class="n">created</span><span class="p">)</span>
        <span class="n">min_total_energy</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_total_light_energy&quot;</span><span class="p">,</span> <span class="mf">300.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_energy</span> <span class="o">&lt;</span> <span class="n">min_total_energy</span><span class="p">:</span>
            <span class="c1"># Add an additional fill light to boost overall brightness</span>
            <span class="n">fill_energy</span> <span class="o">=</span> <span class="n">min_total_energy</span> <span class="o">-</span> <span class="n">total_energy</span> <span class="o">+</span> <span class="mi">100</span>  <span class="c1"># Extra 100 for safety</span>
            <span class="n">L_fill</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">lights</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;SynthLightData_FILL&quot;</span><span class="p">,</span> <span class="s2">&quot;AREA&quot;</span><span class="p">)</span>
            <span class="n">L_fill</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">fill_energy</span>
            <span class="n">L_fill</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">L_fill</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mf">3.0</span>

            <span class="n">Lo_fill</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;SynthLight_FILL&quot;</span><span class="p">,</span> <span class="n">L_fill</span><span class="p">)</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">Lo_fill</span><span class="p">)</span>

            <span class="c1"># Position fill light from a different angle</span>
            <span class="n">loc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_place_light_around</span><span class="p">(</span><span class="n">anchor_obj</span><span class="p">)</span>
            <span class="n">loc</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Offset position</span>
            <span class="n">loc</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">Lo_fill</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">loc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aim_at</span><span class="p">(</span><span class="n">Lo_fill</span><span class="p">,</span> <span class="n">Vector</span><span class="p">(</span><span class="n">anchor_obj</span><span class="o">.</span><span class="n">location</span><span class="p">))</span>
            <span class="n">created</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lo_fill</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Added fill light with energy </span><span class="si">{</span><span class="n">fill_energy</span><span class="si">}</span><span class="s2"> to ensure minimum brightness&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">created</span></div>


<div class="viewcode-block" id="BaseGenerator.get_bbox_2d_accurate">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.get_bbox_2d_accurate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bbox_2d_accurate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get accurate 2D bounding box - EXACT from original.&quot;&quot;&quot;</span>
        <span class="n">depsgraph</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">evaluated_depsgraph_get</span><span class="p">()</span>
        <span class="n">obj_eval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">evaluated_get</span><span class="p">(</span><span class="n">depsgraph</span><span class="p">)</span>
        <span class="n">mesh_eval</span> <span class="o">=</span> <span class="n">obj_eval</span><span class="o">.</span><span class="n">to_mesh</span><span class="p">()</span>
        <span class="n">verts_world</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj_eval</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">@</span> <span class="n">v</span><span class="o">.</span><span class="n">co</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh_eval</span><span class="o">.</span><span class="n">vertices</span><span class="p">]</span>
        <span class="n">obj_eval</span><span class="o">.</span><span class="n">to_mesh_clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verts_world</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_points</span><span class="p">(</span><span class="n">verts_world</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proj</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">res_x</span><span class="p">,</span> <span class="n">res_y</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_x</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_y</span>
        <span class="n">x_min_full</span><span class="p">,</span> <span class="n">y_min_full</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
        <span class="n">x_max_full</span><span class="p">,</span> <span class="n">y_max_full</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_min_full</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_min_full</span><span class="p">)</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">res_x</span><span class="p">,</span> <span class="n">x_max_full</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">res_y</span><span class="p">,</span> <span class="n">y_max_full</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">full_w</span> <span class="o">=</span> <span class="n">x_max_full</span> <span class="o">-</span> <span class="n">x_min_full</span>
        <span class="n">full_h</span> <span class="o">=</span> <span class="n">y_max_full</span> <span class="o">-</span> <span class="n">y_min_full</span>
        <span class="n">full_area</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">full_w</span> <span class="o">*</span> <span class="n">full_h</span><span class="p">)</span>
        <span class="n">vis_area</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">h</span>
        <span class="n">vis_ratio</span> <span class="o">=</span> <span class="n">vis_area</span> <span class="o">/</span> <span class="n">full_area</span> <span class="k">if</span> <span class="n">full_area</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">crop_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">vis_ratio</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="n">x0</span><span class="p">,</span>
            <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="n">y0</span><span class="p">,</span>
            <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="n">x1</span><span class="p">,</span>
            <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="n">y1</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">h</span><span class="p">,</span>
            <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">y0</span> <span class="o">+</span> <span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">vis_area</span><span class="p">,</span>
            <span class="s2">&quot;full_bbox&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="n">x_min_full</span><span class="p">,</span>
                <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="n">y_min_full</span><span class="p">,</span>
                <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="n">x_max_full</span><span class="p">,</span>
                <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="n">y_max_full</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">full_w</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">full_h</span><span class="p">,</span>
                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">full_area</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;visible_ratio&quot;</span><span class="p">:</span> <span class="n">vis_ratio</span><span class="p">,</span>
            <span class="s2">&quot;crop_ratio&quot;</span><span class="p">:</span> <span class="n">crop_ratio</span><span class="p">,</span>
            <span class="s2">&quot;is_cropped&quot;</span><span class="p">:</span> <span class="n">crop_ratio</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="BaseGenerator.bbox_3d_oriented">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.bbox_3d_oriented">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bbox_3d_oriented</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get 3D oriented bounding box - EXACT from original.&quot;&quot;&quot;</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">world</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">@</span> <span class="n">Vector</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">bound_box</span><span class="p">]</span>
        <span class="n">cen</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">Vector</span><span class="p">())</span> <span class="o">/</span> <span class="mi">8</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="n">v</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">world</span><span class="p">],</span>
            <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cen</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">cen</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">cen</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="BaseGenerator.project_points">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.project_points">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">project_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Project 3D points to 2D screen coordinates - EXACT from original.&quot;&quot;&quot;</span>
        <span class="n">res_x</span><span class="p">,</span> <span class="n">res_y</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_x</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">resolution_y</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">w2cv</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">Vector</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">co</span> <span class="ow">and</span> <span class="n">co</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">co</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">res_x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">co</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">res_y</span><span class="p">,</span> <span class="n">co</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="BaseGenerator.hole_bboxes_3d">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.hole_bboxes_3d">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">hole_bboxes_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">side_margin</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">_gap</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">hole_height</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate 3D hole/pocket bounding boxes for pallet - EXACT from original.&quot;&quot;&quot;</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">bound_box</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
        <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">zmax</span> <span class="o">-</span> <span class="n">zmin</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">zmin</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">hole_height</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">zmin</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">hole_height</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">pockets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hole_frac</span> <span class="o">=</span> <span class="mf">0.35</span>
        <span class="n">x_start</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="n">side_margin</span>
        <span class="n">x_end</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">w</span> <span class="o">*</span> <span class="n">side_margin</span>
        <span class="n">hole_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_end</span> <span class="o">-</span> <span class="n">x_start</span><span class="p">)</span> <span class="o">*</span> <span class="n">hole_frac</span>

        <span class="c1"># front/back (two each)</span>
        <span class="n">pockets</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">x_start</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_start</span> <span class="o">+</span> <span class="n">hole_w</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_start</span> <span class="o">+</span> <span class="n">hole_w</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_start</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">x_end</span> <span class="o">-</span> <span class="n">hole_w</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_end</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_end</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_end</span> <span class="o">-</span> <span class="n">hole_w</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">x_start</span> <span class="o">+</span> <span class="n">hole_w</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_start</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_start</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_start</span> <span class="o">+</span> <span class="n">hole_w</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">x_end</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_end</span> <span class="o">-</span> <span class="n">hole_w</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_end</span> <span class="o">-</span> <span class="n">hole_w</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
                <span class="p">[</span><span class="n">x_end</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
            <span class="p">],</span>
        <span class="p">]</span>
        <span class="c1"># left/right (two each)</span>
        <span class="n">y_start</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">side_margin</span>
        <span class="n">y_end</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">d</span> <span class="o">*</span> <span class="n">side_margin</span>
        <span class="n">hole_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_end</span> <span class="o">-</span> <span class="n">y_start</span><span class="p">)</span> <span class="o">*</span> <span class="n">hole_frac</span>
        <span class="n">pockets</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">hole_d</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">hole_d</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">hole_d</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y_end</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y_end</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">hole_d</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">hole_d</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">hole_d</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">y_end</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">hole_d</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">hole_d</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
                <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">y_end</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span>
            <span class="p">],</span>
        <span class="p">]</span>
        <span class="n">wm</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">matrix_world</span>
        <span class="k">return</span> <span class="p">[[</span><span class="nb">list</span><span class="p">(</span><span class="n">wm</span> <span class="o">@</span> <span class="n">Vector</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pocket</span><span class="p">]</span> <span class="k">for</span> <span class="n">pocket</span> <span class="ow">in</span> <span class="n">pockets</span><span class="p">]</span></div>


<div class="viewcode-block" id="BaseGenerator.auto_expose_frame">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.auto_expose_frame">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">auto_expose_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">_cam_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced auto-exposure with minimum brightness guarantee.&quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_auto_exposure&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Get current exposure settings</span>
        <span class="n">target_ev</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_exposure_ev&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Ensure minimum brightness by checking if we have adequate lighting</span>
        <span class="n">min_ev</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exposure_min&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">)</span>  <span class="c1"># Minimum EV for adequate brightness</span>
        <span class="n">max_ev</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exposure_max&quot;</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span>  <span class="c1"># Maximum EV to prevent overexposure</span>

        <span class="c1"># Check if we have sufficient lighting in the scene</span>
        <span class="n">total_light_energy</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">light_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;LIGHT&quot;</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">total_light_energy</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">energy</span>
                <span class="n">light_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># If lighting is too dim, boost exposure</span>
        <span class="k">if</span> <span class="n">light_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avg_light_energy</span> <span class="o">=</span> <span class="n">total_light_energy</span> <span class="o">/</span> <span class="n">light_count</span>
            <span class="k">if</span> <span class="n">avg_light_energy</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Low energy threshold</span>
                <span class="n">target_ev</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">target_ev</span><span class="p">,</span> <span class="n">min_ev</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Boost by at least 1 EV</span>

        <span class="c1"># Clamp exposure to reasonable range</span>
        <span class="n">target_ev</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_ev</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_ev</span><span class="p">,</span> <span class="n">target_ev</span><span class="p">))</span>

        <span class="c1"># Apply exposure</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">view_settings</span><span class="o">.</span><span class="n">exposure</span> <span class="o">=</span> <span class="n">target_ev</span>

        <span class="k">return</span> <span class="n">target_ev</span></div>


<div class="viewcode-block" id="BaseGenerator.detect_faces_in_scene">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.detect_faces_in_scene">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">detect_faces_in_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detect faces in the scene by looking for pallet objects and extracting their faces.</span>
<span class="sd">        Uses the pallet&#39;s 3D bounding box to define 6 faces and generate keypoints for each visible face.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Look for pallet objects (objects with &quot;pallet&quot; in name or pass_index &gt; 0)</span>
        <span class="n">min_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keypoints_min_face_area&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;MESH&quot;</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">pass_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="s2">&quot;pallet&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="c1"># Skip objects that might be bottom/top faces or other non-pallet objects</span>
                <span class="n">obj_name_lower</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">skip_word</span> <span class="ow">in</span> <span class="n">obj_name_lower</span>
                    <span class="k">for</span> <span class="n">skip_word</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;down&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;face&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping non-pallet object: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing pallet object: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Get the pallet&#39;s 3D bounding box</span>
                <span class="n">bbox_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_3d_oriented</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">corners_3d</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vector</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bbox_3d</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]]</span>

                <span class="c1"># Get all 6 faces from 3D bounding box using proper Blender API approach</span>
                <span class="n">all_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_faces_from_bbox</span><span class="p">()</span>

                <span class="c1"># Identify top and bottom faces by Z coordinates</span>
                <span class="n">side_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_side_faces</span><span class="p">(</span><span class="n">all_faces</span><span class="p">,</span> <span class="n">corners_3d</span><span class="p">)</span>

                <span class="c1"># Collect all visible faces first</span>
                <span class="n">visible_faces</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_face_idx</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">side_faces</span><span class="p">):</span>
                    <span class="n">corner_indices</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]</span>
                    <span class="n">face_name</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="c1"># Preserve the original face index from the full face list</span>
                    <span class="n">original_face_idx</span> <span class="o">=</span> <span class="n">all_faces</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">face_data</span><span class="p">)</span>
                    <span class="c1"># Get the 4 corners of this face</span>
                    <span class="n">face_corners_3d</span> <span class="o">=</span> <span class="p">[</span><span class="n">corners_3d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">corner_indices</span><span class="p">]</span>

                    <span class="c1"># Calculate face center and dimensions</span>
                    <span class="n">face_center</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">face_corners_3d</span><span class="p">,</span> <span class="n">Vector</span><span class="p">())</span> <span class="o">/</span> <span class="mi">4</span>

                    <span class="c1"># Project face corners to 2D to check visibility</span>
                    <span class="n">face_corners_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_points</span><span class="p">(</span><span class="n">face_corners_3d</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
                    <span class="n">visible_corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">face_corners_2d</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">visible_corners</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span>
                    <span class="p">):</span>  <span class="c1"># Face is visible if at least 3 corners are visible</span>
                        <span class="c1"># Calculate 2D bounding box for this face</span>
                        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="o">*</span><span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">visible_corners</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span>
                        <span class="p">)</span>
                        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
                        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>

                        <span class="n">face_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">face_area</span> <span class="o">&gt;</span> <span class="n">min_area</span><span class="p">:</span>
                            <span class="c1"># Calculate face normal to determine how directly it faces the camera</span>
                            <span class="n">face_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_face_normal</span><span class="p">(</span><span class="n">face_corners_3d</span><span class="p">)</span>
                            <span class="n">camera_direction</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">cam_obj</span><span class="o">.</span><span class="n">location</span> <span class="o">-</span> <span class="n">face_center</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>
                            <span class="n">face_angle</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
                                <span class="n">face_normal</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">camera_direction</span><span class="p">)</span>
                            <span class="p">)</span>  <span class="c1"># Higher = more directly facing camera</span>

                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;  Adding visible face: </span><span class="si">{</span><span class="n">face_name</span><span class="si">}</span><span class="s2"> (original index </span><span class="si">{</span><span class="n">original_face_idx</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="p">)</span>
                            <span class="n">visible_faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="p">,</span>
                                    <span class="s2">&quot;face_index&quot;</span><span class="p">:</span> <span class="n">original_face_idx</span><span class="p">,</span>
                                    <span class="s2">&quot;face_name&quot;</span><span class="p">:</span> <span class="n">face_name</span><span class="p">,</span>
                                    <span class="s2">&quot;face_center_3d&quot;</span><span class="p">:</span> <span class="n">face_center</span><span class="p">,</span>
                                    <span class="s2">&quot;face_corners_3d&quot;</span><span class="p">:</span> <span class="n">face_corners_3d</span><span class="p">,</span>
                                    <span class="s2">&quot;face_normal&quot;</span><span class="p">:</span> <span class="n">face_normal</span><span class="p">,</span>
                                    <span class="s2">&quot;face_angle&quot;</span><span class="p">:</span> <span class="n">face_angle</span><span class="p">,</span>
                                    <span class="s2">&quot;bbox_2d&quot;</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="n">x_min</span><span class="p">,</span>
                                        <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="n">y_min</span><span class="p">,</span>
                                        <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="n">x_max</span><span class="p">,</span>
                                        <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="n">y_max</span><span class="p">,</span>
                                        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">,</span>
                                        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">,</span>
                                        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">face_area</span><span class="p">,</span>
                                    <span class="p">},</span>
                                    <span class="s2">&quot;bbox_3d&quot;</span><span class="p">:</span> <span class="n">bbox_3d</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">)</span>

                <span class="c1"># Select faces based on camera proximity and orientation</span>
                <span class="n">selected_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_faces_by_camera_proximity</span><span class="p">(</span>
                    <span class="n">visible_faces</span><span class="p">,</span> <span class="n">cam_obj</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">selected_faces</span><span class="p">:</span>
                    <span class="n">face_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;face_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">selected_faces</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_faces</span><span class="p">)</span><span class="si">}</span><span class="s2"> faces by camera proximity: </span><span class="si">{</span><span class="n">face_names</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="n">faces</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">selected_faces</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">faces</span></div>


<div class="viewcode-block" id="BaseGenerator.get_all_faces_from_bbox">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.get_all_faces_from_bbox">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_faces_from_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all 6 faces from 3D bounding box corners.</span>
<span class="sd">        Returns list of face data with corner indices and names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Standard 3D bounding box face definitions</span>
        <span class="n">all_faces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;face_0&quot;</span><span class="p">},</span>  <span class="c1"># Face 0</span>
            <span class="p">{</span><span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;face_1&quot;</span><span class="p">},</span>  <span class="c1"># Face 1</span>
            <span class="p">{</span><span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;face_2&quot;</span><span class="p">},</span>  <span class="c1"># Face 2</span>
            <span class="p">{</span><span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;face_3&quot;</span><span class="p">},</span>  <span class="c1"># Face 3</span>
            <span class="p">{</span><span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;face_4&quot;</span><span class="p">},</span>  <span class="c1"># Face 4</span>
            <span class="p">{</span><span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;face_5&quot;</span><span class="p">},</span>  <span class="c1"># Face 5</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">all_faces</span></div>


<div class="viewcode-block" id="BaseGenerator.filter_side_faces">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.filter_side_faces">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_side_faces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_faces</span><span class="p">,</span> <span class="n">corners_3d</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter out top and bottom faces by analyzing Z coordinates.</span>
<span class="sd">        Returns only the 4 side faces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate Z coordinates for each face center</span>
        <span class="n">face_z_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">all_faces</span><span class="p">:</span>
            <span class="n">face_corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">corners_3d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]]</span>
            <span class="n">face_center_z</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">corner</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">face_corners</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="n">face_z_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_center_z</span><span class="p">)</span>

        <span class="c1"># Sort faces by Z coordinate</span>
        <span class="n">sorted_faces</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">all_faces</span><span class="p">,</span> <span class="n">face_z_coords</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># The top face has highest Z, bottom face has lowest Z</span>
        <span class="c1"># The 4 middle faces are the side faces</span>
        <span class="n">side_faces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">face</span> <span class="k">for</span> <span class="n">face</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sorted_faces</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">]</span>  <span class="c1"># Exclude first (bottom) and last (top)</span>

        <span class="k">return</span> <span class="n">side_faces</span></div>


<div class="viewcode-block" id="BaseGenerator.create_3d_debug_visualization">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.create_3d_debug_visualization">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_3d_debug_visualization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a 3D visualization showing camera position, pallet corners, and face names.</span>
<span class="sd">        Saves the visualization to a new debug folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Matplotlib not available for 3D visualization&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Use the debug_3d folder from setup_folders</span>
        <span class="n">debug_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;debug_3d&quot;</span><span class="p">]</span>

        <span class="c1"># Get pallet bounding box and corners</span>
        <span class="n">bbox_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_3d_oriented</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">corners_3d</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vector</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bbox_3d</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]]</span>

        <span class="c1"># Get camera position</span>
        <span class="n">camera_pos</span> <span class="o">=</span> <span class="n">cam_obj</span><span class="o">.</span><span class="n">location</span>

        <span class="c1"># Create figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>

        <span class="c1"># Plot pallet corners</span>
        <span class="n">corner_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">corners_3d</span><span class="p">]</span>
        <span class="n">corner_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">corners_3d</span><span class="p">]</span>
        <span class="n">corner_z</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">corners_3d</span><span class="p">]</span>

        <span class="c1"># Plot corners as large red dots</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">corner_x</span><span class="p">,</span> <span class="n">corner_y</span><span class="p">,</span> <span class="n">corner_z</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pallet Corners&quot;</span><span class="p">)</span>

        <span class="c1"># Label each corner</span>
        <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners_3d</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

        <span class="c1"># Plot camera position</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
            <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
            <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Camera&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
            <span class="s2">&quot;  Camera&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Draw lines connecting corners to show the pallet structure</span>
        <span class="c1"># Define the edges of the bounding box</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Bottom face</span>
            <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>  <span class="c1"># Top face</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>  <span class="c1"># Vertical edges</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">corners_3d</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">corners_3d</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">start</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">start</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">start</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="s2">&quot;k-&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span>
            <span class="p">)</span>

        <span class="c1"># Get all faces and their centers</span>
        <span class="n">all_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_faces_from_bbox</span><span class="p">()</span>
        <span class="n">side_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_side_faces</span><span class="p">(</span><span class="n">all_faces</span><span class="p">,</span> <span class="n">corners_3d</span><span class="p">)</span>

        <span class="c1"># Plot face centers and labels</span>
        <span class="n">face_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="s2">&quot;brown&quot;</span><span class="p">,</span> <span class="s2">&quot;pink&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">face</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_faces</span><span class="p">):</span>
            <span class="n">face_corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">corners_3d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]]</span>
            <span class="n">face_center</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">face_corners</span><span class="p">,</span> <span class="n">Vector</span><span class="p">())</span> <span class="o">/</span> <span class="mi">4</span>

            <span class="c1"># Color side faces differently</span>
            <span class="k">if</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">side_faces</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">face_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors</span><span class="p">)]</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">80</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;lightgray&quot;</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">50</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="p">[</span><span class="n">face_center</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                <span class="p">[</span><span class="n">face_center</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                <span class="p">[</span><span class="n">face_center</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">face_center</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">face_center</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">face_center</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">face</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Draw lines from camera to each corner for distance visualization</span>
        <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners_3d</span><span class="p">):</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span> <span class="o">-</span> <span class="n">corner</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
                <span class="s2">&quot;r--&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Add distance labels</span>
            <span class="n">mid_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">mid_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">mid_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">mid_x</span><span class="p">,</span> <span class="n">mid_y</span><span class="p">,</span> <span class="n">mid_z</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

        <span class="c1"># Set labels and title</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;3D Debug View - Frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">Object: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add legend</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="c1"># Set equal aspect ratio</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">corner_x</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                <span class="n">corner_y</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                <span class="n">corner_z</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_range</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_range</span><span class="p">)</span>
        <span class="n">mid_x</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">corner_x</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">corner_x</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">]))</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">mid_y</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">corner_y</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">corner_y</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">]))</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">mid_z</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">corner_z</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">])</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">corner_z</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">]))</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">mid_x</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mid_x</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">mid_y</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mid_y</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">mid_z</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mid_z</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Save the plot</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">debug_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;frame_</span><span class="si">{</span><span class="n">frame_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">_3d_debug.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;3D debug visualization saved to: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Also save coordinate data as text file</span>
        <span class="n">coord_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">debug_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;frame_</span><span class="si">{</span><span class="n">frame_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">_coordinates.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">coord_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2"> - 3D Coordinates Debug</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Camera Position: (</span><span class="si">{</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Pallet Corners:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners_3d</span><span class="p">):</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span> <span class="o">-</span> <span class="n">corner</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Corner </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: (</span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) - Distance: </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Face Centers:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">all_faces</span><span class="p">:</span>
                <span class="n">face_corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">corners_3d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]]</span>
                <span class="n">face_center</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">face_corners</span><span class="p">,</span> <span class="n">Vector</span><span class="p">())</span> <span class="o">/</span> <span class="mi">4</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span> <span class="o">-</span> <span class="n">face_center</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">face</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: (</span><span class="si">{</span><span class="n">face_center</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">face_center</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">face_center</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) - Distance: </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coordinate data saved to: </span><span class="si">{</span><span class="n">coord_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseGenerator.create_3d_debug_visualization_with_faces">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.create_3d_debug_visualization_with_faces">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_3d_debug_visualization_with_faces</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">selected_faces</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a 3D visualization showing camera position, pallet corners, face names, and selected faces.</span>
<span class="sd">        Saves the visualization to the debug_3d folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting 3D visualization for </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Matplotlib imports successful&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matplotlib not available for 3D visualization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Use the debug_3d folder from setup_folders</span>
        <span class="n">debug_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;debug_3d&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Debug folder: </span><span class="si">{</span><span class="n">debug_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get pallet bounding box and corners</span>
        <span class="n">bbox_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_3d_oriented</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">corners_3d</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vector</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bbox_3d</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">corners_3d</span><span class="p">)</span><span class="si">}</span><span class="s2"> corners for </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get camera position</span>
        <span class="n">camera_pos</span> <span class="o">=</span> <span class="n">cam_obj</span><span class="o">.</span><span class="n">location</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Camera position: (</span><span class="si">{</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>

        <span class="c1"># Plot pallet corners</span>
        <span class="n">corner_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">corners_3d</span><span class="p">]</span>
        <span class="n">corner_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">corners_3d</span><span class="p">]</span>
        <span class="n">corner_z</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">corners_3d</span><span class="p">]</span>

        <span class="c1"># Plot corners as large red dots</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">corner_x</span><span class="p">,</span> <span class="n">corner_y</span><span class="p">,</span> <span class="n">corner_z</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pallet Corners&quot;</span><span class="p">)</span>

        <span class="c1"># Label each corner</span>
        <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners_3d</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

        <span class="c1"># Plot camera position</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
            <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
            <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Camera&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
            <span class="s2">&quot;  Camera&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Draw lines connecting corners to show the pallet structure</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Bottom face</span>
            <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>  <span class="c1"># Top face</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>  <span class="c1"># Vertical edges</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">corners_3d</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">corners_3d</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">start</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">start</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">start</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="s2">&quot;k-&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span>
            <span class="p">)</span>

        <span class="c1"># Get all faces and their centers</span>
        <span class="n">all_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_faces_from_bbox</span><span class="p">()</span>
        <span class="n">side_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_side_faces</span><span class="p">(</span><span class="n">all_faces</span><span class="p">,</span> <span class="n">corners_3d</span><span class="p">)</span>

        <span class="c1"># Get selected face names for this object</span>
        <span class="n">selected_face_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="n">selected_faces</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">selected_face_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;face_name&quot;</span><span class="p">])</span>

        <span class="c1"># Plot face centers and labels</span>
        <span class="n">face_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="s2">&quot;brown&quot;</span><span class="p">,</span> <span class="s2">&quot;pink&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">face</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_faces</span><span class="p">):</span>
            <span class="n">face_corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">corners_3d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]]</span>
            <span class="n">face_center</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">face_corners</span><span class="p">,</span> <span class="n">Vector</span><span class="p">())</span> <span class="o">/</span> <span class="mi">4</span>

            <span class="c1"># Determine color and size based on selection status</span>
            <span class="k">if</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">selected_face_names</span><span class="p">:</span>
                <span class="c1"># Selected face - bright color, larger size</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">face_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors</span><span class="p">)]</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">120</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span>
                <span class="n">label_suffix</span> <span class="o">=</span> <span class="s2">&quot; (SELECTED)&quot;</span>
            <span class="k">elif</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">side_faces</span><span class="p">:</span>
                <span class="c1"># Side face but not selected - medium color, medium size</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;lightblue&quot;</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">80</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
                <span class="n">label_suffix</span> <span class="o">=</span> <span class="s2">&quot; (side)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Top/bottom face - light gray, small size</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;lightgray&quot;</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">50</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;^&quot;</span>
                <span class="n">label_suffix</span> <span class="o">=</span> <span class="s2">&quot; (top/bottom)&quot;</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="p">[</span><span class="n">face_center</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                <span class="p">[</span><span class="n">face_center</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                <span class="p">[</span><span class="n">face_center</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">face_center</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">face_center</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">face_center</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">face</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}{</span><span class="n">label_suffix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span> <span class="k">if</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">selected_face_names</span> <span class="k">else</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Draw lines from camera to each corner for distance visualization</span>
        <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners_3d</span><span class="p">):</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span> <span class="o">-</span> <span class="n">corner</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
                <span class="s2">&quot;r--&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Add distance labels</span>
            <span class="n">mid_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">mid_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">mid_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">mid_x</span><span class="p">,</span> <span class="n">mid_y</span><span class="p">,</span> <span class="n">mid_z</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

        <span class="c1"># Set labels and title</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;3D Debug View - Frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">Object: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">Selected Faces: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">selected_face_names</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">selected_face_names</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Add legend</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="c1"># Set equal aspect ratio</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">corner_x</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                <span class="n">corner_y</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                <span class="n">corner_z</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_range</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_range</span><span class="p">)</span>
        <span class="n">mid_x</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">corner_x</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">corner_x</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">]))</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">mid_y</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">corner_y</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">corner_y</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">]))</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">mid_z</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">corner_z</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">])</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">corner_z</span> <span class="o">+</span> <span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">]))</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">mid_x</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mid_x</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">mid_y</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mid_y</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">mid_z</span> <span class="o">-</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mid_z</span> <span class="o">+</span> <span class="n">max_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Save the plot as PNG image</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;debug_3d_images&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;frame_</span><span class="si">{</span><span class="n">frame_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">_3d_debug.png&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving 3D plot to: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;3D debug visualization saved to: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving 3D plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Save interactive 3D figure using plotly (if available)</span>
        <span class="n">interactive_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;debug_3d_figures&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;frame_</span><span class="si">{</span><span class="n">frame_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">_3d_interactive.html&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_interactive_3d_figure</span><span class="p">(</span>
                <span class="n">corners_3d</span><span class="p">,</span> <span class="n">camera_pos</span><span class="p">,</span> <span class="n">selected_faces</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">interactive_path</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interactive 3D figure saved to: </span><span class="si">{</span><span class="n">interactive_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not save interactive figure: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Also save coordinate data as text file</span>
        <span class="n">coord_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;debug_3d_coordinates&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;frame_</span><span class="si">{</span><span class="n">frame_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">_coordinates.txt&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving coordinate data to: </span><span class="si">{</span><span class="n">coord_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">coord_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2"> - 3D Coordinates Debug</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Camera Position: (</span><span class="si">{</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Selected Faces: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">selected_face_names</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">selected_face_names</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Pallet Corner Points (8 corners):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners_3d</span><span class="p">):</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span> <span class="o">-</span> <span class="n">corner</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  Corner </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: (</span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) - Distance: </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">All Face Definitions (6 faces total):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">all_faces</span><span class="p">:</span>
                    <span class="n">face_corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">corners_3d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]]</span>
                    <span class="n">face_center</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">face_corners</span><span class="p">,</span> <span class="n">Vector</span><span class="p">())</span> <span class="o">/</span> <span class="mi">4</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span> <span class="o">-</span> <span class="n">face_center</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;SELECTED&quot;</span>
                        <span class="k">if</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">selected_face_names</span>
                        <span class="k">else</span> <span class="s2">&quot;not selected&quot;</span>
                    <span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">face</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (corners </span><span class="si">{</span><span class="n">face</span><span class="p">[</span><span class="s1">&#39;corners&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    Center: (</span><span class="si">{</span><span class="n">face_center</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">face_center</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">face_center</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) - Distance: </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    Corner Points:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">corner_idx</span> <span class="ow">in</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]:</span>
                        <span class="n">corner</span> <span class="o">=</span> <span class="n">corners_3d</span><span class="p">[</span><span class="n">corner_idx</span><span class="p">]</span>
                        <span class="n">corner_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span> <span class="o">-</span> <span class="n">corner</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;      Corner </span><span class="si">{</span><span class="n">corner_idx</span><span class="si">}</span><span class="s2">: (</span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) - Distance: </span><span class="si">{</span><span class="n">corner_dist</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Selected Face Details:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selected_face_names</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="n">selected_faces</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj</span><span class="p">:</span>
                            <span class="n">face_name</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;face_name&quot;</span><span class="p">]</span>
                            <span class="n">face_index</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;face_index&quot;</span><span class="p">]</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">face_name</span><span class="si">}</span><span class="s2"> (index </span><span class="si">{</span><span class="n">face_index</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                            <span class="c1"># Get the face definition</span>
                            <span class="n">face_def</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">all_faces</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">face_name</span><span class="p">:</span>
                                    <span class="n">face_def</span> <span class="o">=</span> <span class="n">face</span>
                                    <span class="k">break</span>

                            <span class="k">if</span> <span class="n">face_def</span><span class="p">:</span>
                                <span class="n">face_corners</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="n">corners_3d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">face_def</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]</span>
                                <span class="p">]</span>
                                <span class="n">face_center</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">face_corners</span><span class="p">,</span> <span class="n">Vector</span><span class="p">())</span> <span class="o">/</span> <span class="mi">4</span>
                                <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span> <span class="o">-</span> <span class="n">face_center</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;    Center Position: (</span><span class="si">{</span><span class="n">face_center</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">face_center</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">face_center</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Distance from Camera: </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Corner Indices: </span><span class="si">{</span><span class="n">face_def</span><span class="p">[</span><span class="s1">&#39;corners&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    Corner Positions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">corner_idx</span> <span class="ow">in</span> <span class="n">face_def</span><span class="p">[</span><span class="s2">&quot;corners&quot;</span><span class="p">]:</span>
                                    <span class="n">corner</span> <span class="o">=</span> <span class="n">corners_3d</span><span class="p">[</span><span class="n">corner_idx</span><span class="p">]</span>
                                    <span class="n">corner_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_pos</span> <span class="o">-</span> <span class="n">corner</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;      Corner </span><span class="si">{</span><span class="n">corner_idx</span><span class="si">}</span><span class="s2">: (</span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) - Distance: </span><span class="si">{</span><span class="n">corner_dist</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>

                                <span class="c1"># Add 2D bounding box info if available</span>
                                <span class="k">if</span> <span class="s2">&quot;bbox_2d&quot;</span> <span class="ow">in</span> <span class="n">face_data</span><span class="p">:</span>
                                    <span class="n">bbox_2d</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;    2D Bounding Box: x_min=</span><span class="si">{</span><span class="n">bbox_2d</span><span class="p">[</span><span class="s1">&#39;x_min&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, y_min=</span><span class="si">{</span><span class="n">bbox_2d</span><span class="p">[</span><span class="s1">&#39;y_min&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, x_max=</span><span class="si">{</span><span class="n">bbox_2d</span><span class="p">[</span><span class="s1">&#39;x_max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, y_max=</span><span class="si">{</span><span class="n">bbox_2d</span><span class="p">[</span><span class="s1">&#39;y_max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>

                                <span class="c1"># Add 3D bounding box info if available</span>
                                <span class="k">if</span> <span class="s2">&quot;bbox_3d&quot;</span> <span class="ow">in</span> <span class="n">face_data</span><span class="p">:</span>
                                    <span class="n">bbox_3d</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;bbox_3d&quot;</span><span class="p">]</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    3D Bounding Box: </span><span class="si">{</span><span class="n">bbox_3d</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  No faces selected for this object.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coordinate data saved to: </span><span class="si">{</span><span class="n">coord_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving coordinate data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span></div>


<div class="viewcode-block" id="BaseGenerator.select_faces_by_camera_proximity">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.select_faces_by_camera_proximity">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_faces_by_camera_proximity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visible_faces</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select faces based on camera proximity using nearest point distance.</span>
<span class="sd">        Returns 1-2 faces: first the nearest face, then an adjacent candidate if available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">visible_faces</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Step 1: Calculate face scores for each face</span>
        <span class="n">face_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">visible_faces</span><span class="p">:</span>
            <span class="n">face_corners</span> <span class="o">=</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;face_corners_3d&quot;</span><span class="p">]</span>

            <span class="c1"># Calculate distance from camera to each corner</span>
            <span class="n">corner_distances</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">face_corners</span><span class="p">:</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">cam_obj</span><span class="o">.</span><span class="n">location</span> <span class="o">-</span> <span class="n">corner</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
                <span class="n">corner_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>

            <span class="c1"># Calculate multiple metrics for better face selection</span>
            <span class="n">nearest_distance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">corner_distances</span><span class="p">)</span>
            <span class="n">avg_distance</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">corner_distances</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">corner_distances</span><span class="p">)</span>

            <span class="c1"># Count corners within reasonable distance (within 1.5x of nearest)</span>
            <span class="n">close_corners</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="mi">1</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">corner_distances</span> <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="n">nearest_distance</span> <span class="o">*</span> <span class="mf">1.5</span>
            <span class="p">)</span>

            <span class="c1"># Calculate face score: prioritize faces with more close corners and better average distance</span>
            <span class="c1"># Lower score is better (closer to camera)</span>
            <span class="n">face_score</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">nearest_distance</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">avg_distance</span> <span class="o">-</span> <span class="n">nearest_distance</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span>
                <span class="o">-</span> <span class="n">close_corners</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="p">)</span>

            <span class="n">face_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">face_score</span><span class="p">,</span> <span class="n">nearest_distance</span><span class="p">,</span> <span class="n">avg_distance</span><span class="p">,</span> <span class="n">corner_distances</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Step 2: Check if we have any valid faces</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">face_scores</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid faces found for selection&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Sort by face score (lower is better)</span>
        <span class="n">face_scores</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Step 3: Select the face with the best score</span>
        <span class="n">selected_faces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">primary_face</span> <span class="o">=</span> <span class="n">face_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">selected_faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primary_face</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Selected primary face: </span><span class="si">{</span><span class="n">primary_face</span><span class="p">[</span><span class="s1">&#39;face_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (score: </span><span class="si">{</span><span class="n">face_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, nearest: </span><span class="si">{</span><span class="n">face_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Step 4: Look for adjacent candidates (left/right)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">adjacent_candidates</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="p">(</span>
                <span class="n">face</span><span class="p">,</span>
                <span class="n">face_score</span><span class="p">,</span>
                <span class="n">nearest_distance</span><span class="p">,</span>
                <span class="n">avg_distance</span><span class="p">,</span>
                <span class="n">corner_distances</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="n">face_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="c1"># Check if this face is adjacent to the primary face</span>
                <span class="n">is_adjacent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_faces_adjacent</span><span class="p">(</span><span class="n">primary_face</span><span class="p">,</span> <span class="n">face</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_adjacent</span><span class="p">:</span>
                    <span class="c1"># Use the face score for adjacent candidate selection</span>
                    <span class="n">adjacent_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">face</span><span class="p">,</span>
                            <span class="n">face_score</span><span class="p">,</span>
                            <span class="n">nearest_distance</span><span class="p">,</span>
                            <span class="n">avg_distance</span><span class="p">,</span>
                            <span class="n">corner_distances</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># Step 5: Select the best adjacent candidate based on face score</span>
            <span class="k">if</span> <span class="n">adjacent_candidates</span><span class="p">:</span>
                <span class="c1"># Sort by face score (lower is better)</span>
                <span class="n">adjacent_candidates</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">best_adjacent</span> <span class="o">=</span> <span class="n">adjacent_candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Check if the adjacent candidate has sufficient 2D surface area and is not behind primary</span>
                <span class="n">surface_quality_good</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_2d_surface_quality</span><span class="p">(</span>
                    <span class="n">best_adjacent</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="n">not_behind_primary</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_face_behind_primary</span><span class="p">(</span>
                    <span class="n">primary_face</span><span class="p">,</span> <span class="n">best_adjacent</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">surface_quality_good</span> <span class="ow">and</span> <span class="n">not_behind_primary</span><span class="p">:</span>
                    <span class="n">selected_faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_adjacent</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Selected adjacent face: </span><span class="si">{</span><span class="n">best_adjacent</span><span class="p">[</span><span class="s1">&#39;face_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (score: </span><span class="si">{</span><span class="n">adjacent_candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, nearest: </span><span class="si">{</span><span class="n">adjacent_candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">surface_quality_good</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Adjacent candidate </span><span class="si">{</span><span class="n">best_adjacent</span><span class="p">[</span><span class="s1">&#39;face_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> rejected due to poor 2D surface quality&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">not_behind_primary</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Adjacent candidate </span><span class="si">{</span><span class="n">best_adjacent</span><span class="p">[</span><span class="s1">&#39;face_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> rejected because it&#39;s behind the primary face&quot;</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fallback: Try to find adjacent faces without 2D middle view check</span>
                <span class="n">fallback_candidates</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="p">(</span>
                    <span class="n">face</span><span class="p">,</span>
                    <span class="n">face_score</span><span class="p">,</span>
                    <span class="n">nearest_distance</span><span class="p">,</span>
                    <span class="n">avg_distance</span><span class="p">,</span>
                    <span class="n">corner_distances</span><span class="p">,</span>
                <span class="p">)</span> <span class="ow">in</span> <span class="n">face_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="c1"># Check only geometric adjacency (skip 2D middle view check)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_geometric_adjacency_only</span><span class="p">(</span><span class="n">primary_face</span><span class="p">,</span> <span class="n">face</span><span class="p">):</span>
                        <span class="n">fallback_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">face</span><span class="p">,</span>
                                <span class="n">face_score</span><span class="p">,</span>
                                <span class="n">nearest_distance</span><span class="p">,</span>
                                <span class="n">avg_distance</span><span class="p">,</span>
                                <span class="n">corner_distances</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                <span class="k">if</span> <span class="n">fallback_candidates</span><span class="p">:</span>
                    <span class="c1"># Sort by face score (lower is better)</span>
                    <span class="n">fallback_candidates</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">best_fallback</span> <span class="o">=</span> <span class="n">fallback_candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Check if the fallback candidate has sufficient 2D surface area and is not behind primary</span>
                    <span class="n">surface_quality_good</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_2d_surface_quality</span><span class="p">(</span>
                        <span class="n">best_fallback</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">)</span>

                    <span class="n">not_behind_primary</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_face_behind_primary</span><span class="p">(</span>
                        <span class="n">primary_face</span><span class="p">,</span> <span class="n">best_fallback</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">surface_quality_good</span> <span class="ow">and</span> <span class="n">not_behind_primary</span><span class="p">:</span>
                        <span class="n">selected_faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_fallback</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Selected fallback adjacent face: </span><span class="si">{</span><span class="n">best_fallback</span><span class="p">[</span><span class="s1">&#39;face_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (score: </span><span class="si">{</span><span class="n">fallback_candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">surface_quality_good</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Fallback candidate </span><span class="si">{</span><span class="n">best_fallback</span><span class="p">[</span><span class="s1">&#39;face_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> rejected due to poor 2D surface quality&quot;</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">not_behind_primary</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Fallback candidate </span><span class="si">{</span><span class="n">best_fallback</span><span class="p">[</span><span class="s1">&#39;face_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> rejected because it&#39;s behind the primary face&quot;</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;No valid adjacent candidates found, using only primary face&quot;</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">selected_faces</span></div>


<div class="viewcode-block" id="BaseGenerator.check_faces_adjacent">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.check_faces_adjacent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_faces_adjacent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face1</span><span class="p">,</span> <span class="n">face2</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if two faces are truly adjacent (side-by-side), NEVER parallel.</span>
<span class="sd">        Uses strict geometric analysis to ensure only side-by-side faces are selected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># STRICT RULE: Only allow adjacent faces, never parallel ones</span>

        <span class="c1"># Method 1: Check face indices - only allow specific adjacent pairs</span>
        <span class="n">face1_idx</span> <span class="o">=</span> <span class="n">face1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">face2_idx</span> <span class="o">=</span> <span class="n">face2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Define ONLY the allowed adjacent pairs (side-by-side, never parallel)</span>
        <span class="c1"># These are the only combinations that represent truly adjacent faces</span>
        <span class="n">allowed_adjacent_pairs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Front-Left</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>  <span class="c1"># Front-Right</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Back-Left</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>  <span class="c1"># Back-Right</span>
        <span class="p">]</span>

        <span class="c1"># Check if this is an allowed adjacent pair</span>
        <span class="n">is_allowed_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">face1_idx</span><span class="p">,</span> <span class="n">face2_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="n">allowed_adjacent_pairs</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">face2_idx</span><span class="p">,</span>
            <span class="n">face1_idx</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">allowed_adjacent_pairs</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_allowed_pair</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Method 2: Verify they share exactly 2 corners (geometric validation)</span>
        <span class="n">face1_corners</span> <span class="o">=</span> <span class="n">face1</span><span class="p">[</span><span class="s2">&quot;face_corners_3d&quot;</span><span class="p">]</span>
        <span class="n">face2_corners</span> <span class="o">=</span> <span class="n">face2</span><span class="p">[</span><span class="s2">&quot;face_corners_3d&quot;</span><span class="p">]</span>

        <span class="n">shared_corners</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">corner1</span> <span class="ow">in</span> <span class="n">face1_corners</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">corner2</span> <span class="ow">in</span> <span class="n">face2_corners</span><span class="p">:</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">corner1</span> <span class="o">-</span> <span class="n">corner2</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
                <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                    <span class="n">shared_corners</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>

        <span class="c1"># Adjacent faces should share exactly 2 corners (the edge between them)</span>
        <span class="k">if</span> <span class="n">shared_corners</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Method 3: Check 2D box middle view (50% of box size)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_2d_middle_view</span><span class="p">(</span><span class="n">face1</span><span class="p">,</span> <span class="n">face2</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseGenerator.check_2d_middle_view">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.check_2d_middle_view">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_2d_middle_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face1</span><span class="p">,</span> <span class="n">face2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if both faces are in the middle view of the 2D bounding box.</span>
<span class="sd">        Middle view = within 50% of the box size from center.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bbox1</span> <span class="o">=</span> <span class="n">face1</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>
        <span class="n">bbox2</span> <span class="o">=</span> <span class="n">face2</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>

        <span class="c1"># Calculate center of each face&#39;s 2D bounding box</span>
        <span class="n">center1_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox1</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox1</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">center1_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox1</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox1</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">center2_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox2</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox2</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">center2_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox2</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox2</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># Calculate the combined bounding box</span>
        <span class="n">combined_x_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bbox1</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">])</span>
        <span class="n">combined_x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bbox1</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">])</span>
        <span class="n">combined_y_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bbox1</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">])</span>
        <span class="n">combined_y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bbox1</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">],</span> <span class="n">bbox2</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">])</span>

        <span class="c1"># Calculate center of combined box</span>
        <span class="n">combined_center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">combined_x_min</span> <span class="o">+</span> <span class="n">combined_x_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">combined_center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">combined_y_min</span> <span class="o">+</span> <span class="n">combined_y_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># Calculate 50% margins from center (increased from 30% to be less restrictive)</span>
        <span class="n">box_width</span> <span class="o">=</span> <span class="n">combined_x_max</span> <span class="o">-</span> <span class="n">combined_x_min</span>
        <span class="n">box_height</span> <span class="o">=</span> <span class="n">combined_y_max</span> <span class="o">-</span> <span class="n">combined_y_min</span>
        <span class="n">margin_x</span> <span class="o">=</span> <span class="n">box_width</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">margin_y</span> <span class="o">=</span> <span class="n">box_height</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="c1"># Check if both face centers are within 50% of the combined box center</span>
        <span class="n">face1_in_middle</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">center1_x</span> <span class="o">-</span> <span class="n">combined_center_x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">margin_x</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">center1_y</span> <span class="o">-</span> <span class="n">combined_center_y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">margin_y</span>
        <span class="p">)</span>
        <span class="n">face2_in_middle</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">center2_x</span> <span class="o">-</span> <span class="n">combined_center_x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">margin_x</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">center2_y</span> <span class="o">-</span> <span class="n">combined_center_y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">margin_y</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">face1_in_middle</span> <span class="ow">and</span> <span class="n">face2_in_middle</span></div>


<div class="viewcode-block" id="BaseGenerator.check_geometric_adjacency_only">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.check_geometric_adjacency_only">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_geometric_adjacency_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face1</span><span class="p">,</span> <span class="n">face2</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if two faces are geometrically adjacent (only geometric validation, no 2D check).</span>
<span class="sd">        This is used as a fallback when the full adjacency check fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Method 1: Check face indices - only allow specific adjacent pairs</span>
        <span class="n">face1_idx</span> <span class="o">=</span> <span class="n">face1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">face2_idx</span> <span class="o">=</span> <span class="n">face2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Define ONLY the allowed adjacent pairs (side-by-side, never parallel)</span>
        <span class="n">allowed_adjacent_pairs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Front-Left</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>  <span class="c1"># Front-Right</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Back-Left</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>  <span class="c1"># Back-Right</span>
        <span class="p">]</span>

        <span class="c1"># Check if this is an allowed adjacent pair</span>
        <span class="n">is_allowed_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">face1_idx</span><span class="p">,</span> <span class="n">face2_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="n">allowed_adjacent_pairs</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">face2_idx</span><span class="p">,</span>
            <span class="n">face1_idx</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">allowed_adjacent_pairs</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_allowed_pair</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Method 2: Verify they share exactly 2 corners (geometric validation)</span>
        <span class="n">face1_corners</span> <span class="o">=</span> <span class="n">face1</span><span class="p">[</span><span class="s2">&quot;face_corners_3d&quot;</span><span class="p">]</span>
        <span class="n">face2_corners</span> <span class="o">=</span> <span class="n">face2</span><span class="p">[</span><span class="s2">&quot;face_corners_3d&quot;</span><span class="p">]</span>

        <span class="n">shared_corners</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">corner1</span> <span class="ow">in</span> <span class="n">face1_corners</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">corner2</span> <span class="ow">in</span> <span class="n">face2_corners</span><span class="p">:</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">corner1</span> <span class="o">-</span> <span class="n">corner2</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
                <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                    <span class="n">shared_corners</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>

        <span class="c1"># Adjacent faces should share exactly 2 corners (the edge between them)</span>
        <span class="k">return</span> <span class="n">shared_corners</span> <span class="o">==</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="BaseGenerator.check_2d_surface_quality">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.check_2d_surface_quality">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_2d_surface_quality</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">face</span><span class="p">,</span>
        <span class="n">image_width</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
        <span class="n">image_height</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span>
        <span class="n">min_area</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>  <span class="c1"># Reduced from 5000 to 2000 for more permissive selection</span>
        <span class="n">min_width</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>  <span class="c1"># Reduced from 50 to 30</span>
        <span class="n">min_height</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>  <span class="c1"># Reduced from 50 to 30</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a face has sufficient 2D surface quality to be selected as a candidate.</span>

<span class="sd">        Args:</span>
<span class="sd">            face: Face data containing bbox_2d</span>
<span class="sd">            image_width: Width of the rendered image</span>
<span class="sd">            image_height: Height of the rendered image</span>
<span class="sd">            min_area: Minimum 2D bounding box area in pixels</span>
<span class="sd">            min_width: Minimum width in pixels</span>
<span class="sd">            min_height: Minimum height in pixels</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the face has good 2D surface quality, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>

        <span class="c1"># Calculate 2D bounding box dimensions</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span>

        <span class="c1"># Check minimum requirements</span>
        <span class="n">has_sufficient_area</span> <span class="o">=</span> <span class="n">area</span> <span class="o">&gt;=</span> <span class="n">min_area</span>
        <span class="n">has_sufficient_width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">&gt;=</span> <span class="n">min_width</span>
        <span class="n">has_sufficient_height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="n">min_height</span>

        <span class="c1"># Additional check: ensure the face is not too skewed (aspect ratio check)</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">has_reasonable_aspect_ratio</span> <span class="o">=</span> <span class="n">aspect_ratio</span> <span class="o">&lt;=</span> <span class="mf">10.0</span>  <span class="c1"># Not too elongated</span>

        <span class="c1"># Check if face is not too close to image edges (indicating partial visibility)</span>
        <span class="n">margin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="mi">50</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">image_width</span><span class="p">,</span> <span class="n">image_height</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span>
        <span class="p">)</span>  <span class="c1"># 5% of smaller dimension or 50px max</span>

        <span class="n">not_too_close_to_edges</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">margin</span>
            <span class="ow">and</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">image_width</span> <span class="o">-</span> <span class="n">margin</span>
            <span class="ow">and</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">margin</span>
            <span class="ow">and</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">image_height</span> <span class="o">-</span> <span class="n">margin</span>
        <span class="p">)</span>

        <span class="n">quality_good</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">has_sufficient_area</span>
            <span class="ow">and</span> <span class="n">has_sufficient_width</span>
            <span class="ow">and</span> <span class="n">has_sufficient_height</span>
            <span class="ow">and</span> <span class="n">has_reasonable_aspect_ratio</span>
            <span class="ow">and</span> <span class="n">not_too_close_to_edges</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">quality_good</span></div>


<div class="viewcode-block" id="BaseGenerator.check_face_behind_primary">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.check_face_behind_primary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_face_behind_primary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primary_face</span><span class="p">,</span> <span class="n">candidate_face</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the candidate face has points between the primary face&#39;s points,</span>
<span class="sd">        which indicates the candidate is behind the camera view.</span>

<span class="sd">        Args:</span>
<span class="sd">            primary_face: The primary selected face</span>
<span class="sd">            candidate_face: The candidate face to check</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if candidate is behind primary (should be eliminated), False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">primary_bbox</span> <span class="o">=</span> <span class="n">primary_face</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>
        <span class="n">candidate_bbox</span> <span class="o">=</span> <span class="n">candidate_face</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>

        <span class="c1"># Get the primary face&#39;s bounding box coordinates</span>
        <span class="n">primary_x_min</span><span class="p">,</span> <span class="n">primary_x_max</span> <span class="o">=</span> <span class="n">primary_bbox</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span> <span class="n">primary_bbox</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">]</span>
        <span class="n">primary_y_min</span><span class="p">,</span> <span class="n">primary_y_max</span> <span class="o">=</span> <span class="n">primary_bbox</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span> <span class="n">primary_bbox</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">]</span>

        <span class="c1"># Get the candidate face&#39;s bounding box coordinates</span>
        <span class="n">candidate_x_min</span><span class="p">,</span> <span class="n">candidate_x_max</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">candidate_bbox</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span>
            <span class="n">candidate_bbox</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">candidate_y_min</span><span class="p">,</span> <span class="n">candidate_y_max</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">candidate_bbox</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span>
            <span class="n">candidate_bbox</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Check if candidate&#39;s center is between primary&#39;s bounds</span>
        <span class="n">candidate_center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">candidate_x_min</span> <span class="o">+</span> <span class="n">candidate_x_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">candidate_center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">candidate_y_min</span> <span class="o">+</span> <span class="n">candidate_y_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># Check if candidate center is within primary face bounds</span>
        <span class="n">center_between_primary</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">primary_x_min</span> <span class="o">&lt;=</span> <span class="n">candidate_center_x</span> <span class="o">&lt;=</span> <span class="n">primary_x_max</span>
            <span class="ow">and</span> <span class="n">primary_y_min</span> <span class="o">&lt;=</span> <span class="n">candidate_center_y</span> <span class="o">&lt;=</span> <span class="n">primary_y_max</span>
        <span class="p">)</span>

        <span class="c1"># Check if candidate overlaps significantly with primary (indicating it&#39;s behind)</span>
        <span class="n">overlap_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidate_x_max</span><span class="p">,</span> <span class="n">primary_x_max</span><span class="p">)</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">candidate_x_min</span><span class="p">,</span> <span class="n">primary_x_min</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">overlap_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidate_y_max</span><span class="p">,</span> <span class="n">primary_y_max</span><span class="p">)</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">candidate_y_min</span><span class="p">,</span> <span class="n">primary_y_min</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">overlap_area</span> <span class="o">=</span> <span class="n">overlap_x</span> <span class="o">*</span> <span class="n">overlap_y</span>

        <span class="c1"># Calculate candidate area</span>
        <span class="n">candidate_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">candidate_x_max</span> <span class="o">-</span> <span class="n">candidate_x_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">candidate_y_max</span> <span class="o">-</span> <span class="n">candidate_y_min</span>
        <span class="p">)</span>

        <span class="c1"># If overlap is more than 50% of candidate area, it&#39;s likely behind (increased from 30% to 50% for more permissive selection)</span>
        <span class="n">overlap_ratio</span> <span class="o">=</span> <span class="n">overlap_area</span> <span class="o">/</span> <span class="n">candidate_area</span> <span class="k">if</span> <span class="n">candidate_area</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">significant_overlap</span> <span class="o">=</span> <span class="n">overlap_ratio</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

        <span class="c1"># Check if candidate is completely contained within primary bounds</span>
        <span class="n">completely_contained</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">primary_x_min</span> <span class="o">&lt;=</span> <span class="n">candidate_x_min</span>
            <span class="ow">and</span> <span class="n">candidate_x_max</span> <span class="o">&lt;=</span> <span class="n">primary_x_max</span>
            <span class="ow">and</span> <span class="n">primary_y_min</span> <span class="o">&lt;=</span> <span class="n">candidate_y_min</span>
            <span class="ow">and</span> <span class="n">candidate_y_max</span> <span class="o">&lt;=</span> <span class="n">primary_y_max</span>
        <span class="p">)</span>

        <span class="n">is_behind</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">center_between_primary</span> <span class="ow">or</span> <span class="n">significant_overlap</span> <span class="ow">or</span> <span class="n">completely_contained</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">is_behind</span></div>


<div class="viewcode-block" id="BaseGenerator.detect_overlapping_keypoints">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.detect_overlapping_keypoints">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">detect_overlapping_keypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_keypoints</span><span class="p">,</span> <span class="n">keypoints_data</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detect keypoints that are overlapping (within threshold pixels).</span>
<span class="sd">        Returns groups of overlapping keypoints with face data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">overlap_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">kp1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_keypoints</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">processed</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kp1</span><span class="p">[</span><span class="s2">&quot;kp&quot;</span><span class="p">][</span><span class="s2">&quot;position_2d&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">kp1</span><span class="p">[</span><span class="s2">&quot;kp&quot;</span><span class="p">][</span><span class="s2">&quot;position_2d&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">x1</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">group</span> <span class="o">=</span> <span class="p">[</span><span class="n">kp1</span><span class="p">]</span>
            <span class="n">processed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">kp2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_keypoints</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">processed</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kp2</span><span class="p">[</span><span class="s2">&quot;kp&quot;</span><span class="p">][</span><span class="s2">&quot;position_2d&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">kp2</span><span class="p">[</span><span class="s2">&quot;kp&quot;</span><span class="p">][</span><span class="s2">&quot;position_2d&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">x2</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">distance</span> <span class="o">=</span> <span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
                <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kp2</span><span class="p">)</span>
                    <span class="n">processed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Add face_data to each keypoint in the group</span>
                <span class="n">enhanced_group</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">kp_item</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                    <span class="n">face_idx</span> <span class="o">=</span> <span class="n">kp_item</span><span class="p">[</span><span class="s2">&quot;face_idx&quot;</span><span class="p">]</span>
                    <span class="n">face_data</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">keypoints_data</span><span class="p">[</span><span class="n">face_idx</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">face_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">keypoints_data</span><span class="p">)</span>
                        <span class="k">else</span> <span class="p">{}</span>
                    <span class="p">)</span>
                    <span class="n">enhanced_item</span> <span class="o">=</span> <span class="n">kp_item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">enhanced_item</span><span class="p">[</span><span class="s2">&quot;face_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">face_data</span>
                    <span class="n">enhanced_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enhanced_item</span><span class="p">)</span>
                <span class="n">overlap_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enhanced_group</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">overlap_groups</span></div>


<div class="viewcode-block" id="BaseGenerator.draw_overlapping_keypoint_circles">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.draw_overlapping_keypoint_circles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">draw_overlapping_keypoint_circles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">overlap_group</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw overlapping keypoints with both colors (one inside the other).</span>
<span class="sd">        The face with smaller perimeter gets the inner color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sort overlap group by face index for consistent ordering</span>
        <span class="n">overlap_group</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;face_idx&quot;</span><span class="p">])</span>

        <span class="c1"># Calculate perimeters for each face in the overlap group</span>
        <span class="n">face_perimeters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group_item</span> <span class="ow">in</span> <span class="n">overlap_group</span><span class="p">:</span>
            <span class="n">face_idx</span> <span class="o">=</span> <span class="n">group_item</span><span class="p">[</span><span class="s2">&quot;face_idx&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">face_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">face_perimeters</span><span class="p">:</span>
                <span class="c1"># Calculate face perimeter from bbox_2d</span>
                <span class="n">face_data</span> <span class="o">=</span> <span class="n">group_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_data&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">bbox</span> <span class="o">=</span> <span class="n">face_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="n">bbox</span><span class="p">:</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_max&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_min&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_max&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_min&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">face_perimeters</span><span class="p">[</span><span class="n">face_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">face_perimeters</span><span class="p">[</span><span class="n">face_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Sort by perimeter (smaller perimeter = inner circle)</span>
        <span class="n">sorted_faces</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">overlap_group</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">face_perimeters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;face_idx&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Draw outer circle (larger perimeter)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_faces</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">outer_face</span> <span class="o">=</span> <span class="n">sorted_faces</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Largest perimeter</span>
            <span class="n">outer_color</span> <span class="o">=</span> <span class="n">outer_face</span><span class="p">[</span><span class="s2">&quot;face_color&quot;</span><span class="p">]</span>
            <span class="n">outer_radius</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">x</span> <span class="o">-</span> <span class="n">outer_radius</span><span class="p">,</span>
                    <span class="n">y</span> <span class="o">-</span> <span class="n">outer_radius</span><span class="p">,</span>
                    <span class="n">x</span> <span class="o">+</span> <span class="n">outer_radius</span><span class="p">,</span>
                    <span class="n">y</span> <span class="o">+</span> <span class="n">outer_radius</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">fill</span><span class="o">=</span><span class="n">outer_color</span><span class="p">,</span>
                <span class="n">outline</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Draw inner circle (smaller perimeter)</span>
            <span class="n">inner_face</span> <span class="o">=</span> <span class="n">sorted_faces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Smallest perimeter</span>
            <span class="n">inner_color</span> <span class="o">=</span> <span class="n">inner_face</span><span class="p">[</span><span class="s2">&quot;face_color&quot;</span><span class="p">]</span>
            <span class="n">inner_radius</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">x</span> <span class="o">-</span> <span class="n">inner_radius</span><span class="p">,</span>
                    <span class="n">y</span> <span class="o">-</span> <span class="n">inner_radius</span><span class="p">,</span>
                    <span class="n">x</span> <span class="o">+</span> <span class="n">inner_radius</span><span class="p">,</span>
                    <span class="n">y</span> <span class="o">+</span> <span class="n">inner_radius</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">fill</span><span class="o">=</span><span class="n">inner_color</span><span class="p">,</span>
                <span class="n">outline</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback: just draw one circle</span>
            <span class="n">face_color</span> <span class="o">=</span> <span class="n">overlap_group</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;face_color&quot;</span><span class="p">]</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span>
                <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">radius</span><span class="p">],</span>
                <span class="n">fill</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
                <span class="n">outline</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="BaseGenerator.draw_single_keypoint_labels">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.draw_single_keypoint_labels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">draw_single_keypoint_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">color_text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw labels for a single keypoint.&quot;&quot;&quot;</span>
        <span class="c1"># Draw keypoint name</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">kp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">w_txt</span><span class="p">,</span> <span class="n">h_txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_wh</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">h_txt</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">label</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="n">color_text</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Draw 3D coordinates if enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keypoints_show_3d_labels&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">pos_3d</span> <span class="o">=</span> <span class="n">kp</span><span class="p">[</span><span class="s2">&quot;position_3d&quot;</span><span class="p">]</span>
            <span class="n">coord_3d_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;3D: (</span><span class="si">{</span><span class="n">pos_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pos_3d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pos_3d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">w_3d</span><span class="p">,</span> <span class="n">h_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_wh</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">coord_3d_text</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h_txt</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">coord_3d_text</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Orange color for 3D coordinates</span>
                <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Draw 2D coordinates if enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keypoints_show_2d_labels&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">pos_2d</span> <span class="o">=</span> <span class="n">kp</span><span class="p">[</span><span class="s2">&quot;position_2d&quot;</span><span class="p">]</span>
            <span class="n">coord_2d_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;2D: (</span><span class="si">{</span><span class="n">pos_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pos_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">w_2d</span><span class="p">,</span> <span class="n">h_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_wh</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">coord_2d_text</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>
            <span class="n">y_offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h_txt</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keypoints_show_3d_labels&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">y_offset</span> <span class="o">+=</span> <span class="n">h_3d</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># Offset below 3D coordinates</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">),</span>
                <span class="n">coord_2d_text</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>  <span class="c1"># Cyan color for 2D coordinates</span>
                <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="BaseGenerator.draw_overlapping_keypoint_labels">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.draw_overlapping_keypoint_labels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">draw_overlapping_keypoint_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">overlap_group</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw stacked labels for overlapping keypoints.&quot;&quot;&quot;</span>
        <span class="c1"># Sort overlap group by face index for consistent ordering</span>
        <span class="n">overlap_group</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;face_idx&quot;</span><span class="p">])</span>

        <span class="n">y_offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">radius</span> <span class="o">-</span> <span class="mi">5</span>  <span class="c1"># Start above the keypoint</span>

        <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">group_item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">overlap_group</span><span class="p">):</span>
            <span class="n">group_kp</span> <span class="o">=</span> <span class="n">group_item</span><span class="p">[</span><span class="s2">&quot;kp&quot;</span><span class="p">]</span>
            <span class="n">face_color</span> <span class="o">=</span> <span class="n">group_item</span><span class="p">[</span><span class="s2">&quot;face_color&quot;</span><span class="p">]</span>
            <span class="n">face_name</span> <span class="o">=</span> <span class="n">group_item</span><span class="p">[</span><span class="s2">&quot;face_name&quot;</span><span class="p">]</span>

            <span class="c1"># Draw face name and keypoint name</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">face_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">group_kp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">w_txt</span><span class="p">,</span> <span class="n">h_txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_wh</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>

            <span class="c1"># Draw background rectangle for better visibility</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">x</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">y_offset</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">x</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_txt</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
                    <span class="n">y_offset</span> <span class="o">+</span> <span class="n">h_txt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>  <span class="c1"># Semi-transparent white background</span>
                <span class="n">outline</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">),</span>
                <span class="n">label</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
                <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">y_offset</span> <span class="o">+=</span> <span class="n">h_txt</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># Move down for next label</span></div>


<div class="viewcode-block" id="BaseGenerator.calculate_face_normal">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.calculate_face_normal">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_face_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_corners_3d</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the normal vector of a face from its 4 corners.&quot;&quot;&quot;</span>
        <span class="c1"># Use first 3 corners to calculate normal</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">face_corners_3d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">face_corners_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">face_corners_3d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">face_corners_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="n">v1</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">normal</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseGenerator.generate_keypoints_for_frame">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.generate_keypoints_for_frame">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_keypoints_for_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">frame_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate keypoints for all faces detected in the current frame.&quot;&quot;&quot;</span>
        <span class="c1"># Detect faces in the scene</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_faces_in_scene</span><span class="p">(</span><span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

        <span class="c1"># Create 3D debug visualization AFTER face calculations are complete</span>
        <span class="k">if</span> <span class="n">frame_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating 3D debug visualization for frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">pallet_objects_found</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;MESH&quot;</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">pass_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="s2">&quot;pallet&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="p">):</span>
                    <span class="c1"># Skip objects that might be bottom/top faces or other non-pallet objects</span>
                    <span class="n">obj_name_lower</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">skip_word</span> <span class="ow">in</span> <span class="n">obj_name_lower</span>
                        <span class="k">for</span> <span class="n">skip_word</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;down&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;face&quot;</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping non-pallet object: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">pallet_objects_found</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Creating 3D visualization for pallet object: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="c1"># Create 3D visualization for this object with selected faces info</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">create_3d_debug_visualization_with_faces</span><span class="p">(</span>
                            <span class="n">obj</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">faces</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;3D visualization created for </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Error creating 3D visualization for </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">pallet_objects_found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No pallet objects found for 3D visualization in frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">pallet_objects_found</span><span class="si">}</span><span class="s2"> pallet objects for 3D visualization&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Only generate keypoints if enabled</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generate_keypoints&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">keypoints_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
            <span class="c1"># Generate keypoints for this face</span>
            <span class="n">keypoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_face_keypoints</span><span class="p">(</span><span class="n">face_data</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

            <span class="c1"># Add to keypoints data</span>
            <span class="n">keypoints_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;face_object&quot;</span><span class="p">:</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;face_name&quot;</span><span class="p">:</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;face_name&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;face_index&quot;</span><span class="p">:</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;face_index&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;bbox_2d&quot;</span><span class="p">:</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;bbox_3d&quot;</span><span class="p">:</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;bbox_3d&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;face_corners_3d&quot;</span><span class="p">:</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;face_corners_3d&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;keypoints&quot;</span><span class="p">:</span> <span class="n">keypoints</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Generate 2D boxes and 3D coordinates for selected faces</span>
        <span class="k">if</span> <span class="n">frame_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get image dimensions from config</span>
            <span class="n">img_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">img_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_face_2d_boxes</span><span class="p">(</span><span class="n">faces</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">img_height</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_face_3d_coordinates</span><span class="p">(</span><span class="n">faces</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">img_height</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">keypoints_data</span></div>


<div class="viewcode-block" id="BaseGenerator.generate_face_2d_boxes">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.generate_face_2d_boxes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_face_2d_boxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_faces</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">img_height</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate 2D bounding boxes for selected faces in YOLO format.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_faces</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create output file for 2D boxes in YOLO format</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;face_2d_boxes&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;frame_</span><span class="si">{</span><span class="n">frame_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">_2d_boxes.txt&quot;</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;# 2D Bounding Boxes for Selected Faces - Frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2"> (YOLO Format)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;# Format: class_id x_center y_center width height (normalized 0-1)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# Total faces: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_faces</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">face_idx</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_faces</span><span class="p">):</span>
                <span class="n">bbox_2d</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>

                <span class="n">x_min</span> <span class="o">=</span> <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span>
                <span class="n">y_min</span> <span class="o">=</span> <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span>
                <span class="n">x_max</span> <span class="o">=</span> <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">]</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">]</span>

                <span class="c1"># Convert to YOLO format (normalized center coordinates and dimensions)</span>
                <span class="n">x_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_min</span> <span class="o">+</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">img_width</span>
                <span class="n">y_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_min</span> <span class="o">+</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">img_height</span>
                <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">img_width</span>
                <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">img_height</span>

                <span class="c1"># Use face index as class_id (0, 1, 2, etc.)</span>
                <span class="n">class_id</span> <span class="o">=</span> <span class="n">face_idx</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">x_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated 2D boxes file (YOLO format): </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseGenerator.generate_face_3d_coordinates">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.generate_face_3d_coordinates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_face_3d_coordinates</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">selected_faces</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">img_height</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate 3D coordinates for selected faces in YOLO format.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_faces</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create output file for 3D coordinates in YOLO format</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;face_3d_coordinates&quot;</span><span class="p">],</span>
            <span class="sa">f</span><span class="s2">&quot;frame_</span><span class="si">{</span><span class="n">frame_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">_3d_coordinates.txt&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;# 3D Coordinates for Selected Faces - Frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2"> (YOLO Format)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;# Format: class_id x_center y_center width height kp1_x kp1_y kp1_v kp2_x kp2_y kp2_v ...</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# Total faces: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_faces</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">face_idx</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_faces</span><span class="p">):</span>
                <span class="n">face_corners_3d</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;face_corners_3d&quot;</span><span class="p">]</span>
                <span class="n">bbox_2d</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>

                <span class="c1"># Calculate 2D bounding box in YOLO format</span>
                <span class="n">x_min</span> <span class="o">=</span> <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span>
                <span class="n">y_min</span> <span class="o">=</span> <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span>
                <span class="n">x_max</span> <span class="o">=</span> <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">]</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">]</span>

                <span class="n">x_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_min</span> <span class="o">+</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">img_width</span>
                <span class="n">y_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_min</span> <span class="o">+</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">img_height</span>
                <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">img_width</span>
                <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">img_height</span>

                <span class="c1"># Use face index as class_id</span>
                <span class="n">class_id</span> <span class="o">=</span> <span class="n">face_idx</span>

                <span class="c1"># Start the line with YOLO bbox format</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">x_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Add 3D corner points as keypoints (projected to 2D)</span>
                <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">face_corners_3d</span><span class="p">:</span>
                    <span class="c1"># Project 3D point to 2D (this would need camera context, using bbox for now)</span>
                    <span class="c1"># For now, we&#39;ll use the corner positions relative to the bbox</span>
                    <span class="n">corner_x</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="k">if</span> <span class="n">x_max</span> <span class="o">&gt;</span> <span class="n">x_min</span> <span class="k">else</span> <span class="mf">0.5</span>
                    <span class="p">)</span>
                    <span class="n">corner_y</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">corner</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span> <span class="k">if</span> <span class="n">y_max</span> <span class="o">&gt;</span> <span class="n">y_min</span> <span class="k">else</span> <span class="mf">0.5</span>
                    <span class="p">)</span>
                    <span class="n">visibility</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Always visible for 3D coordinates</span>

                    <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">corner_x</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">corner_y</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">visibility</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated 3D coordinates file (YOLO format): </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseGenerator.create_interactive_3d_figure">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.create_interactive_3d_figure">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_interactive_3d_figure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">corners_3d</span><span class="p">,</span> <span class="n">camera_pos</span><span class="p">,</span> <span class="n">selected_faces</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">output_path</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an interactive 3D figure using plotly that can be opened and manipulated in a browser.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">plotly.offline</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyo</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Plotly not available for interactive 3D figures&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Create figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

        <span class="c1"># Add pallet corners</span>
        <span class="n">corner_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">corners_3d</span><span class="p">]</span>
        <span class="n">corner_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">corners_3d</span><span class="p">]</span>
        <span class="n">corner_z</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">corners_3d</span><span class="p">]</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">corner_x</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">corner_y</span><span class="p">,</span>
                <span class="n">z</span><span class="o">=</span><span class="n">corner_z</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers+text&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;circle&quot;</span><span class="p">},</span>
                <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Corner </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corners_3d</span><span class="p">))],</span>
                <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;top center&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Pallet Corners&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add camera position</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers+text&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;diamond&quot;</span><span class="p">},</span>
                <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Camera&quot;</span><span class="p">],</span>
                <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;top center&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Camera&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add lines from camera to corners</span>
        <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners_3d</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">y</span><span class="p">],</span>
                    <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="n">camera_pos</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">corner</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="s2">&quot;dash&quot;</span><span class="p">},</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Camera to Corner </span><span class="si">{</span><span class="n">_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Add selected faces</span>
        <span class="k">if</span> <span class="n">selected_faces</span><span class="p">:</span>
            <span class="n">face_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="s2">&quot;brown&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_faces</span><span class="p">):</span>
                <span class="n">face_corners_3d</span> <span class="o">=</span> <span class="n">face_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_corners_3d&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">face_corners_3d</span><span class="p">:</span>
                    <span class="n">face_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">face_corners_3d</span><span class="p">]</span>
                    <span class="n">face_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">face_corners_3d</span><span class="p">]</span>
                    <span class="n">face_z</span> <span class="o">=</span> <span class="p">[</span><span class="n">corner</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">face_corners_3d</span><span class="p">]</span>

                    <span class="c1"># Close the face by adding the first point at the end</span>
                    <span class="n">face_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">face_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">face_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                        <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                            <span class="n">x</span><span class="o">=</span><span class="n">face_x</span><span class="p">,</span>
                            <span class="n">y</span><span class="o">=</span><span class="n">face_y</span><span class="p">,</span>
                            <span class="n">z</span><span class="o">=</span><span class="n">face_z</span><span class="p">,</span>
                            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines+markers&quot;</span><span class="p">,</span>
                            <span class="n">line</span><span class="o">=</span><span class="p">{</span>
                                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">face_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors</span><span class="p">)],</span>
                                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                            <span class="p">},</span>
                            <span class="n">marker</span><span class="o">=</span><span class="p">{</span>
                                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">face_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors</span><span class="p">)],</span>
                            <span class="p">},</span>
                            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Selected Face </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">face_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;face_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;unknown&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># Update layout</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;3D Debug Visualization - Frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">scene</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;xaxis_title&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
                <span class="s2">&quot;yaxis_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;zaxis_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;aspectmode&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Save as HTML file</span>
        <span class="n">pyo</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseGenerator.generate_face_keypoints">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.generate_face_keypoints">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_face_keypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_data</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate 6 keypoints for a pallet face: 4 corners of the 3D face + 2 middle points (top and bottom center).</span>
<span class="sd">        Uses the actual face corners and calculates middle points between them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">face_corners_3d</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;face_corners_3d&quot;</span><span class="p">]</span>

        <span class="c1"># The face_corners_3d are ordered according to the face definition</span>
        <span class="c1"># Based on the face corner indices from detect_faces_in_scene:</span>
        <span class="c1"># Front face: [0, 1, 5, 4] - corners in order: bottom-left, bottom-right, top-right, top-left</span>
        <span class="c1"># Back face: [2, 3, 7, 6] - corners in order: bottom-left, bottom-right, top-right, top-left</span>
        <span class="c1"># Left face: [0, 3, 7, 4] - corners in order: bottom-left, bottom-right, top-right, top-left</span>
        <span class="c1"># Right face: [1, 2, 6, 5] - corners in order: bottom-left, bottom-right, top-right, top-left</span>

        <span class="c1"># Determine which corners are actually top/bottom based on Z coordinates</span>
        <span class="c1"># Sort corners by Z coordinate to find top and bottom pairs</span>
        <span class="n">corners_with_z</span> <span class="o">=</span> <span class="p">[(</span><span class="n">corner</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">face_corners_3d</span><span class="p">)]</span>
        <span class="n">corners_with_z</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

        <span class="c1"># Bottom corners (lower Z)</span>
        <span class="n">bottom_corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">corners_with_z</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">corners_with_z</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

        <span class="c1"># Top corners (higher Z)</span>
        <span class="n">top_corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">corners_with_z</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">corners_with_z</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

        <span class="c1"># Sort bottom and top corners by X coordinate to get left/right</span>
        <span class="n">bottom_corners</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">top_corners</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="n">bottom_left</span> <span class="o">=</span> <span class="n">bottom_corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bottom_right</span> <span class="o">=</span> <span class="n">bottom_corners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">top_left</span> <span class="o">=</span> <span class="n">top_corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">top_right</span> <span class="o">=</span> <span class="n">top_corners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Calculate middle points as exact midpoints between corner pairs</span>
        <span class="c1"># Middle top: exact midpoint between top-left and top-right corners</span>
        <span class="n">middle_top</span> <span class="o">=</span> <span class="p">(</span><span class="n">top_left</span> <span class="o">+</span> <span class="n">top_right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="c1"># Middle bottom: exact midpoint between bottom-left and bottom-right corners</span>
        <span class="n">middle_bottom</span> <span class="o">=</span> <span class="p">(</span><span class="n">bottom_left</span> <span class="o">+</span> <span class="n">bottom_right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># Define 6 keypoints: 4 corners + 2 middle points</span>
        <span class="n">keypoints_3d</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">middle_top</span><span class="p">,</span>  <span class="c1"># 0: Middle top (center of top edge)</span>
            <span class="n">middle_bottom</span><span class="p">,</span>  <span class="c1"># 1: Middle bottom (center of bottom edge)</span>
            <span class="n">top_left</span><span class="p">,</span>  <span class="c1"># 2: Top left corner</span>
            <span class="n">bottom_left</span><span class="p">,</span>  <span class="c1"># 3: Bottom left corner</span>
            <span class="n">top_right</span><span class="p">,</span>  <span class="c1"># 4: Top right corner</span>
            <span class="n">bottom_right</span><span class="p">,</span>  <span class="c1"># 5: Bottom right corner</span>
        <span class="p">]</span>

        <span class="c1"># Debug: Print keypoint information (commented out for production)</span>
        <span class="c1"># print(f&quot;Generated 6 keypoints for {face_name} face:&quot;)</span>
        <span class="c1"># for i, kp in enumerate(keypoints_3d):</span>
        <span class="c1">#     print(f&quot;  {i}: {[&#39;middle_top&#39;, &#39;middle_bottom&#39;, &#39;top_left&#39;, &#39;bottom_left&#39;, &#39;top_right&#39;, &#39;bottom_right&#39;][i]} at {kp}&quot;)</span>

        <span class="c1"># Project keypoints to 2D and check visibility</span>
        <span class="n">keypoints_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_points</span><span class="p">(</span><span class="n">keypoints_3d</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

        <span class="c1"># Check visibility for each keypoint</span>
        <span class="n">keypoints_with_visibility</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">kp_3d</span><span class="p">,</span> <span class="n">kp_2d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">keypoints_3d</span><span class="p">,</span> <span class="n">keypoints_2d</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># Check if keypoint is visible (not behind camera)</span>
            <span class="n">visible</span> <span class="o">=</span> <span class="n">kp_2d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="c1"># Additional visibility check: ray casting to see if there are obstacles</span>
            <span class="k">if</span> <span class="n">visible</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keypoints_visibility_check&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">visible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_keypoint_visibility</span><span class="p">(</span><span class="n">kp_3d</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

            <span class="n">keypoint_name</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;middle_top&quot;</span><span class="p">,</span>
                <span class="s2">&quot;middle_bottom&quot;</span><span class="p">,</span>
                <span class="s2">&quot;top_left&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bottom_left&quot;</span><span class="p">,</span>
                <span class="s2">&quot;top_right&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bottom_right&quot;</span><span class="p">,</span>
            <span class="p">][</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Debug: Print visibility information (commented out for production)</span>
            <span class="c1"># print(f&quot;    {keypoint_name}: 2D=({kp_2d[0]:.1f}, {kp_2d[1]:.1f}), visible={visible}&quot;)</span>

            <span class="n">keypoints_with_visibility</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">keypoint_name</span><span class="p">,</span>
                    <span class="s2">&quot;position_3d&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">kp_3d</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">kp_3d</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">kp_3d</span><span class="o">.</span><span class="n">z</span><span class="p">],</span>
                    <span class="s2">&quot;position_2d&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">kp_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">kp_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">],</span>  <span class="c1"># Always use actual 2D coordinates</span>
                    <span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="n">visible</span><span class="p">,</span>
                    <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="n">kp_2d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">visible</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">keypoints_with_visibility</span></div>


<div class="viewcode-block" id="BaseGenerator.check_keypoint_visibility">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.check_keypoint_visibility">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_keypoint_visibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keypoint_3d</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a keypoint is visible by performing ray casting from camera to keypoint.</span>
<span class="sd">        Returns True if no obstacles are blocking the line of sight.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get camera location</span>
            <span class="n">cam_location</span> <span class="o">=</span> <span class="n">cam_obj</span><span class="o">.</span><span class="n">location</span>

            <span class="c1"># Calculate direction from camera to keypoint</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">keypoint_3d</span> <span class="o">-</span> <span class="n">cam_location</span><span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">keypoint_3d</span> <span class="o">-</span> <span class="n">cam_location</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>

            <span class="c1"># Perform ray cast</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">matrix</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">ray_cast</span><span class="p">(</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">view_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">depsgraph</span><span class="p">,</span> <span class="n">cam_location</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span>
            <span class="p">)</span>

            <span class="c1"># If ray cast hits something before reaching the keypoint, it&#39;s occluded</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="c1"># Check if the hit object is the face itself (allow self-intersection)</span>
                <span class="k">return</span> <span class="nb">object</span> <span class="ow">and</span> <span class="nb">object</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;face&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking keypoint visibility: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Default to visible if check fails</span></div>


<div class="viewcode-block" id="BaseGenerator.save_keypoints_labels">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.base_generator.html#palletdatagenerator.modes.base_generator.BaseGenerator.save_keypoints_labels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_keypoints_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keypoints_data</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save keypoints labels in YOLO format to the keypoints_labels folder.</span>
<span class="sd">        Format: class_id x_center y_center width height kp1_x kp1_y kp1_v kp2_x kp2_y kp2_v ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keypoints_data</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">keypoints_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;keypoints&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">keypoints_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">face_data</span> <span class="ow">in</span> <span class="n">keypoints_data</span><span class="p">:</span>
                <span class="n">face_bbox</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>
                <span class="n">keypoints</span> <span class="o">=</span> <span class="n">face_data</span><span class="p">[</span><span class="s2">&quot;keypoints&quot;</span><span class="p">]</span>

                <span class="c1"># Convert bbox to YOLO format (normalized)</span>
                <span class="n">x_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">face_bbox</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">face_bbox</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">img_w</span>
                <span class="n">y_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">face_bbox</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">face_bbox</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">img_h</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">face_bbox</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">img_w</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">face_bbox</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">img_h</span>

                <span class="c1"># Write class_id (assuming face is class 0)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;0 </span><span class="si">{</span><span class="n">x_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="c1"># Add keypoints (normalized coordinates and visibility)</span>
                <span class="k">for</span> <span class="n">kp</span> <span class="ow">in</span> <span class="n">keypoints</span><span class="p">:</span>
                    <span class="c1"># Always use actual 2D coordinates, regardless of visibility</span>
                    <span class="n">kp_x</span> <span class="o">=</span> <span class="n">kp</span><span class="p">[</span><span class="s2">&quot;position_2d&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">img_w</span>
                    <span class="n">kp_y</span> <span class="o">=</span> <span class="n">kp</span><span class="p">[</span><span class="s2">&quot;position_2d&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">img_h</span>
                    <span class="n">visibility</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mi">2</span> <span class="k">if</span> <span class="n">kp</span><span class="p">[</span><span class="s2">&quot;visible&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="p">)</span>  <span class="c1"># 2 = visible, 0 = not visible</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">kp_x</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">kp_y</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">visibility</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Ibrahim Boubakri.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>