

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>palletdatagenerator.modes.warehouse &mdash; PalletDataGenerator 0.1.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=bb82b355" />

  
    <link rel="canonical" href="https://boubakriibrahim.github.io/PalletDataGenerator/_modules/palletdatagenerator/modes/warehouse.html" />
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=360bc84d"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PalletDataGenerator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#system-requirements">🚀 System Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#recommended-versions-tested-optimized">Recommended Versions (Tested &amp; Optimized)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#minimum-requirements">Minimum Requirements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#installation-methods">📦 Installation Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#method-1-pypi-installation-recommended">Method 1: PyPI Installation (Recommended)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#method-2-development-installation">Method 2: Development Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#method-3-using-the-built-in-setup-command">Method 3: Using the Built-in Setup Command</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#blender-setup">🎨 Blender Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#installing-blender">Installing Blender</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#macos">macOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#linux-ubuntu-debian">Linux (Ubuntu/Debian)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#windows">Windows</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#verifying-blender-installation">Verifying Blender Installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#virtual-environment-setup">🔧 Virtual Environment Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#creating-a-virtual-environment">Creating a Virtual Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#activating-the-virtual-environment">Activating the Virtual Environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#linux-macos">Linux/macOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#id1">Windows</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#installing-dependencies">Installing Dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#verification">🧪 Verification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#quick-test">Quick Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#blender-integration-test">Blender Integration Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#cli-test">CLI Test</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#troubleshooting">🐛 Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#common-issues">Common Issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#python-version-compatibility">1. Python Version Compatibility</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#blender-python-path-issues">2. Blender Python Path Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#gpu-issues">3. GPU Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#import-errors">4. Import Errors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#platform-specific-issues">Platform-Specific Issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#id2">macOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#linux">Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../installation.html#id3">Windows</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#next-steps">📚 Next Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#getting-help">🆘 Getting Help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#minute-quick-start">🏃‍♂️ 5-Minute Quick Start</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#step-1-create-virtual-environment">Step 1: Create Virtual Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#step-2-prepare-your-blender-scene">Step 2: Prepare Your Blender Scene</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#step-3-generate-your-first-dataset">Step 3: Generate Your First Dataset</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#with-blender-recommended">With Blender (Recommended)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#direct-python-limited">Direct Python (Limited)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#step-4-check-your-results">Step 4: Check Your Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#common-use-cases">🎯 Common Use Cases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#single-pallet-scene">Single Pallet Scene</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#warehouse-environment">Warehouse Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#with-custom-configuration">With Custom Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#understanding-the-output">📊 Understanding the Output</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#annotation-formats">Annotation Formats</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#yolo-format">YOLO Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#coco-format">COCO Format</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#cli-command-reference">🔧 CLI Command Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#basic-commands">Basic Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#generation-options">Generation Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#blender-integration">🎨 Blender Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#scene-setup-requirements">Scene Setup Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#launch-commands">Launch Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#environment-variables">Environment Variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#troubleshooting-quick-fixes">🚨 Troubleshooting Quick Fixes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#common-issues">Common Issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#no-pallet-objects-found">1. “No pallet objects found”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#module-not-found-errors">2. “Module not found” errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#gpu-not-detected">3. GPU not detected</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#empty-output-directory">4. Empty output directory</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#performance-tips">📈 Performance Tips</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#speed-optimization">Speed Optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#quality-optimization">Quality Optimization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#next-steps">🎯 Next Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#pro-tips">💡 Pro Tips</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../keypoints_generation.html">Keypoints Generation Feature</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#keypoints-layout">Keypoints Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#output-format">Output Format</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#keypoints-labels-yolo-format">Keypoints Labels (YOLO Format)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#example-keypoints-file">Example Keypoints File</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#analysis-images">Analysis Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#usage-example">Usage Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#face-detection">Face Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#visibility-detection">Visibility Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#d-debug-visualization">3D Debug Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#debug-output-structure">Debug Output Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#coordinate-files">Coordinate Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#interactive-html-figures">Interactive HTML Figures</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#debug-images">Debug Images</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#using-debug-3d-features">Using Debug 3D Features</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#interactive-html-visualization">Interactive HTML Visualization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#coordinate-analysis">Coordinate Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#example-usage">Example Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#integration-with-existing-features">Integration with Existing Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#no-keypoints-generated">No keypoints generated</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#all-keypoints-marked-as-hidden">All keypoints marked as hidden</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../keypoints_generation.html#keypoints-in-wrong-positions">Keypoints in wrong positions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../keypoints_generation.html#advanced-configuration">Advanced Configuration</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">palletdatagenerator</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/palletdatagenerator.html">palletdatagenerator package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/palletdatagenerator.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.modes.html">palletdatagenerator.modes package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/palletdatagenerator.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.blender_runner.html">palletdatagenerator.blender_runner module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.cli.html">palletdatagenerator.cli module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.config.html">palletdatagenerator.config module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.generator.html">palletdatagenerator.generator module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.utils.html">palletdatagenerator.utils module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/palletdatagenerator.html#module-palletdatagenerator">Module contents</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.html#palletdatagenerator.PalletDataGenerator"><code class="docutils literal notranslate"><span class="pre">PalletDataGenerator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.html#palletdatagenerator.DefaultConfig"><code class="docutils literal notranslate"><span class="pre">DefaultConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/palletdatagenerator.html#palletdatagenerator.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PalletDataGenerator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">palletdatagenerator.modes.warehouse</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for palletdatagenerator.modes.warehouse</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Warehouse Mode - Based on original warehouse_generator.py</span>

<span class="sd">Implements the exact forklift simulation, camera paths, and generation logic</span>
<span class="sd">from the original warehouse generator.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">bpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mathutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Euler</span><span class="p">,</span> <span class="n">Vector</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.base_generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseGenerator</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pascal_voc_writer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Writer</span> <span class="k">as</span> <span class="n">VocWriter</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">VocWriter</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="WarehouseMode">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WarehouseMode</span><span class="p">(</span><span class="n">BaseGenerator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Warehouse generation mode with forklift simulation and camera paths.</span>
<span class="sd">    Replicates the exact behavior of the original warehouse_generator.py</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WarehouseMode.__init__">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode_name</span> <span class="o">=</span> <span class="s2">&quot;warehouse&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attached_group_prefix</span> <span class="o">=</span> <span class="s2">&quot;AttachedGroup_&quot;</span></div>


<div class="viewcode-block" id="WarehouseMode.generate_frames">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.generate_frames">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main warehouse generation loop exactly as in original warehouse_generator.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🏭 Starting warehouse generation...&quot;</span><span class="p">)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Initialization</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>

        <span class="c1"># Setup camera</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span>
        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">camera</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="n">do_unlink</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">cam_data</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cameras</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;WarehouseCam&quot;</span><span class="p">)</span>
        <span class="n">cam_obj</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;WarehouseCam&quot;</span><span class="p">,</span> <span class="n">cam_data</span><span class="p">)</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">cam_obj</span><span class="p">)</span>
        <span class="n">cam_obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">lens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;camera_focal_mm&quot;</span><span class="p">]</span>
        <span class="n">cam_obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sensor_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;camera_sensor_mm&quot;</span><span class="p">]</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">cam_obj</span>

        <span class="c1"># Setup environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_environment</span><span class="p">()</span>

        <span class="c1"># Analyze scene</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔍 Analyzing warehouse scene...&quot;</span><span class="p">)</span>
        <span class="n">scene_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_warehouse_objects</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">scene_objects</span><span class="p">[</span><span class="s2">&quot;pallets&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️  WARNING: No pallets found!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Check that your objects contain &#39;pallet&#39; in their name&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;frames_generated&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No pallets found&quot;</span><span class="p">}</span>

        <span class="c1"># COCO scaffolding</span>
        <span class="n">coco_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Warehouse Realistic Dataset&quot;</span><span class="p">},</span>
            <span class="s2">&quot;licenses&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;pallet&quot;</span><span class="p">,</span> <span class="s2">&quot;supercategory&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;face&quot;</span><span class="p">,</span> <span class="s2">&quot;supercategory&quot;</span><span class="p">:</span> <span class="s2">&quot;pallet_part&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hole&quot;</span><span class="p">,</span> <span class="s2">&quot;supercategory&quot;</span><span class="p">:</span> <span class="s2">&quot;pallet_part&quot;</span><span class="p">},</span>
            <span class="p">],</span>
        <span class="p">}</span>

        <span class="n">total_images</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Main generation loop - multiple scenes</span>
        <span class="k">for</span> <span class="n">scene_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_scenes&quot;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- SCENE </span><span class="si">{</span><span class="n">scene_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_scenes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

            <span class="c1"># Clean up previously generated boxes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_generated_boxes</span><span class="p">()</span>

            <span class="c1"># Randomize scene</span>
            <span class="p">(</span>
                <span class="n">removed_objects</span><span class="p">,</span>
                <span class="n">modified_objects</span><span class="p">,</span>
                <span class="n">original_positions</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize_scene_objects</span><span class="p">(</span><span class="n">scene_objects</span><span class="p">)</span>

            <span class="c1"># Re-scan objects after adding groups</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔄 Re-scanning objects after group placement...&quot;</span><span class="p">)</span>
            <span class="n">scene_objects</span><span class="p">[</span><span class="s2">&quot;pallet_box_groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_pallet_box_relationships</span><span class="p">(</span>
                <span class="n">scene_objects</span>
            <span class="p">)</span>

            <span class="c1"># Force complete update</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">evaluated_depsgraph_get</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="c1"># Generate warehouse camera path (forklift simulation)</span>
            <span class="n">camera_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_warehouse_path</span><span class="p">(</span><span class="n">scene_objects</span><span class="p">)</span>

            <span class="c1"># Save scene before rendering (if enabled)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_scene_before_render&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_generated_scene</span><span class="p">(</span><span class="n">scene_id</span><span class="p">)</span>

            <span class="c1"># Images for this scene</span>
            <span class="n">scene_images</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_images_per_scene&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_total_images&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">total_images</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Generate images along the path</span>
            <span class="k">for</span> <span class="n">img_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">scene_images</span><span class="p">):</span>
                <span class="n">frame_id</span> <span class="o">=</span> <span class="n">total_images</span>

                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;📸 Rendering frame </span><span class="si">{</span><span class="n">frame_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_total_images&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Scene </span><span class="si">{</span><span class="n">scene_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, Image </span><span class="si">{</span><span class="n">img_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">scene_images</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="c1"># Position camera with forklift-like movement</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">img_id</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">scene_images</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position_camera_on_path</span><span class="p">(</span><span class="n">cam_obj</span><span class="p">,</span> <span class="n">camera_path</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span>

                <span class="c1"># Dynamic lighting</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">randomize_lighting</span><span class="p">()</span>

                <span class="c1"># Auto-exposure</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auto_expose_frame</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">)</span>

                <span class="c1"># Detect visible pallets</span>
                <span class="n">visible_pallets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_visible_pallets</span><span class="p">(</span><span class="n">scene_objects</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">visible_pallets</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    No pallets visible&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Render</span>
                <span class="n">img_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.png&quot;</span>
                <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">],</span> <span class="n">img_filename</span><span class="p">)</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">img_path</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">image_settings</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;PNG&quot;</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">render</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">write_still</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ✅ </span><span class="si">{</span><span class="n">img_filename</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">visible_pallets</span><span class="p">)</span><span class="si">}</span><span class="s2"> pallets&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ❌ Render error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Generate all outputs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_warehouse_frame_outputs</span><span class="p">(</span>
                    <span class="n">frame_id</span><span class="p">,</span>
                    <span class="n">img_filename</span><span class="p">,</span>
                    <span class="n">img_path</span><span class="p">,</span>
                    <span class="n">visible_pallets</span><span class="p">,</span>
                    <span class="n">cam_obj</span><span class="p">,</span>
                    <span class="n">sc</span><span class="p">,</span>
                    <span class="n">coco_data</span><span class="p">,</span>
                    <span class="n">meta</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">total_images</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">total_images</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_total_images&quot;</span><span class="p">]:</span>
                    <span class="k">break</span>

            <span class="c1"># Restore scene</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restore_scene_objects</span><span class="p">(</span><span class="n">removed_objects</span><span class="p">,</span> <span class="n">original_positions</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">total_images</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_total_images&quot;</span><span class="p">]:</span>
                <span class="k">break</span>

        <span class="c1"># Save final outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_final_outputs</span><span class="p">(</span><span class="n">coco_data</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🎉 WAREHOUSE DATASET GENERATED!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 Images generated: </span><span class="si">{</span><span class="n">total_images</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📁 Output: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;frames_generated&quot;</span><span class="p">:</span> <span class="n">total_images</span><span class="p">,</span>
            <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">],</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_name</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="WarehouseMode.find_warehouse_objects">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.find_warehouse_objects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_warehouse_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find and categorize warehouse objects by collections (object.XXX structure).&quot;&quot;&quot;</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pallets&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;boxes&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;collections&quot;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="c1"># First pass: find individual objects</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;MESH&quot;</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">visible_get</span><span class="p">():</span>
                <span class="n">name_lower</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;pallet&quot;</span> <span class="ow">in</span> <span class="n">name_lower</span><span class="p">:</span>
                    <span class="n">objects</span><span class="p">[</span><span class="s2">&quot;pallets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;box&quot;</span> <span class="ow">in</span> <span class="n">name_lower</span> <span class="ow">or</span> <span class="s2">&quot;create&quot;</span> <span class="ow">in</span> <span class="n">name_lower</span><span class="p">:</span>
                    <span class="n">objects</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">objects</span><span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># Second pass: find collection-based groups (object.XXX pattern)</span>
        <span class="n">collection_groups</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;MESH&quot;</span><span class="p">:</span>
                <span class="c1"># Look for collection-based naming patterns</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">group_id</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># Could be &quot;001&quot; or more complex</span>

                    <span class="c1"># Initialize collection group if not exists</span>
                    <span class="k">if</span> <span class="n">group_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collection_groups</span><span class="p">:</span>
                        <span class="n">collection_groups</span><span class="p">[</span><span class="n">group_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;pallets&quot;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s2">&quot;boxes&quot;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">,</span>
                        <span class="p">}</span>

                    <span class="c1"># Categorize by base name</span>
                    <span class="k">if</span> <span class="s2">&quot;pallet&quot;</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                        <span class="n">collection_groups</span><span class="p">[</span><span class="n">group_id</span><span class="p">][</span><span class="s2">&quot;pallets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;📦 Found collection pallet: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in group </span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="s2">&quot;box&quot;</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                        <span class="n">collection_groups</span><span class="p">[</span><span class="n">group_id</span><span class="p">][</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📦 Found collection box: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in group </span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">collection_groups</span><span class="p">[</span><span class="n">group_id</span><span class="p">][</span><span class="s2">&quot;other&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="n">objects</span><span class="p">[</span><span class="s2">&quot;collections&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection_groups</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📦 Found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="s1">&#39;pallets&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> individual pallets, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> individual boxes&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📦 Found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">collection_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> collection groups&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">collection_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Group </span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;pallets&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> pallets, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> boxes&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">objects</span></div>


<div class="viewcode-block" id="WarehouseMode.generate_warehouse_path">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.generate_warehouse_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_warehouse_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene_objects</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a forklift-like camera path through the warehouse.&quot;&quot;&quot;</span>
        <span class="n">pallets</span> <span class="o">=</span> <span class="n">scene_objects</span><span class="p">[</span><span class="s2">&quot;pallets&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pallets</span><span class="p">:</span>
            <span class="c1"># Fallback path</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">Vector</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">)),</span> <span class="s2">&quot;rotation&quot;</span><span class="p">:</span> <span class="n">Euler</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))},</span>
                <span class="p">{</span><span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">Vector</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">)),</span> <span class="s2">&quot;rotation&quot;</span><span class="p">:</span> <span class="n">Euler</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))},</span>
            <span class="p">]</span>

        <span class="c1"># Calculate warehouse bounds</span>
        <span class="n">all_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">location</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pallets</span><span class="p">]</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">all_positions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">all_positions</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">all_positions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">all_positions</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>

        <span class="c1"># Generate forklift path points</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">camera_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;camera_height_range&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))</span>

        <span class="c1"># Create a path that moves through the warehouse</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_total_images&quot;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">):</span>
            <span class="c1"># Forklift-like movement pattern</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">min_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">min_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">camera_height</span><span class="p">)</span>

            <span class="c1"># Add some randomness for realistic movement</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

            <span class="n">position</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>

            <span class="c1"># Look towards nearby pallets</span>
            <span class="n">look_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_nearest_pallet</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">pallets</span><span class="p">)</span>
            <span class="n">look_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">look_target</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="n">look_dir</span><span class="o">.</span><span class="n">to_track_quat</span><span class="p">(</span><span class="s2">&quot;-Z&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_euler</span><span class="p">()</span>

            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span> <span class="s2">&quot;rotation&quot;</span><span class="p">:</span> <span class="n">rotation</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">path</span></div>


<div class="viewcode-block" id="WarehouseMode.find_nearest_pallet">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.find_nearest_pallet">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_nearest_pallet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">pallets</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the nearest pallet to look at.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pallets</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Vector</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">nearest_dist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="n">nearest_pallet</span> <span class="o">=</span> <span class="n">pallets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">pallet</span> <span class="ow">in</span> <span class="n">pallets</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">pallet</span><span class="o">.</span><span class="n">location</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">nearest_dist</span><span class="p">:</span>
                <span class="n">nearest_dist</span> <span class="o">=</span> <span class="n">dist</span>
                <span class="n">nearest_pallet</span> <span class="o">=</span> <span class="n">pallet</span>

        <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="n">nearest_pallet</span><span class="o">.</span><span class="n">location</span><span class="p">)</span></div>


<div class="viewcode-block" id="WarehouseMode.position_camera_on_path">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.position_camera_on_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">position_camera_on_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">camera_path</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Position camera along the forklift path with realistic movement.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">camera_path</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Interpolate along path</span>
        <span class="n">path_index</span> <span class="o">=</span> <span class="n">progress</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">camera_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">index_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">path_index</span><span class="p">)</span>
        <span class="n">index_high</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">index_low</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">camera_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">lerp_factor</span> <span class="o">=</span> <span class="n">path_index</span> <span class="o">-</span> <span class="n">index_low</span>

        <span class="k">if</span> <span class="n">index_low</span> <span class="o">==</span> <span class="n">index_high</span><span class="p">:</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">camera_path</span><span class="p">[</span><span class="n">index_low</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">point_low</span> <span class="o">=</span> <span class="n">camera_path</span><span class="p">[</span><span class="n">index_low</span><span class="p">]</span>
            <span class="n">point_high</span> <span class="o">=</span> <span class="n">camera_path</span><span class="p">[</span><span class="n">index_high</span><span class="p">]</span>

            <span class="c1"># Interpolate position and rotation</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">point_low</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lerp</span><span class="p">(</span><span class="n">point_high</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">],</span> <span class="n">lerp_factor</span><span class="p">)</span>

            <span class="c1"># Add forklift-like jitter</span>
            <span class="n">lateral_jitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;camera_lateral_jitter_m&quot;</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
            <span class="n">yaw_jitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;camera_yaw_jitter_deg&quot;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
            <span class="n">pitch_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;camera_pitch_deg_range&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">))</span>

            <span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">lateral_jitter</span><span class="p">,</span> <span class="n">lateral_jitter</span><span class="p">)</span>
            <span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">lateral_jitter</span><span class="p">,</span> <span class="n">lateral_jitter</span><span class="p">)</span>

            <span class="n">rotation</span> <span class="o">=</span> <span class="n">point_low</span><span class="p">[</span><span class="s2">&quot;rotation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">rotation</span><span class="o">.</span><span class="n">z</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">yaw_jitter</span><span class="p">,</span> <span class="n">yaw_jitter</span><span class="p">))</span>
            <span class="n">rotation</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">pitch_range</span><span class="p">))</span>

            <span class="n">point</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span> <span class="s2">&quot;rotation&quot;</span><span class="p">:</span> <span class="n">rotation</span><span class="p">}</span>

        <span class="c1"># Apply to camera</span>
        <span class="n">cam_obj</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
        <span class="n">cam_obj</span><span class="o">.</span><span class="n">rotation_euler</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;rotation&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="WarehouseMode.randomize_scene_objects">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.randomize_scene_objects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">randomize_scene_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene_objects</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Randomize scene objects and replace hidden boxes with generated groups - collection-aware approach.&quot;&quot;&quot;</span>
        <span class="n">removed_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">modified_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">original_positions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== DÉBUT RANDOMISATION COLLECTION-AWARE ===&quot;</span><span class="p">)</span>

        <span class="c1"># Find box templates (box1, box2, box3)</span>
        <span class="n">box_templates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔍 Searching for box templates...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;MESH&quot;</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;box1&quot;</span><span class="p">,</span> <span class="s2">&quot;box2&quot;</span><span class="p">,</span> <span class="s2">&quot;box3&quot;</span><span class="p">]:</span>
                <span class="n">box_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;✅ Template found: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2"> (visible: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">visible_get</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total templates box found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">box_templates</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">box_templates</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️  WARNING: No box1, box2, box3 templates found in scene!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available mesh objects:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;MESH&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Use existing boxes as templates if no box1,box2,box3 found</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using existing boxes as templates...&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">scene_objects</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]:</span>  <span class="c1"># Use first 3 boxes as templates</span>
                <span class="n">box_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Using as template: </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">box_templates</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ CRITICAL: No box templates available at all!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">removed_objects</span><span class="p">,</span> <span class="n">modified_objects</span><span class="p">,</span> <span class="n">original_positions</span>

        <span class="c1"># Clean up previously generated boxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_generated_boxes</span><span class="p">()</span>

        <span class="c1"># Create 5 different box groups (from original)</span>
        <span class="n">group_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_5_different_box_groups</span><span class="p">(</span><span class="n">box_templates</span><span class="p">)</span>

        <span class="c1"># Process collection groups - replace hidden boxes with generated groups</span>
        <span class="n">box_removal_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;box_removal_probability&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
        <span class="n">templates_to_keep</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;box1&quot;</span><span class="p">,</span> <span class="s2">&quot;box2&quot;</span><span class="p">,</span> <span class="s2">&quot;box3&quot;</span><span class="p">}</span>

        <span class="n">replacement_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">collection_group</span> <span class="ow">in</span> <span class="n">scene_objects</span><span class="p">[</span><span class="s2">&quot;collections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🎯 Processing collection group: </span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Process boxes in this collection</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">collection_group</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">templates_to_keep</span>
                    <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">box_removal_prob</span>
                <span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  📦 Hiding box: </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">removed_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                    <span class="n">original_positions</span><span class="p">[</span><span class="n">box</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">hide_viewport</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">hide_render</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Find corresponding pallet in same collection</span>
                    <span class="n">corresponding_pallet</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">pallet</span> <span class="ow">in</span> <span class="n">collection_group</span><span class="p">[</span><span class="s2">&quot;pallets&quot;</span><span class="p">]:</span>
                        <span class="c1"># Simple matching - could be made more sophisticated</span>
                        <span class="n">corresponding_pallet</span> <span class="o">=</span> <span class="n">pallet</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="n">corresponding_pallet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;  🎯 Found corresponding pallet: </span><span class="si">{</span><span class="n">corresponding_pallet</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                        <span class="c1"># Choose random group configuration</span>
                        <span class="n">group_config</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">group_configs</span><span class="p">)</span>

                        <span class="c1"># Generate replacement group using box&#39;s original position/scale as reference</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">replacement_boxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_replacement_box_group</span><span class="p">(</span>
                                <span class="n">box</span><span class="p">,</span>
                                <span class="n">corresponding_pallet</span><span class="p">,</span>
                                <span class="n">group_config</span><span class="p">,</span>
                                <span class="n">box_templates</span><span class="p">,</span>
                                <span class="n">group_id</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">replacement_boxes</span><span class="p">:</span>
                                <span class="n">replacement_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;  ⚠️  Failed to generate replacement for </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;  ❌ Error generating replacement for </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ⚠️  No corresponding pallet found for </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Also process individual boxes (not in collections)</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">scene_objects</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">templates_to_keep</span>
                <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">box_removal_prob</span>
            <span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📦 Hiding individual box: </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">removed_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="n">original_positions</span><span class="p">[</span><span class="n">box</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">box</span><span class="o">.</span><span class="n">hide_viewport</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">box</span><span class="o">.</span><span class="n">hide_render</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Find nearest pallet for individual boxes</span>
                <span class="n">nearest_pallet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_nearest_pallet_to_box</span><span class="p">(</span>
                    <span class="n">box</span><span class="p">,</span> <span class="n">scene_objects</span><span class="p">[</span><span class="s2">&quot;pallets&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">nearest_pallet</span><span class="p">:</span>
                    <span class="n">group_config</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">group_configs</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">replacement_boxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_replacement_box_group</span><span class="p">(</span>
                            <span class="n">box</span><span class="p">,</span>
                            <span class="n">nearest_pallet</span><span class="p">,</span>
                            <span class="n">group_config</span><span class="p">,</span>
                            <span class="n">box_templates</span><span class="p">,</span>
                            <span class="s2">&quot;individual&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">replacement_boxes</span><span class="p">:</span>
                            <span class="n">replacement_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;❌ Error generating individual replacement for </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🎉 Randomization complete: </span><span class="si">{</span><span class="n">replacement_count</span><span class="si">}</span><span class="s2"> box groups generated&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">removed_objects</span><span class="p">,</span> <span class="n">modified_objects</span><span class="p">,</span> <span class="n">original_positions</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_is_box_on_pallet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">pallet</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a box is positioned on top of a pallet.&quot;&quot;&quot;</span>
        <span class="c1"># Simple distance check - box should be close to pallet XY and above it</span>
        <span class="n">pallet_loc</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">location</span>
        <span class="n">box_loc</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">location</span>

        <span class="c1"># Check if box is roughly above the pallet (within 2m XY distance and above in Z)</span>
        <span class="n">xy_distance</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">box_loc</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">pallet_loc</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">box_loc</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">pallet_loc</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">z_above</span> <span class="o">=</span> <span class="n">box_loc</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">pallet_loc</span><span class="o">.</span><span class="n">z</span>

        <span class="k">return</span> <span class="n">xy_distance</span> <span class="o">&lt;</span> <span class="mf">2.0</span> <span class="ow">and</span> <span class="n">z_above</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_5_different_box_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_templates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create 5 different box group configurations - from original warehouse generator.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔧 Creating group configurations with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">box_templates</span><span class="p">)</span><span class="si">}</span><span class="s2"> templates&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">box_templates</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ No box templates available for groups!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Configuration from original - 5 different group patterns</span>
        <span class="n">group_configs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;cols&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;stack_layers&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;stack_prob&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;cols&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;stack_layers&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="s2">&quot;stack_prob&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;cols&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;stack_layers&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;stack_prob&quot;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;cols&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s2">&quot;stack_layers&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                <span class="s2">&quot;stack_prob&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;cols&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;stack_layers&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                <span class="s2">&quot;stack_prob&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">group_configs</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;box_templates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_templates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">group_configs</span><span class="p">)</span><span class="si">}</span><span class="s2"> group configurations created&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">group_configs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_nearest_pallet_to_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">pallets</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the nearest pallet to a given box.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pallets</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">min_distance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="n">nearest_pallet</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">pallet</span> <span class="ow">in</span> <span class="n">pallets</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">location</span> <span class="o">-</span> <span class="n">pallet</span><span class="o">.</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
            <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">min_distance</span><span class="p">:</span>
                <span class="n">min_distance</span> <span class="o">=</span> <span class="n">distance</span>
                <span class="n">nearest_pallet</span> <span class="o">=</span> <span class="n">pallet</span>

        <span class="k">return</span> <span class="n">nearest_pallet</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_replacement_box_group</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">original_box</span><span class="p">,</span> <span class="n">target_pallet</span><span class="p">,</span> <span class="n">group_config</span><span class="p">,</span> <span class="n">box_templates</span><span class="p">,</span> <span class="n">group_id</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate replacement box group using EXACT original _place_box_group_on_pallet method.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;    🎯 Generating replacement group (config </span><span class="si">{</span><span class="n">group_config</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) for </span><span class="si">{</span><span class="n">original_box</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Use EXACT original method with modified collection placement</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_place_box_group_on_pallet_exact</span><span class="p">(</span>
            <span class="n">group_config</span><span class="p">,</span> <span class="n">target_pallet</span><span class="p">,</span> <span class="n">box_templates</span><span class="p">,</span> <span class="n">group_id</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_place_box_group_on_pallet_exact</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">group_data</span><span class="p">,</span> <span class="n">pallet</span><span class="p">,</span> <span class="n">box_templates</span><span class="p">,</span> <span class="n">group_id</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;EXACT copy of original _place_box_group_on_pallet but with collection-aware naming and anti-collapse measures.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">box_templates</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pallet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Templates ou palette manquants!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">boxes_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_boxes_collection_for_pallet_exact</span><span class="p">(</span>
                <span class="n">pallet</span><span class="p">,</span> <span class="n">group_id</span>
            <span class="p">)</span>

            <span class="c1"># Measures palette - EXACT from original with validation</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">world_corners</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">pallet</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">@</span> <span class="n">Vector</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pallet</span><span class="o">.</span><span class="n">bound_box</span>
                <span class="p">]</span>
                <span class="n">pallet_top_z</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">world_corners</span><span class="p">)</span>

                <span class="c1"># bornes locales (pour grille)</span>
                <span class="n">pxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pallet</span><span class="o">.</span><span class="n">bound_box</span><span class="p">]</span>
                <span class="n">pys</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pallet</span><span class="o">.</span><span class="n">bound_box</span><span class="p">]</span>
                <span class="n">pzs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pallet</span><span class="o">.</span><span class="n">bound_box</span><span class="p">]</span>
                <span class="n">pl_min_x</span><span class="p">,</span> <span class="n">pl_max_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pxs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">pxs</span><span class="p">)</span>
                <span class="n">pl_min_y</span><span class="p">,</span> <span class="n">pl_max_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">pys</span><span class="p">)</span>
                <span class="n">pl_top_z</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pzs</span><span class="p">)</span>

                <span class="c1"># Validate bounds to prevent degenerate dimensions</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pl_max_x</span> <span class="o">-</span> <span class="n">pl_min_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;⚠️ Pallet width too small: </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">pl_max_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pl_min_x</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, using fallback&quot;</span>
                    <span class="p">)</span>
                    <span class="n">pl_min_x</span><span class="p">,</span> <span class="n">pl_max_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pl_max_y</span> <span class="o">-</span> <span class="n">pl_min_y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;⚠️ Pallet depth too small: </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">pl_max_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pl_min_y</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, using fallback&quot;</span>
                    <span class="p">)</span>
                    <span class="n">pl_min_y</span><span class="p">,</span> <span class="n">pl_max_y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">pallet_top_z</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pallet</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pallet</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">))</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pallet</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span>
                <span class="n">pl_min_x</span><span class="p">,</span> <span class="n">pl_max_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">pl_min_y</span><span class="p">,</span> <span class="n">pl_max_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">d</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">pl_top_z</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># Choix grille: 2 (1x2 ou 2x1 selon axe long) ou 4 (2x2) - EXACT from original</span>
            <span class="n">top_w_local</span> <span class="o">=</span> <span class="n">pl_max_x</span> <span class="o">-</span> <span class="n">pl_min_x</span>
            <span class="n">top_d_local</span> <span class="o">=</span> <span class="n">pl_max_y</span> <span class="o">-</span> <span class="n">pl_min_y</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pallet dimensions: </span><span class="si">{</span><span class="n">top_w_local</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">top_d_local</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (local)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">top_w_local</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">top_d_local</span><span class="p">):</span>
                    <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>

            <span class="n">cell_width_local</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl_max_x</span> <span class="o">-</span> <span class="n">pl_min_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">grid_x</span>
            <span class="n">cell_depth_local</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl_max_y</span> <span class="o">-</span> <span class="n">pl_min_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">grid_y</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Grid: </span><span class="si">{</span><span class="n">grid_x</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">grid_y</span><span class="si">}</span><span class="s2">, cell size: </span><span class="si">{</span><span class="n">cell_width_local</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">cell_depth_local</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">created_objects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">obj_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">placed_positions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Track positions to prevent overlap</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_y</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_x</span><span class="p">):</span>
                    <span class="c1"># Centre de cellule en local -&gt; monde - EXACT from original</span>
                    <span class="n">local_cx</span> <span class="o">=</span> <span class="n">pl_min_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_width_local</span>
                    <span class="n">local_cy</span> <span class="o">=</span> <span class="n">pl_min_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">row</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_depth_local</span>
                    <span class="n">local_pos</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">((</span><span class="n">local_cx</span><span class="p">,</span> <span class="n">local_cy</span><span class="p">,</span> <span class="n">pl_top_z</span><span class="p">))</span>
                    <span class="n">world_pos</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">@</span> <span class="n">local_pos</span>

                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;      Cell [</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">]: local(</span><span class="si">{</span><span class="n">local_cx</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">local_cy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pl_top_z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">) → world(</span><span class="si">{</span><span class="n">world_pos</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">world_pos</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">world_pos</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>

                    <span class="n">template</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">box_templates</span><span class="p">)</span>
                    <span class="n">box</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attached_group_prefix</span><span class="si">}</span><span class="s2">G</span><span class="si">{</span><span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">obj_index</span><span class="si">}</span><span class="s2">_L0_</span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_box_to_collection_exact</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">boxes_collection</span><span class="p">)</span>

                    <span class="c1"># SAFE ORDER: Position first (world space)</span>
                    <span class="n">safe_z</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="n">pallet_top_z</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">world_pos</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="mf">0.05</span>
                    <span class="p">)</span>  <span class="c1"># Ensure above pallet</span>
                    <span class="n">initial_pos</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">((</span><span class="n">world_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">world_pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">safe_z</span><span class="p">))</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">initial_pos</span>

                    <span class="c1"># Check for overlap with existing boxes</span>
                    <span class="n">min_distance</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Minimum distance between box centers</span>
                    <span class="k">for</span> <span class="n">prev_pos</span> <span class="ow">in</span> <span class="n">placed_positions</span><span class="p">:</span>
                        <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">Vector</span><span class="p">((</span><span class="n">initial_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">initial_pos</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
                            <span class="o">-</span> <span class="n">Vector</span><span class="p">((</span><span class="n">prev_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">prev_pos</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">length</span>
                        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">min_distance</span><span class="p">:</span>
                            <span class="c1"># Adjust position to avoid overlap</span>
                            <span class="n">offset</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">((</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">col</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">row</span><span class="p">))</span>
                            <span class="n">initial_pos</span> <span class="o">+=</span> <span class="n">offset</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">initial_pos</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;      ⚠️ Overlap detected, adjusted position by </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">break</span>

                    <span class="n">placed_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">initial_pos</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Initial position: </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Orientation + scale par axe pour remplir la cellule - EXACT from original with safety</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dim_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                            <span class="mf">0.01</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
                        <span class="p">)</span>  <span class="c1"># Prevent zero dimensions</span>
                        <span class="n">dim_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>

                        <span class="c1"># 0° vs 90° (choix qui fitte le mieux)</span>
                        <span class="n">sx0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cell_width_local</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim_x</span>
                        <span class="n">sy0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cell_depth_local</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim_y</span>
                        <span class="n">sx90</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cell_width_local</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim_y</span>
                        <span class="n">sy90</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cell_depth_local</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim_x</span>

                        <span class="n">use_90</span> <span class="o">=</span> <span class="p">(</span><span class="n">sx90</span> <span class="o">*</span> <span class="n">sy90</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">sx0</span> <span class="o">*</span> <span class="n">sy0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">use_90</span><span class="p">:</span>
                            <span class="n">yaw</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">rotation_euler</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
                            <span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span> <span class="o">=</span> <span class="n">sx90</span><span class="p">,</span> <span class="n">sy90</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">yaw</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">rotation_euler</span><span class="o">.</span><span class="n">z</span>
                            <span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span> <span class="o">=</span> <span class="n">sx0</span><span class="p">,</span> <span class="n">sy0</span>

                        <span class="c1"># CONSERVATIVE scaling to prevent collapse - much tighter limits</span>
                        <span class="n">scale_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">scale_x</span><span class="p">))</span>  <span class="c1"># More conservative range</span>
                        <span class="n">scale_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">))</span>

                        <span class="c1"># Additional check: if scaling is too extreme, use moderate values</span>
                        <span class="k">if</span> <span class="n">scale_x</span> <span class="o">&gt;</span> <span class="mf">2.5</span> <span class="ow">or</span> <span class="n">scale_y</span> <span class="o">&gt;</span> <span class="mf">2.5</span><span class="p">:</span>
                            <span class="n">scale_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">scale_x</span><span class="p">)</span>
                            <span class="n">scale_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      📏 Applied conservative scaling limit&quot;</span><span class="p">)</span>

                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;      Scaling: template_dim(</span><span class="si">{</span><span class="n">dim_x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">dim_y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">) → scale(</span><span class="si">{</span><span class="n">scale_x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">scale_y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="s1">&#39;90°&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">use_90</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;0°&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      ⚠️ Scaling error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">yaw</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">rotation_euler</span><span class="o">.</span><span class="n">z</span>
                        <span class="n">scale_x</span> <span class="o">=</span> <span class="n">scale_y</span> <span class="o">=</span> <span class="mf">1.0</span>

                    <span class="c1"># SAFE ORDER: Apply scale and rotation</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">((</span><span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">rotation_euler</span> <span class="o">=</span> <span class="n">Euler</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">yaw</span><span class="p">))</span>

                    <span class="c1"># Update transforms to ensure proper dimensions calculation</span>
                    <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                    <span class="c1"># SAFE ORDER: Align bottom to pallet top with generous margin</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_align_bottom_to_z</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pallet_top_z</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;      ⚠️ Alignment error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, using manual positioning&quot;</span>
                        <span class="p">)</span>
                        <span class="c1"># Manual fallback positioning</span>
                        <span class="n">box</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pallet_top_z</span> <span class="o">+</span> <span class="mf">0.05</span>

                    <span class="c1"># Update transforms again before parenting</span>
                    <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                    <span class="c1"># SAFE ORDER: Parent while preserving world position</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_preserve_world</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pallet</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      ⚠️ Parenting error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Manual parenting fallback</span>
                        <span class="n">box</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">pallet</span>

                    <span class="c1"># Final update and visibility</span>
                    <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">hide_viewport</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">hide_render</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="n">created_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                    <span class="n">obj_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Final scene update</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  🎯 Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_objects</span><span class="p">)</span><span class="si">}</span><span class="s2"> boxes with anti-collapse measures&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">created_objects</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur placement (exact method): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_boxes_collection_for_pallet_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pallet</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create collection for pallet boxes - adapted for collection-aware structure.&quot;&quot;&quot;</span>
        <span class="n">collection_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;boxes_group_</span><span class="si">{</span><span class="n">pallet</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Check if collection exists</span>
        <span class="k">if</span> <span class="n">collection_name</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
            <span class="n">boxes_collection</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span>
            <span class="c1"># Clear existing objects</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">boxes_collection</span><span class="o">.</span><span class="n">objects</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">boxes_collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attached_group_prefix</span><span class="p">):</span>
                        <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">do_unlink</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create new collection</span>
            <span class="n">boxes_collection</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">collection_name</span><span class="p">)</span>

        <span class="c1"># Find the collection that contains this pallet (object.XXX structure)</span>
        <span class="n">pallet_parent_collection</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Look for collection containing this pallet</span>
        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pallet</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">objects</span><span class="p">]:</span>
                    <span class="c1"># Found collection containing the pallet</span>
                    <span class="n">pallet_parent_collection</span> <span class="o">=</span> <span class="n">collection</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c1"># If no specific collection found, use scene collection</span>
        <span class="k">if</span> <span class="n">pallet_parent_collection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pallet_parent_collection</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">collection</span>

        <span class="c1"># Link the boxes collection to the same parent collection as the pallet</span>
        <span class="k">if</span> <span class="n">boxes_collection</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pallet_parent_collection</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">pallet_parent_collection</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">boxes_collection</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">boxes_collection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_box_to_collection_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">boxes_collection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add box to collection - EXACT from original.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">box</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">boxes_collection</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Boîte ou collection invalid!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Remove from all other collections</span>
            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">users_collection</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                    <span class="n">collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

            <span class="c1"># Add to boxes collection</span>
            <span class="n">boxes_collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur ajout à collection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="WarehouseMode.generate_pallet_box_group">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.generate_pallet_box_group">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_pallet_box_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pallet</span><span class="p">,</span> <span class="n">box_templates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a group of boxes on a pallet - EXACT logic from original warehouse generator.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">box_templates</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Templates ou palette manquants pour </span><span class="si">{</span><span class="n">pallet</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Génération de box sur </span><span class="si">{</span><span class="n">pallet</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> avec </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">box_templates</span><span class="p">)</span><span class="si">}</span><span class="s2"> templates&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create collection for this pallet&#39;s boxes</span>
            <span class="n">boxes_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_boxes_collection_for_pallet</span><span class="p">(</span><span class="n">pallet</span><span class="p">)</span>

            <span class="c1"># Get pallet measurements in world and local space</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">world_corners</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">pallet</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">@</span> <span class="n">Vector</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pallet</span><span class="o">.</span><span class="n">bound_box</span>
                <span class="p">]</span>
                <span class="n">pallet_top_z</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">world_corners</span><span class="p">)</span>

                <span class="c1"># Local bounds for grid calculation</span>
                <span class="n">pxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pallet</span><span class="o">.</span><span class="n">bound_box</span><span class="p">]</span>
                <span class="n">pys</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pallet</span><span class="o">.</span><span class="n">bound_box</span><span class="p">]</span>
                <span class="n">pzs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pallet</span><span class="o">.</span><span class="n">bound_box</span><span class="p">]</span>
                <span class="n">pl_min_x</span><span class="p">,</span> <span class="n">pl_max_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pxs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">pxs</span><span class="p">)</span>
                <span class="n">pl_min_y</span><span class="p">,</span> <span class="n">pl_max_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">pys</span><span class="p">)</span>
                <span class="n">pl_top_z</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pzs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Fallback if bound_box fails</span>
                <span class="n">pallet_top_z</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pallet</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pallet</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">))</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pallet</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span>
                <span class="n">pl_min_x</span><span class="p">,</span> <span class="n">pl_max_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">pl_min_y</span><span class="p">,</span> <span class="n">pl_max_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">d</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">pl_top_z</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># Choose grid: 2 boxes (1x2 or 2x1) or 4 boxes (2x2) - EXACT original logic</span>
            <span class="n">top_w_local</span> <span class="o">=</span> <span class="n">pl_max_x</span> <span class="o">-</span> <span class="n">pl_min_x</span>
            <span class="n">top_d_local</span> <span class="o">=</span> <span class="n">pl_max_y</span> <span class="o">-</span> <span class="n">pl_min_y</span>

            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="c1"># 2 boxes</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">top_w_local</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">top_d_local</span><span class="p">):</span>
                    <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 4 boxes</span>
                <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>

            <span class="n">cell_width_local</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl_max_x</span> <span class="o">-</span> <span class="n">pl_min_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">grid_x</span>
            <span class="n">cell_depth_local</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl_max_y</span> <span class="o">-</span> <span class="n">pl_min_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">grid_y</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Grille: </span><span class="si">{</span><span class="n">grid_y</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">grid_x</span><span class="si">}</span><span class="s2"> sur palette </span><span class="si">{</span><span class="n">pallet</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">created_objects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">obj_index</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Place boxes in grid - EXACT original logic</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_y</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_x</span><span class="p">):</span>
                    <span class="c1"># Cell center in local coordinates -&gt; world coordinates</span>
                    <span class="n">local_cx</span> <span class="o">=</span> <span class="n">pl_min_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_width_local</span>
                    <span class="n">local_cy</span> <span class="o">=</span> <span class="n">pl_min_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">row</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_depth_local</span>
                    <span class="n">local_pos</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">((</span><span class="n">local_cx</span><span class="p">,</span> <span class="n">local_cy</span><span class="p">,</span> <span class="n">pl_top_z</span><span class="p">))</span>
                    <span class="n">world_pos</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">@</span> <span class="n">local_pos</span>

                    <span class="c1"># Create box from template</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">box_templates</span><span class="p">)</span>
                    <span class="n">box</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attached_group_prefix</span><span class="si">}</span><span class="s2">G0_</span><span class="si">{</span><span class="n">obj_index</span><span class="si">}</span><span class="s2">_L0_</span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="c1"># CRITICAL: Ensure template is visible for copying</span>
                    <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">hide_viewport</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;⚠️  Template </span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is hidden in viewport - making visible for copying&quot;</span>
                        <span class="p">)</span>
                        <span class="n">template</span><span class="o">.</span><span class="n">hide_viewport</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">hide_render</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;⚠️  Template </span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is hidden in render - making visible for copying&quot;</span>
                        <span class="p">)</span>
                        <span class="n">template</span><span class="o">.</span><span class="n">hide_render</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># Add to collection FIRST</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_box_to_collection</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">boxes_collection</span><span class="p">)</span>

                    <span class="c1"># Position in world coordinates - EXACT original logic</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">world_pos</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    Box </span><span class="si">{</span><span class="n">obj_index</span><span class="si">}</span><span class="s2">: template=</span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, local(</span><span class="si">{</span><span class="n">local_cx</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">local_cy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pl_top_z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">) -&gt; world(</span><span class="si">{</span><span class="n">world_pos</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">world_pos</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">world_pos</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Box </span><span class="si">{</span><span class="n">obj_index</span><span class="si">}</span><span class="s2">: final location = </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Scale to fill cell exactly - EXACT original logic</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dim_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                        <span class="n">dim_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

                        <span class="c1"># Test 0° vs 90° rotation (choose best fit)</span>
                        <span class="n">sx0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cell_width_local</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim_x</span>
                        <span class="n">sy0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cell_depth_local</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim_y</span>
                        <span class="n">sx90</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cell_width_local</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim_y</span>
                        <span class="n">sy90</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cell_depth_local</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim_x</span>

                        <span class="n">use_90</span> <span class="o">=</span> <span class="p">(</span><span class="n">sx90</span> <span class="o">*</span> <span class="n">sy90</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">sx0</span> <span class="o">*</span> <span class="n">sy0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">use_90</span><span class="p">:</span>
                            <span class="n">yaw</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">rotation_euler</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
                            <span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span> <span class="o">=</span> <span class="n">sx90</span><span class="p">,</span> <span class="n">sy90</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">yaw</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">rotation_euler</span><span class="o">.</span><span class="n">z</span>
                            <span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span> <span class="o">=</span> <span class="n">sx0</span><span class="p">,</span> <span class="n">sy0</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">yaw</span> <span class="o">=</span> <span class="n">pallet</span><span class="o">.</span><span class="n">rotation_euler</span><span class="o">.</span><span class="n">z</span>
                        <span class="n">scale_x</span> <span class="o">=</span> <span class="n">scale_y</span> <span class="o">=</span> <span class="mf">1.0</span>

                    <span class="c1"># Apply scaling (preserve Z scale)</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">((</span><span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">rotation_euler</span> <span class="o">=</span> <span class="n">Euler</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">yaw</span><span class="p">))</span>

                    <span class="c1"># Align bottom to pallet top using world coordinates - EXACT original logic</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_align_bottom_to_z</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pallet_top_z</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

                    <span class="c1"># CRITICAL: Parent to pallet while preserving world position - EXACT from original</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parent_preserve_world</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pallet</span><span class="p">)</span>

                    <span class="c1"># CRITICAL: Ensure visibility</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">hide_viewport</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">hide_render</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">hide_select</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># Force update</span>
                    <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                    <span class="n">created_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                    <span class="n">obj_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_objects</span><span class="p">)</span><span class="si">}</span><span class="s2"> box générées sur </span><span class="si">{</span><span class="n">pallet</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Debug: verify boxes are in scene</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">created_objects</span><span class="p">:</span>
                <span class="n">in_scene</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span>
                <span class="n">visible</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">box</span><span class="o">.</span><span class="n">hide_viewport</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">box</span><span class="o">.</span><span class="n">hide_render</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;    Debug box </span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: in_scene=</span><span class="si">{</span><span class="n">in_scene</span><span class="si">}</span><span class="s2">, visible=</span><span class="si">{</span><span class="n">visible</span><span class="si">}</span><span class="s2">, location=</span><span class="si">{</span><span class="n">box</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">created_objects</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur placement sur </span><span class="si">{</span><span class="n">pallet</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_create_boxes_collection_for_pallet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pallet</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create collection for pallet boxes - EXACT from original.&quot;&quot;&quot;</span>
        <span class="n">collection_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;boxes_group_</span><span class="si">{</span><span class="n">pallet</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Check if collection exists</span>
        <span class="k">if</span> <span class="n">collection_name</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
            <span class="n">boxes_collection</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span>
            <span class="c1"># Clear existing objects</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">boxes_collection</span><span class="o">.</span><span class="n">objects</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                    <span class="n">boxes_collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create new collection</span>
            <span class="n">boxes_collection</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">collection_name</span><span class="p">)</span>

        <span class="c1"># Find pallet&#39;s parent collection</span>
        <span class="n">pallet_parent_collection</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Check scene collection first</span>
        <span class="k">if</span> <span class="n">pallet</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="n">pallet_parent_collection</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">collection</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Search in all collections</span>
            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pallet</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
                        <span class="n">pallet_parent_collection</span> <span class="o">=</span> <span class="n">collection</span>
                        <span class="k">break</span>

        <span class="c1"># Use scene collection as fallback</span>
        <span class="k">if</span> <span class="n">pallet_parent_collection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pallet_parent_collection</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">collection</span>

        <span class="c1"># Link collection at same level as pallet</span>
        <span class="k">if</span> <span class="n">boxes_collection</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pallet_parent_collection</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">pallet_parent_collection</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">boxes_collection</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">boxes_collection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_box_to_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">boxes_collection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add box to collection - EXACT from original.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">box</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">boxes_collection</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Boîte ou collection invalid!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Remove from all other collections</span>
            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">users_collection</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                    <span class="n">collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

            <span class="c1"># Add to boxes collection</span>
            <span class="n">boxes_collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur ajout à collection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_align_bottom_to_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">target_z</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Align object bottom to target Z coordinate - EXACT from original with improved robustness.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="c1"># Get the actual bottom of the object in world space</span>
            <span class="n">bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object_bottom_z</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="c1"># Calculate the offset needed</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_z</span> <span class="o">+</span> <span class="n">margin</span><span class="p">)</span> <span class="o">-</span> <span class="n">bottom</span>

            <span class="c1"># Only adjust if there&#39;s a significant difference (avoid micro-adjustments)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">:</span>
                <span class="n">old_z</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">z</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">z</span> <span class="o">+=</span> <span class="n">dz</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;        Aligned </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: Z </span><span class="si">{</span><span class="n">old_z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (offset: </span><span class="si">{</span><span class="n">dz</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Erreur align_bottom_to_z for </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Fallback: simple positioning</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">target_z</span> <span class="o">+</span> <span class="n">margin</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_object_bottom_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the bottom Z coordinate of an object in world space - EXACT from original with better error handling.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="c1"># Transform all bounding box corners to world space</span>
            <span class="n">corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">@</span> <span class="n">Vector</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">bound_box</span><span class="p">]</span>
            <span class="n">bottom_z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">corners</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">bottom_z</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Error getting bottom Z for </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Fallback calculation</span>
                <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">scale</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">z</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parent_preserve_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child_obj</span><span class="p">,</span> <span class="n">parent_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parent child to parent while preserving world transform - EXACT from original with better error handling.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">child_obj</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">parent_obj</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Save current world transform</span>
            <span class="n">mat_w</span> <span class="o">=</span> <span class="n">child_obj</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Set parent</span>
            <span class="n">child_obj</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent_obj</span>

            <span class="c1"># Calculate and set parent inverse matrix to preserve world position</span>
            <span class="n">child_obj</span><span class="o">.</span><span class="n">matrix_parent_inverse</span> <span class="o">=</span> <span class="n">parent_obj</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span> <span class="o">@</span> <span class="n">mat_w</span>

            <span class="c1"># Ensure world transform is preserved</span>
            <span class="n">child_obj</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">=</span> <span class="n">mat_w</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;        Parented </span><span class="si">{</span><span class="n">child_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">parent_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, world pos preserved: </span><span class="si">{</span><span class="n">child_obj</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Error in parent_preserve_world for </span><span class="si">{</span><span class="n">child_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Fallback: simple parenting</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">child_obj</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent_obj</span>

<div class="viewcode-block" id="WarehouseMode.cleanup_generated_boxes">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.cleanup_generated_boxes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_generated_boxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up previously generated boxes.&quot;&quot;&quot;</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">obj</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attached_group_prefix</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">do_unlink</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="WarehouseMode.find_pallet_box_relationships">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.find_pallet_box_relationships">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_pallet_box_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene_objects</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find relationships between pallets and their boxes.&quot;&quot;&quot;</span>
        <span class="n">relationships</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pallet</span> <span class="ow">in</span> <span class="n">scene_objects</span><span class="p">[</span><span class="s2">&quot;pallets&quot;</span><span class="p">]:</span>
            <span class="n">boxes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">obj</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attached_group_prefix</span><span class="si">}{</span><span class="n">pallet</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">relationships</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;pallet&quot;</span><span class="p">:</span> <span class="n">pallet</span><span class="p">,</span> <span class="s2">&quot;boxes&quot;</span><span class="p">:</span> <span class="n">boxes</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">relationships</span></div>


<div class="viewcode-block" id="WarehouseMode.get_visible_pallets">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.get_visible_pallets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_visible_pallets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene_objects</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get pallets that are visible in the current camera view.&quot;&quot;&quot;</span>
        <span class="n">visible_pallets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">pallet</span> <span class="ow">in</span> <span class="n">scene_objects</span><span class="p">[</span><span class="s2">&quot;pallets&quot;</span><span class="p">]:</span>
            <span class="n">bbox_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bbox_2d_accurate</span><span class="p">(</span><span class="n">pallet</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bbox_2d</span> <span class="ow">and</span> <span class="n">bbox_2d</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_pallet_area&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
                <span class="n">pallet_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;pallet&quot;</span><span class="p">:</span> <span class="n">pallet</span><span class="p">,</span>
                    <span class="s2">&quot;bbox_2d&quot;</span><span class="p">:</span> <span class="n">bbox_2d</span><span class="p">,</span>
                    <span class="s2">&quot;bbox_3d&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_3d_oriented</span><span class="p">(</span><span class="n">pallet</span><span class="p">),</span>
                    <span class="s2">&quot;generated_boxes&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">obj</span>
                        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span>
                        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attached_group_prefix</span><span class="si">}{</span><span class="n">pallet</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_&quot;</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                <span class="p">}</span>
                <span class="n">visible_pallets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pallet_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">visible_pallets</span></div>


<div class="viewcode-block" id="WarehouseMode.randomize_lighting">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.randomize_lighting">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">randomize_lighting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up dynamic warehouse lighting.&quot;&quot;&quot;</span>
        <span class="c1"># Remove existing synthetic lights</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">o</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;LIGHT&quot;</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SynthLight_&quot;</span><span class="p">)</span>
        <span class="p">]:</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">do_unlink</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create warehouse-appropriate lighting</span>
        <span class="n">light_count</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;light_count_range&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
        <span class="n">energy_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;light_energy_ranges&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">light_count</span><span class="p">):</span>
            <span class="n">light_type</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&quot;AREA&quot;</span><span class="p">,</span> <span class="s2">&quot;SPOT&quot;</span><span class="p">,</span> <span class="s2">&quot;POINT&quot;</span><span class="p">])</span>
            <span class="n">light_data</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">lights</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SynthLightData_</span><span class="si">{</span><span class="n">light_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">light_type</span>
            <span class="p">)</span>
            <span class="n">light_obj</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SynthLight_</span><span class="si">{</span><span class="n">light_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">light_data</span><span class="p">)</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">light_obj</span><span class="p">)</span>

            <span class="c1"># Set light properties</span>
            <span class="n">energy_range</span> <span class="o">=</span> <span class="n">energy_ranges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">light_type</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
            <span class="n">light_data</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">energy_range</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">light_type</span> <span class="o">==</span> <span class="s2">&quot;AREA&quot;</span><span class="p">:</span>
                <span class="n">light_data</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">light_type</span> <span class="o">==</span> <span class="s2">&quot;SPOT&quot;</span><span class="p">:</span>
                <span class="n">light_data</span><span class="o">.</span><span class="n">spot_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>

            <span class="c1"># Position light (warehouse ceiling height)</span>
            <span class="n">light_obj</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Point downward</span>
            <span class="n">light_obj</span><span class="o">.</span><span class="n">rotation_euler</span> <span class="o">=</span> <span class="n">Euler</span><span class="p">((</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">180</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="c1"># Optional colored lighting</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;use_colored_lights&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;colored_light_probability&quot;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">):</span>
                <span class="n">light_data</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="WarehouseMode.save_warehouse_frame_outputs">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.save_warehouse_frame_outputs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_warehouse_frame_outputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frame_id</span><span class="p">,</span>
        <span class="n">img_filename</span><span class="p">,</span>
        <span class="n">img_path</span><span class="p">,</span>
        <span class="n">visible_pallets</span><span class="p">,</span>
        <span class="n">cam_obj</span><span class="p">,</span>
        <span class="n">sc</span><span class="p">,</span>
        <span class="n">coco_data</span><span class="p">,</span>
        <span class="n">meta</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save all outputs for a warehouse frame.&quot;&quot;&quot;</span>
        <span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;resolution_x&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;resolution_y&quot;</span><span class="p">]</span>

        <span class="c1"># COCO image entry</span>
        <span class="n">coco_image</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">frame_id</span><span class="p">,</span>
            <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">img_filename</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">img_w</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">img_h</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">coco_data</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coco_image</span><span class="p">)</span>

        <span class="c1"># Write annotations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_warehouse_annotations</span><span class="p">(</span>
            <span class="n">visible_pallets</span><span class="p">,</span> <span class="n">coco_data</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span>
        <span class="p">)</span>

        <span class="c1"># Generate analysis image using comprehensive analysis from base class</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generate_analysis&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>  <span class="c1"># Default to True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Convert visible_pallets format to match what create_analysis_image_multi expects</span>
                <span class="n">b2d_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">visible_pallets</span><span class="p">]</span>
                <span class="n">b3d_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;bbox_3d&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">visible_pallets</span><span class="p">]</span>
                <span class="n">pockets_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hole_bboxes&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">visible_pallets</span><span class="p">]</span>

                <span class="n">ana_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;analysis_</span><span class="si">{</span><span class="n">img_filename</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_analysis_image_multi</span><span class="p">(</span>
                    <span class="n">img_path</span><span class="p">,</span>
                    <span class="n">b2d_list</span><span class="p">,</span>
                    <span class="n">b3d_list</span><span class="p">,</span>
                    <span class="n">pockets_list</span><span class="p">,</span>
                    <span class="n">cam_obj</span><span class="p">,</span>
                    <span class="n">sc</span><span class="p">,</span>
                    <span class="n">ana_path</span><span class="p">,</span>
                    <span class="n">frame_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 Warehouse analysis image saved: </span><span class="si">{</span><span class="n">ana_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Failed to create analysis image for frame </span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ⚠️ Analysis generation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Metadata</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;frame&quot;</span><span class="p">:</span> <span class="n">frame_id</span><span class="p">,</span>
                <span class="s2">&quot;image_id&quot;</span><span class="p">:</span> <span class="n">img_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span>  <span class="c1"># Remove .png</span>
                <span class="s2">&quot;rgb&quot;</span><span class="p">:</span> <span class="n">img_path</span><span class="p">,</span>
                <span class="s2">&quot;visible_pallets&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">visible_pallets</span><span class="p">),</span>
                <span class="s2">&quot;camera&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">cam_obj</span><span class="o">.</span><span class="n">location</span><span class="p">),</span>
                    <span class="s2">&quot;rotation&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">cam_obj</span><span class="o">.</span><span class="n">rotation_euler</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="WarehouseMode.write_warehouse_annotations">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.write_warehouse_annotations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_warehouse_annotations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">visible_pallets</span><span class="p">,</span> <span class="n">coco_data</span><span class="p">,</span> <span class="n">img_id</span><span class="p">,</span> <span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write COCO and YOLO annotations for warehouse scene.&quot;&quot;&quot;</span>
        <span class="n">yolo_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">pallet_info</span> <span class="ow">in</span> <span class="n">visible_pallets</span><span class="p">:</span>
            <span class="c1"># Pallet annotation</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">pallet_info</span><span class="p">[</span><span class="s2">&quot;bbox_2d&quot;</span><span class="p">]</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">coco_data</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;image_id&quot;</span><span class="p">:</span> <span class="n">img_id</span><span class="p">,</span>
                <span class="s2">&quot;category_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Pallet</span>
                <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]],</span>
                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">],</span>
                <span class="s2">&quot;iscrowd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;segmentation&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>
            <span class="n">coco_data</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

            <span class="c1"># YOLO format</span>
            <span class="n">x_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">img_w</span>
            <span class="n">y_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">img_h</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">img_w</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">img_h</span>
            <span class="n">yolo_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;0 </span><span class="si">{</span><span class="n">x_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Generated boxes on pallet</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">pallet_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generated_boxes&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">box_bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bbox_2d_accurate</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">cam_obj</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">box_bbox</span> <span class="ow">and</span> <span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="n">box_annotation</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">coco_data</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;image_id&quot;</span><span class="p">:</span> <span class="n">img_id</span><span class="p">,</span>
                        <span class="s2">&quot;category_id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Box</span>
                        <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">],</span>
                            <span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">],</span>
                            <span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span>
                            <span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">],</span>
                        <span class="p">],</span>
                        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;iscrowd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;segmentation&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="p">}</span>
                    <span class="n">coco_data</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_annotation</span><span class="p">)</span>

                    <span class="c1"># YOLO format for box</span>
                    <span class="n">x_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">img_w</span>
                    <span class="n">y_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">img_h</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">img_w</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">box_bbox</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">img_h</span>
                    <span class="n">yolo_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;2 </span><span class="si">{</span><span class="n">x_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y_center</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># Write YOLO file</span>
        <span class="n">yolo_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;yolo&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">img_id</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yolo_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">yolo_lines</span><span class="p">))</span></div>


<div class="viewcode-block" id="WarehouseMode.restore_scene_objects">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.restore_scene_objects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">restore_scene_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">removed_objects</span><span class="p">,</span> <span class="n">original_positions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore scene objects to original state.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">removed_objects</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">hide_viewport</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">hide_render</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Restore original positions</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">original_positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;matrix_world&quot;</span><span class="p">):</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">=</span> <span class="n">matrix</span></div>


<div class="viewcode-block" id="WarehouseMode.save_generated_scene">
<a class="viewcode-back" href="../../../api/palletdatagenerator.modes.warehouse.html#palletdatagenerator.modes.warehouse.WarehouseMode.save_generated_scene">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_generated_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current generated scene to a .blend file in the scenes folder.</span>
<span class="sd">        This allows inspection and reuse of the randomized warehouse layout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

        <span class="c1"># Create scenes folder if it doesn&#39;t exist</span>
        <span class="n">scenes_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;scenes&quot;</span><span class="p">)</span>
        <span class="n">scenes_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Generate scene filename with batch info</span>
        <span class="n">batch_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown_batch&quot;</span><span class="p">))</span>

        <span class="c1"># Create a subfolder inside scenes for better organization</span>
        <span class="n">scenes_warehouse_folder</span> <span class="o">=</span> <span class="n">scenes_folder</span> <span class="o">/</span> <span class="s2">&quot;warehouse_generated&quot;</span>
        <span class="n">scenes_warehouse_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">scene_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;warehouse_generated_scene_</span><span class="si">{</span><span class="n">scene_id</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">batch_name</span><span class="si">}</span><span class="s2">.blend&quot;</span>
        <span class="n">scene_path</span> <span class="o">=</span> <span class="n">scenes_warehouse_folder</span> <span class="o">/</span> <span class="n">scene_filename</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💾 Saving generated scene to: </span><span class="si">{</span><span class="n">scene_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">save_as_mainfile</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">scene_path</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Scene saved successfully: </span><span class="si">{</span><span class="n">scene_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="c1"># Also save scene info as JSON for reference</span>
            <span class="n">scene_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;scene_id&quot;</span><span class="p">:</span> <span class="n">scene_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;batch_folder&quot;</span><span class="p">:</span> <span class="n">batch_name</span><span class="p">,</span>
                <span class="s2">&quot;config_used&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;num_scenes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_scenes&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;max_images_per_scene&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;max_images_per_scene&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;box_removal_probability&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;box_removal_probability&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;pallet_groups_to_fill&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;pallet_groups_to_fill&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span>
                    <span class="p">),</span>
                <span class="p">},</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
            <span class="p">}</span>

            <span class="n">info_path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">scenes_warehouse_folder</span>
                <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;warehouse_scene_</span><span class="si">{</span><span class="n">scene_id</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">batch_name</span><span class="si">}</span><span class="s2">_info.json&quot;</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">info_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">scene_info</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  Failed to save generated scene: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Ibrahim Boubakri.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>